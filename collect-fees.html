<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Collection - The Lalit Intl.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        .portal-container {
            max-width: 850px; margin: 40px auto; background: #fff;
            border: 2px solid var(--gold); border-radius: 20px; padding: 40px;
            box-shadow: var(--shadow-lg);
        }
        .portal-title {
            font-family: 'Cinzel', serif; color: var(--royal-blue);
            text-align: center; margin-bottom: 30px; display: flex;
            align-items: center; justify-content: center; gap: 15px;
        }
        .search-inner-box {
            background: #fdfbf0; border: 1px dashed var(--gold);
            padding: 30px; border-radius: 15px; margin-bottom: 20px;
        }
        .custom-search-input {
            border: 1px solid #ddd !important; border-radius: 10px !important;
            padding: 15px !important; font-size: 1.1rem !important;
        }
        .btn-search-black {
            background: #1a1a1a !important; color: #fff !important;
            width: 100%; padding: 12px; border-radius: 10px;
            font-weight: bold; border: none; margin-top: 15px;
        }
        #searchSuggestions { 
            background: white; border: 1px solid var(--gold); position: absolute; 
            width: calc(100% - 60px); z-index: 1000; max-height: 200px; 
            overflow-y: auto; display: none; border-radius: 10px;
        }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .suggestion-item:hover { background: var(--light-gold); }
        
        #feeDetailsForm { display: none; transition: var(--transition); }
        .due-badge-portal {
            background: #fff5f5; color: #c0392b; border: 2px solid #c0392b;
            padding: 10px; border-radius: 10px; font-weight: bold; font-size: 1.5rem;
        }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="main-content">
    <div class="header no-print">
        <h1 class="brand-font">The Lalit International School</h1>
        <p style="color: var(--gold); letter-spacing: 2px;">Nurturing Global Citizens</p>
    </div>

    <div class="portal-container no-print">
        <h2 class="portal-title"><i class="fas fa-receipt"></i> Fee Collection Portal</h2>

        <div class="search-inner-box position-relative">
            <div class="row g-2">
                <div class="col-md-8">
                    <label class="fw-bold small mb-1">STUDENT ID OR NAME</label>
                    <input type="text" id="studentSearch" class="form-control custom-search-input" placeholder="Ex: 2024001 or Rajesh" oninput="liveSearch()" autocomplete="off">
                    <div id="searchSuggestions"></div>
                </div>
                <div class="col-md-4">
                    <label class="fw-bold small mb-1">CALCULATE UP TO</label>
                    <select id="calcMonth" class="form-select custom-search-input" onchange="if(activeStudent) calculateDue(activeStudent)">
                        <option value="April">April</option><option value="May">May</option><option value="June">June</option>
                        <option value="July">July</option><option value="August">August</option><option value="September">September</option>
                        <option value="October">October</option><option value="November">November</option><option value="December">December</option>
                        <option value="January">January</option><option value="February">February</option><option value="March">March</option>
                    </select>
                </div>
            </div>
            <button class="btn-search-black" onclick="document.getElementById('studentSearch').focus()">
                <i class="fas fa-search"></i> Find Record
            </button>
        </div>

        <div id="feeDetailsForm">
            <div class="row g-4 align-items-center">
                <div class="col-md-6 text-center border-end">
                    <p class="text-muted small mb-0">SELECTED STUDENT</p>
                    <h4 id="displayName" class="fw-bold text-primary">---</h4>
                    <p id="displayId" class="small text-muted">ID: ---</p>
                </div>
                <div class="col-md-6 text-center">
                    <p class="text-muted small mb-1">OUTSTANDING BALANCE</p>
                    <div id="dueAmount" class="due-badge-portal">₹ 0.00</div>
                </div>

                <div class="col-12"><hr></div>

                <div class="col-md-4">
                    <label class="fw-bold small">AMOUNT TO PAY</label>
                    <input type="number" id="payAmt" class="form-control form-control-lg border-gold" placeholder="0.00">
                </div>
                <div class="col-md-4">
                    <label class="fw-bold small">FOR MONTH</label>
                    <select id="payMonth" class="form-select form-select-lg border-gold">
                        <option>April</option><option>May</option><option>June</option>
                        <option>July</option><option>August</option><option>September</option>
                        <option>October</option><option>November</option><option>December</option>
                        <option>January</option><option>February</option><option>March</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="fw-bold small">PAYMENT MODE</label>
                    <select id="payMode" class="form-select form-select-lg border-gold">
                        <option>Cash</option><option>Online</option><option>Cheque</option>
                    </select>
                </div>
                <div class="col-12">
                    <button class="royal-btn w-100 btn-lg" id="submitBtn" onclick="submitPayment()">
                        CONFIRM PAYMENT & GENERATE RECEIPT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="receiptArea"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
let activeStudent = null;
let currentBalance = 0;
const database = firebase.firestore();

// 1. Search by Name OR ID
async function liveSearch() {
    const val = document.getElementById('studentSearch').value.toLowerCase();
    const sugg = document.getElementById('searchSuggestions');
    if(val.length < 2) { sugg.style.display='none'; return; }

    try {
        const snap = await database.collection('students').get();
        let html = '';
        snap.forEach(doc => {
            const d = doc.data();
            const name = d.name.toLowerCase();
            const id = String(d.uniqueID).toLowerCase();
            
            if(name.includes(val) || id.includes(val)) {
                const sData = encodeURIComponent(JSON.stringify(d));
                html += `<div class="suggestion-item" onclick="selectStudent('${sData}')">
                            <b>${d.name}</b> <small class="text-muted">(ID: ${d.uniqueID})</small><br>
                            <small>Class: ${d.class} | Father: ${d.father}</small>
                         </div>`;
            }
        });
        sugg.innerHTML = html;
        sugg.style.display = html ? 'block' : 'none';
    } catch (e) { console.error(e); }
}

// 2. Select and Calculate
async function selectStudent(encodedData) {
    activeStudent = JSON.parse(decodeURIComponent(encodedData));
    document.getElementById('studentSearch').value = activeStudent.name;
    document.getElementById('displayName').innerText = activeStudent.name;
    document.getElementById('displayId').innerText = "Admission ID: " + activeStudent.uniqueID;
    document.getElementById('searchSuggestions').style.display = 'none';
    document.getElementById('feeDetailsForm').style.display = 'block';
    
    calculateDue(activeStudent);
}

// 3. Ledger Based Calculation
async function calculateDue(student) {
    document.getElementById('dueAmount').innerText = "Calculating...";
    const targetMonth = document.getElementById('calcMonth').value;
    const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];
    const targetIdx = months.indexOf(targetMonth);

    try {
        const mDoc = await database.collection('fee_master').doc(student.class).get();
        const tSnap = await database.collection('fee_transactions').where('studentID', '==', String(student.uniqueID)).get();
        
        let totalPaid = 0;
        tSnap.forEach(d => totalPaid += Number(d.data().amount));

        if(mDoc.exists) {
            const fm = mDoc.data();
            const monthly = Number(fm.tuition || 0) + 
                           (student.hostel === 'Yes' ? Number(fm.hostel || 0) : 0) + 
                           (student.transport === 'Yes' ? Number(fm.transport || 0) : 0);
            
            const annual = Number(fm.admission || 0) + Number(fm.development || 0) + Number(fm.exam || 0);
            
            const expected = annual + (monthly * (targetIdx + 1));
            currentBalance = expected - totalPaid;
            document.getElementById('dueAmount').innerText = `₹ ${currentBalance.toFixed(2)}`;
        } else {
            document.getElementById('dueAmount').innerText = "₹ Structure Missing";
        }
    } catch (e) { console.error(e); }
}

// 4. Final Submission Logic
async function submitPayment() {
    if(!activeStudent) return;
    const amt = document.getElementById('payAmt').value;
    if(!amt || amt <= 0) return alert("Enter valid amount");

    // Yahan submitPayment ka baki logic (firebase add) aayega jo pehle diya tha
    alert("Payment successful for " + activeStudent.name);
}
</script>
</body>
</html>
