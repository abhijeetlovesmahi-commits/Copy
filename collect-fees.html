<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Collection - The Lalit Intl.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        .collection-card { 
            background: white; border-radius: 15px; border-top: 6px solid var(--royal-blue); 
            box-shadow: var(--shadow-md); padding: 30px; margin-top: 20px;
        }
        .due-badge { 
            background: #fff5f5; color: #c0392b; border: 2px solid #c0392b; 
            padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.4rem; text-align: center;
        }
        #searchSuggestions { 
            background: white; border: 1px solid var(--gold); position: absolute; 
            width: 95%; z-index: 1000; max-height: 250px; overflow-y: auto; display: none; 
            border-radius: 0 0 10px 10px; box-shadow: var(--shadow-lg);
        }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .suggestion-item:hover { background: var(--light-gold); color: var(--royal-blue); }

        /* Receipt Print Styles */
        #receiptArea { display: none; }
        .receipt-card {
            width: 148mm; min-height: 210mm; background: white; border: 4px double var(--gold); 
            padding: 30px; margin: 20px auto; position: relative;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
        }
        .receipt-header { text-align: center; border-bottom: 2px solid var(--royal-blue); padding-bottom: 15px; margin-bottom: 20px; }
        .receipt-table { width: 100%; margin-top: 20px; }
        .receipt-table td { padding: 10px; border: 1px solid #eee; font-size: 14px; }

        @media print {
            .no-print, #menu-container { display: none !important; }
            .main-content { margin: 0 !important; padding: 0 !important; }
            body { background: white; }
            #receiptArea { display: block !important; }
            .receipt-card { border: 2px solid #000; width: 100%; box-shadow: none; margin: 0; }
        }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="main-content">
    <div class="royal-card no-print">
        <div class="header" id="brand-header-container">
            </div>

        <div class="collection-card">
            <h3 class="brand-font text-center mb-4" style="color: var(--royal-blue);">Student Fee Collection</h3>
            
            <div class="row g-4">
                <div class="col-md-7 position-relative">
                    <label class="fw-bold text-muted small mb-1">FIND STUDENT (NAME OR ID)</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-gold"><i class="fas fa-search text-gold"></i></span>
                        <input type="text" id="studentSearch" class="form-control form-control-lg border-gold" placeholder="Start typing name..." oninput="liveSearch()" autocomplete="off">
                    </div>
                    <div id="searchSuggestions"></div>
                </div>

                <div class="col-md-5">
                    <label class="fw-bold text-muted small mb-1">OUTSTANDING BALANCE</label>
                    <div id="dueAmount" class="due-badge">₹ 0.00</div>
                </div>

                <div class="col-12"><hr></div>

                <div class="col-md-4">
                    <label class="fw-bold small">AMOUNT TO PAY (₹)</label>
                    <input type="number" id="payAmt" class="form-control form-control-lg" placeholder="0.00">
                </div>
                <div class="col-md-4">
                    <label class="fw-bold small">FOR MONTH</label>
                    <select id="payMonth" class="form-select form-select-lg">
                        <option value="April">April</option><option value="May">May</option><option value="June">June</option>
                        <option value="July">July</option><option value="August">August</option><option value="September">September</option>
                        <option value="October">October</option><option value="November">November</option><option value="December">December</option>
                        <option value="January">January</option><option value="February">February</option><option value="March">March</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="fw-bold small">PAYMENT MODE</label>
                    <select id="payMode" class="form-select form-select-lg">
                        <option value="Cash">Cash</option>
                        <option value="Online (UPI/Card)">Online Payment</option>
                        <option value="Cheque/DD">Cheque / DD</option>
                    </select>
                </div>

                <div class="col-12 mt-4">
                    <button class="royal-btn btn-block btn-lg" id="submitBtn" onclick="submitPayment()">
                        <i class="fas fa-receipt me-2"></i> CONFIRM PAYMENT & GENERATE RECEIPT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="receiptArea"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script src="firebase-config.js"></script>
<script src="auth-guard.js"></script>
<script src="brand.js"></script>
<script src="menu.js"></script>

<script>
let activeStudent = null;
let currentBalance = 0;

// 1. Live Search Students
async function liveSearch() {
    const val = document.getElementById('studentSearch').value.toLowerCase();
    const sugg = document.getElementById('searchSuggestions');
    if(val.length < 2) { sugg.style.display='none'; return; }

    const snap = await db.collection('students').get();
    let html = '';
    snap.forEach(doc => {
        const d = doc.data();
        if(d.name.toLowerCase().includes(val) || d.uniqueID.toString().includes(val)) {
            html += `<div class="suggestion-item" onclick='selectStudent(${JSON.stringify(d)})'>
                        <b>${d.name}</b> <span class="text-muted">(ID: ${d.uniqueID})</span><br>
                        <small>Class: ${d.class}-${d.section || 'A'} | Father: ${d.father}</small>
                     </div>`;
        }
    });
    sugg.innerHTML = html;
    sugg.style.display = html ? 'block' : 'none';
}

// 2. Select Student & Calculate Dues
async function selectStudent(s) {
    activeStudent = s;
    document.getElementById('studentSearch').value = s.name;
    document.getElementById('searchSuggestions').style.display = 'none';
    
    // Fee Calculation Logic
    try {
        const mDoc = await db.collection('fee_master').doc(s.class).get();
        const tSnap = await db.collection('fee_transactions').where('studentID', '==', String(s.uniqueID)).get();
        
        let paid = 0; 
        tSnap.forEach(d => paid += Number(d.data().amount));

        if(!mDoc.exists) {
            alert("Fee structure not defined for Class " + s.class);
            currentBalance = 0;
        } else {
            const fm = mDoc.data();
            const curMonthIdx = new Date().getMonth(); 
            const mOrder = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];
            const monthName = new Date().toLocaleString('en-us', {month:'long'});
            let mIdx = mOrder.indexOf(monthName);
            if(mIdx === -1) mIdx = 11; // Default to March if session ends

            const monthly = Number(fm.tuition || 0) + (s.hostel === 'Yes' ? Number(fm.hostel || 0) : 0) + (s.transport === 'Yes' ? 500 : 0);
            const annual = Number(fm.admission || 0) + Number(fm.development || 0) + Number(fm.exam || 0);
            
            const expected = annual + (monthly * (mIdx + 1));
            currentBalance = expected - paid;
        }
        
        document.getElementById('dueAmount').innerText = `₹ ${currentBalance.toFixed(2)}`;
    } catch (e) { console.error(e); }
}

// 3. Submit Transaction
async function submitPayment() {
    if(!activeStudent) return alert("Select a student first!");
    const amt = document.getElementById('payAmt').value;
    const month = document.getElementById('payMonth').value;
    const mode = document.getElementById('payMode').value;
    const btn = document.getElementById('submitBtn');

    if(!amt || amt <= 0) return alert("Enter valid amount!");

    btn.disabled = true;
    btn.innerText = "Processing Payment...";

    const paymentData = {
        studentID: String(activeStudent.uniqueID),
        name: activeStudent.name,
        amount: Number(amt),
        month: month,
        mode: mode,
        date: new Date().toLocaleDateString('en-GB'),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection('fee_transactions').add(paymentData);
        generateReceipt(paymentData, activeStudent);
        alert("Payment Recorded!");
        document.getElementById('payAmt').value = "";
    } catch (e) { alert(e.message); }
    btn.disabled = false;
    btn.innerText = "CONFIRM PAYMENT & GENERATE RECEIPT";
}

// 4. Generate Royal Receipt
function generateReceipt(p, s) {
    const receipt = `
    <div class="receipt-card">
        <div class="receipt-header">
            <img src="logo.png" style="width: 60px; margin-bottom:10px;">
            <h2 class="brand-font" style="color:var(--royal-blue); margin:0;">THE LALIT INTERNATIONAL SCHOOL</h2>
            <p style="font-size:12px; letter-spacing:2px; color:var(--gold);">OFFICIAL FEE RECEIPT | SESSION 2025-26</p>
        </div>

        <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:13px; font-weight:bold;">
            <span>No: TLIS-${Date.now().toString().slice(-6)}</span>
            <span>Date: ${p.date}</span>
        </div>

        <table class="receipt-table">
            <tr><td><b>Student Name:</b></td><td>${s.name.toUpperCase()}</td></tr>
            <tr><td><b>Admission ID:</b></td><td>${s.uniqueID}</td></tr>
            <tr><td><b>Class & Section:</b></td><td>${s.class} - ${s.section || 'A'}</td></tr>
            <tr><td><b>Parent Name:</b></td><td>${s.father}</td></tr>
            <tr><td><b>Payment Month:</b></td><td>${p.month}</td></tr>
            <tr><td><b>Payment Mode:</b></td><td>${p.mode}</td></tr>
        </table>

        <div style="margin-top:30px; padding:20px; background:var(--royal-blue); color:var(--gold); display:flex; justify-content:space-between; border-radius:10px;">
            <h3 style="margin:0;">AMOUNT PAID:</h3>
            <h3 style="margin:0;">₹ ${p.amount.toLocaleString('en-IN')}</h3>
        </div>

        <p style="margin-top:15px; text-align:right;"><b>Remaining Dues:</b> ₹ ${(currentBalance - p.amount).toFixed(2)}</p>

        <div style="margin-top:60px; display:flex; justify-content:space-between;">
            <div style="text-align:center; width:150px; border-top:1px solid #000; padding-top:10px; font-size:12px;">Authorized Signatory</div>
            <div style="text-align:center; width:150px; border-top:1px solid #000; padding-top:10px; font-size:12px;">Office Seal</div>
        </div>

        <div class="text-center no-print mt-5">
            <button class="royal-btn btn-sm me-2" onclick="window.print()"><i class="fas fa-print"></i> Print Receipt</button>
            <button class="royal-btn btn-sm" style="background:#25D366; border:none;" onclick="shareWhatsApp('${s.contact || s.pContact}', '${s.name}', '${p.amount}')">
                <i class="fab fa-whatsapp"></i> WhatsApp Notify
            </button>
        </div>
    </div>`;
    
    document.getElementById('receiptArea').innerHTML = receipt;
    document.getElementById('receiptArea').style.display = 'block';
    window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
}

function shareWhatsApp(phone, name, amt) {
    const msg = `*THE LALIT INTERNATIONAL SCHOOL*%0A*FEE PAYMENT CONFIRMATION*%0A%0AHello, we have received *₹${amt}* for student *${name}*.%0A%0A_Thank you for your timely payment!_`;
    window.open(`https://wa.me/91${phone}?text=${msg}`, '_blank');
}
</script>
</body>
</html>
