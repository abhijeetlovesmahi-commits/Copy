<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Collection - The Lalit Intl.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        .collection-card { 
            background: white; border-radius: 15px; border-top: 6px solid var(--royal-blue); 
            box-shadow: var(--shadow-md); padding: 30px; margin-top: 20px;
        }
        .due-badge { 
            background: #fff5f5; color: #c0392b; border: 2px solid #c0392b; 
            padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.4rem; text-align: center;
        }
        #searchSuggestions { 
            background: white; border: 1px solid var(--gold); position: absolute; 
            width: 95%; z-index: 1000; max-height: 250px; overflow-y: auto; display: none; 
            border-radius: 0 0 10px 10px; box-shadow: var(--shadow-lg);
        }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .suggestion-item:hover { background: var(--light-gold); color: var(--royal-blue); }

        /* Receipt Print Styles */
        #receiptArea { display: none; margin-top: 30px; }
        .receipt-card {
            width: 148mm; min-height: 200mm; background: white; border: 4px double var(--gold); 
            padding: 30px; margin: 20px auto; position: relative;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
        }
        .receipt-header { text-align: center; border-bottom: 2px solid var(--royal-blue); padding-bottom: 15px; margin-bottom: 20px; }
        .receipt-table { width: 100%; margin-top: 20px; }
        .receipt-table td { padding: 8px; border: 1px solid #f0f0f0; font-size: 14px; }

        @media print {
            .no-print, #menu-container, .navbar, .btn-sm { display: none !important; }
            .main-content { margin: 0 !important; padding: 0 !important; }
            body { background: white; }
            #receiptArea { display: block !important; }
            .receipt-card { border: 2px solid #000; width: 100%; box-shadow: none; margin: 0; padding: 10px; }
        }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="main-content">
    <div class="royal-card no-print">
        <div class="header" id="brand-header-container">
            <h1 class="brand-font">The Lalit International School</h1>
            <p style="color: var(--gold); letter-spacing: 3px;">FEE MANAGEMENT SYSTEM</p>
        </div>

        <div class="collection-card">
            <h3 class="brand-font text-center mb-4" style="color: var(--royal-blue);">Collect Student Fee</h3>
            
            <div class="row g-4">
                <div class="col-md-7 position-relative">
                    <label class="fw-bold text-muted small mb-1">SEARCH STUDENT (NAME/ID)</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-gold"><i class="fas fa-search text-gold"></i></span>
                        <input type="text" id="studentSearch" class="form-control form-control-lg border-gold" placeholder="Enter Name or uniqueID..." oninput="liveSearch()" autocomplete="off">
                    </div>
                    <div id="searchSuggestions"></div>
                </div>

                <div class="col-md-5">
                    <label class="fw-bold text-muted small mb-1">CURRENT OUTSTANDING</label>
                    <div id="dueAmount" class="due-badge">₹ 0.00</div>
                </div>

                <div class="col-12"><hr></div>

                <div class="col-md-4">
                    <label class="fw-bold small">AMOUNT TO COLLECT (₹)</label>
                    <input type="number" id="payAmt" class="form-control form-control-lg" placeholder="Enter amount">
                </div>
                <div class="col-md-4">
                    <label class="fw-bold small">FEE MONTH</label>
                    <select id="payMonth" class="form-select form-select-lg">
                        <option value="April">April</option><option value="May">May</option><option value="June">June</option>
                        <option value="July">July</option><option value="August">August</option><option value="September">September</option>
                        <option value="October">October</option><option value="November">November</option><option value="December">December</option>
                        <option value="January">January</option><option value="February">February</option><option value="March">March</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="fw-bold small">PAYMENT METHOD</label>
                    <select id="payMode" class="form-select form-select-lg">
                        <option value="Cash">Cash</option>
                        <option value="Online (UPI/Card)">Online Payment</option>
                        <option value="Cheque/DD">Cheque / DD</option>
                    </select>
                </div>

                <div class="col-12 mt-4">
                    <button class="royal-btn btn-block btn-lg" id="submitBtn" onclick="submitPayment()">
                        <i class="fas fa-check-circle me-2"></i> CONFIRM & PRINT RECEIPT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="receiptArea"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script src="firebase-config.js"></script>
<script src="brand.js"></script>
<script src="menu.js"></script>

<script>
let activeStudent = null;
let currentBalance = 0;

const database = firebase.firestore();

// 1. Live Search Optimized
async function liveSearch() {
    const val = document.getElementById('studentSearch').value;
    const sugg = document.getElementById('searchSuggestions');
    if(val.length < 2) { sugg.style.display='none'; return; }

    try {
        // Range query is better for performance than fetching all
        const snap = await database.collection('students')
            .where('name', '>=', val)
            .where('name', '<=', val + '\uf8ff')
            .limit(5)
            .get();

        let html = '';
        if(snap.empty) {
            html = '<div class="suggestion-item">No student found</div>';
        } else {
            snap.forEach(doc => {
                const d = doc.data();
                const sData = encodeURIComponent(JSON.stringify(d));
                html += `
                <div class="suggestion-item" onclick="selectStudent('${sData}')">
                    <i class="fas fa-user-grad me-2 text-gold"></i>
                    <b>${d.name}</b> <small class="text-muted">(ID: ${d.uniqueID})</small>
                    <div class="ms-4 small text-muted">Class: ${d.class} | Father: ${d.father}</div>
                </div>`;
            });
        }
        sugg.innerHTML = html;
        sugg.style.display = 'block';
    } catch (err) { console.error(err); }
}

// 2. Select Student & Calculate Dues
async function selectStudent(encodedData) {
    activeStudent = JSON.parse(decodeURIComponent(encodedData));
    document.getElementById('studentSearch').value = activeStudent.name;
    document.getElementById('searchSuggestions').style.display = 'none';
    
    document.getElementById('dueAmount').innerText = "Calculating...";

    try {
        // Get Fee Structure
        const mDoc = await database.collection('fee_master').doc(activeStudent.class).get();
        // Get Paid Transactions
        const tSnap = await database.collection('fee_transactions')
                             .where('studentID', '==', String(activeStudent.uniqueID))
                             .get();
        
        let totalPaid = 0; 
        tSnap.forEach(d => totalPaid += Number(d.data().amount));

        if(!mDoc.exists) {
            alert("Warning: Fee structure not found for Class " + activeStudent.class);
            currentBalance = 0;
        } else {
            const fm = mDoc.data();
            const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];
            const currentMonthName = new Date().toLocaleString('en-us', {month:'long'});
            let monthIdx = months.indexOf(currentMonthName);
            if(monthIdx === -1) monthIdx = 11;

            const monthlyFee = Number(fm.tuition || 0) + 
                               (activeStudent.hostel === 'Yes' ? Number(fm.hostel || 0) : 0) + 
                               (activeStudent.transport === 'Yes' ? Number(fm.transport || 0) : 0);
            
            const oneTimeFee = Number(fm.admission || 0) + Number(fm.development || 0) + Number(fm.exam || 0);
            
            const totalExpected = oneTimeFee + (monthlyFee * (monthIdx + 1));
            currentBalance = totalExpected - totalPaid;
        }
        document.getElementById('dueAmount').innerText = `₹ ${currentBalance.toFixed(2)}`;
    } catch (e) { 
        console.error(e);
        document.getElementById('dueAmount').innerText = "₹ Error";
    }
}

// 3. Submit Payment
async function submitPayment() {
    if(!activeStudent) return alert("Please select a student first!");
    const amt = document.getElementById('payAmt').value;
    const month = document.getElementById('payMonth').value;
    const mode = document.getElementById('payMode').value;
    const btn = document.getElementById('submitBtn');

    if(!amt || Number(amt) <= 0) return alert("Please enter a valid amount!");

    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing...`;

    const paymentData = {
        studentID: String(activeStudent.uniqueID),
        name: activeStudent.name,
        amount: Number(amt),
        month: month,
        mode: mode,
        date: new Date().toLocaleDateString('en-GB'),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await database.collection('fee_transactions').add(paymentData);
        alert("Success! Fee recorded.");
        generateReceipt(paymentData, activeStudent);
        
        // Reset inputs
        document.getElementById('payAmt').value = "";
        document.getElementById('studentSearch').value = "";
        document.getElementById('dueAmount').innerText = "₹ 0.00";
        activeStudent = null;

    } catch (e) { 
        alert("Transaction Failed: " + e.message); 
    } finally {
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-receipt me-2"></i> CONFIRM PAYMENT & GENERATE RECEIPT`;
    }
}

// 4. Receipt UI
function generateReceipt(p, s) {
    const remaining = (currentBalance - p.amount).toFixed(2);
    const receiptHTML = `
    <div class="receipt-card">
        <div class="receipt-header">
            <h2 class="brand-font" style="color:var(--royal-blue); margin:0;">THE LALIT INTERNATIONAL SCHOOL</h2>
            <p style="font-size:11px; color:var(--text-muted);">Affiliated to CBSE | Sector-12, School Campus</p>
            <div style="border-top:1px solid var(--gold); border-bottom:1px solid var(--gold); margin:10px 0; padding:5px;">
                <b style="letter-spacing:2px;">FEE RECEIPT (2025-26)</b>
            </div>
        </div>
        
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:13px;">
            <span><b>Receipt No:</b> TLIS/${Date.now().toString().slice(-5)}</span>
            <span><b>Date:</b> ${p.date}</span>
        </div>

        <table class="receipt-table">
            <tr><td><b>Student Name</b></td><td>${s.name.toUpperCase()}</td></tr>
            <tr><td><b>Student ID</b></td><td>${s.uniqueID}</td></tr>
            <tr><td><b>Class</b></td><td>${s.class} (${s.section || 'A'})</td></tr>
            <tr><td><b>Father's Name</b></td><td>${s.father}</td></tr>
            <tr><td><b>Payment For</b></td><td>Fee of ${p.month}</td></tr>
            <tr><td><b>Payment Mode</b></td><td>${p.mode}</td></tr>
        </table>

        <div style="margin-top:25px; padding:15px; background:var(--royal-blue); color:white; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:18px; font-weight:bold;">AMOUNT RECEIVED</span>
            <span style="font-size:22px; font-weight:bold;">₹ ${p.amount.toLocaleString('en-IN')}</span>
        </div>

        <p style="margin-top:10px; text-align:right; font-size:13px;"><b>Balance Due:</b> ₹ ${remaining}</p>

        <div style="margin-top:50px; display:flex; justify-content:space-between;">
            <div style="text-align:center; width:140px; border-top:1px solid #333; padding-top:5px; font-size:11px;">Depositor Signature</div>
            <div style="text-align:center; width:140px; border-top:1px solid #333; padding-top:5px; font-size:11px;">Accountant Signature</div>
        </div>

        <div class="text-center no-print mt-4">
            <button class="royal-btn btn-sm me-2" onclick="window.print()"><i class="fas fa-print"></i> Print Now</button>
            <button class="royal-btn btn-sm" style="background:#25D366; border:none;" onclick="shareWhatsApp('${s.contact || s.pContact}', '${s.name}', '${p.amount}')">
                <i class="fab fa-whatsapp"></i> Notify Parent
            </button>
        </div>
    </div>`;
    
    const container = document.getElementById('receiptArea');
    container.innerHTML = receiptHTML;
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
}

function shareWhatsApp(phone, name, amt) {
    if(!phone || phone === 'undefined') return alert("Phone number not available!");
    const msg = `*THE LALIT INTERNATIONAL SCHOOL*%0A*Fee Confirmation*%0A%0AWe have received ₹${amt} for student *${name}*.%0A%0A_Generated via Digital Portal TLIS._`;
    window.open(`https://wa.me/91${phone}?text=${msg}`, '_blank');
}
</script>
</body>
</html>
