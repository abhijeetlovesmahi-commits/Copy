<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marks Entry | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="auth-guard.js"></script>
    <script src="brand.js"></script>

    <style>
        .filter-section {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; background: #fff; padding: 25px;
            border: 1px solid var(--gold); border-radius: 12px; margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
        }

        .subject-highlight {
            border: 2px solid var(--gold) !important;
            background: var(--light-gold);
            font-weight: bold;
        }

        .marks-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .marks-table th { 
            background: var(--royal-blue); color: var(--gold); 
            padding: 15px; font-size: 0.8rem; text-transform: uppercase;
        }
        .marks-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }

        .marks-input {
            width: 80px; padding: 10px; text-align: center; 
            border: 2px solid #ddd; border-radius: 6px;
            font-weight: bold; font-size: 1.1rem; transition: 0.3s;
        }
        .marks-input:focus { border-color: var(--royal-blue); outline: none; }
        .marks-input.error { border-color: var(--danger); background-color: #fff5f5; color: var(--danger); }

        .std-img { 
            width: 45px; height: 45px; border-radius: 50%; 
            object-fit: cover; border: 1px solid var(--gold); 
        }
        
        .hidden { display: none; }
        #status-msg { font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin-top: 15px; }
        .msg-success { background: #e8f5e9; color: #2e7d32; }
        .msg-info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="main-content">
    <div class="royal-card">
        <div class="header" id="brand-header-container"></div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="brand-font" style="color: var(--royal-blue); margin: 0;">
                <i class="fas fa-edit me-2"></i>MARKS ENTRY LEDGER
            </h2>
            <div id="currentAction" class="badge bg-danger p-2" style="font-size: 0.9rem;">Select Exam & Subject</div>
        </div>

        <div class="filter-section">
            <div>
                <label class="small fw-bold">EXAM TYPE</label>
                <select id="examType" class="form-select" onchange="toggleTermFields(); fetchSubjects();">
                    <option value="">-- Select --</option>
                    <option value="Formative Test -I">Formative Test -I</option>
                    <option value="Periodic Test -I">Periodic Test -I</option>
                    <option value="Term -I">Term -I</option>
                    <option value="Formative Test -II">Formative Test -II</option>
                    <option value="Periodic -II">Periodic -II</option>
                    <option value="Term -II">Term -II</option>
                </select>
            </div>
            <div>
                <label class="small fw-bold">CLASS</label>
                <select id="examClass" class="form-select" onchange="fetchSubjects(); fetchStudents();">
                    <option value="">-- Select --</option>
                    <option value="Pre-Nursery">Pre-Nursery</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                    <option value="1">Class 1</option>
                    <option value="2">Class 2</option>
                    <option value="3">Class 3</option>
                    <option value="4">Class 4</option>
                    <option value="5">Class 5</option>
                    <option value="6">Class 6</option>
                    <option value="7">Class 7</option>
                    <option value="8">Class 8</option>
                    <option value="9">Class 9</option>
                    <option value="10">Class 10</option>
                    <option value="11">Class 11</option>
                    <option value="12">Class 12</option>
                </select>
            </div>
            <div>
                <label class="small fw-bold">SECTION</label>
                <select id="sSection" class="form-select" onchange="fetchStudents();">
                    <option value="A">Section A</option>
                    <option value="B">Section B</option>
                    <option value="C">Section C</option>
                    <option value="D">Section D</option>
                </select>
            </div>
            <div>
                <label class="small fw-bold">SUBJECT</label>
                <select id="subjectSelect" class="form-select subject-highlight" onchange="updateMaxMarks(); loadExistingMarks();">
                    <option value="">-- Select Subject --</option>
                </select>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table class="marks-table">
                <thead>
                    <tr>
                        <th>Roll & ID</th>
                        <th>Photo</th>
                        <th style="text-align: left;">Student Name</th>
                        <th id="headerMarks">Obtained Marks</th>
                        <th class="term-only hidden">Notebook (5)</th>
                        <th class="term-only hidden">SEA (5)</th>
                    </tr>
                </thead>
                <tbody id="studentBody">
                    <tr><td colspan="6" class="text-muted p-4">Awaiting filter selection...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="status-msg" class="hidden"></div>

        <button class="royal-btn btn-block btn-lg mt-4" id="saveBtn" onclick="saveMarks()">
            <i class="fas fa-check-double me-2"></i>COMMIT MARKS TO ARCHIVE
        </button>
    </div>
</div>

<script>
let currentMax = 100;

function toggleTermFields() {
    const isTerm = document.getElementById('examType').value.includes("Term");
    document.querySelectorAll('.term-only').forEach(el => isTerm ? el.classList.remove('hidden') : el.classList.add('hidden'));
}

async function fetchSubjects() {
    const eClass = document.getElementById('examClass').value;
    const eType = document.getElementById('examType').value;
    if(!eClass || !eType) return;

    const docId = `${eClass}_${eType}`.replace(/\s+/g, '');
    const doc = await db.collection('exam_settings').doc(docId).get();

    const subSelect = document.getElementById('subjectSelect');
    subSelect.innerHTML = '<option value="">-- Select Subject --</option>';
    if(doc.exists) {
        doc.data().subjects.forEach(sub => {
            subSelect.innerHTML += `<option value="${sub.subjectName}" data-max="${sub.fullMarks}">${sub.subjectName}</option>`;
        });
    }
}

function updateMaxMarks() {
    const sel = document.getElementById('subjectSelect');
    const opt = sel.options[sel.selectedIndex];
    if(sel.value) {
        currentMax = Number(opt.getAttribute('data-max'));
        document.getElementById('headerMarks').innerText = `Marks (Max: ${currentMax})`;
        document.getElementById('currentAction').innerHTML = `${sel.value} (Max: ${currentMax})`;
        validateAll();
    }
}

function validateAll() {
    document.querySelectorAll('.main-m').forEach(input => {
        if(Number(input.value) > currentMax) input.classList.add('error');
        else input.classList.remove('error');
    });
}

async function fetchStudents() {
    const sClass = document.getElementById('examClass').value;
    const sSection = document.getElementById('sSection').value;
    if(!sClass || !sSection) return;

    const tbody = document.getElementById('studentBody');
    tbody.innerHTML = "<tr><td colspan='6' class='text-center p-4'><i class='fas fa-sync fa-spin'></i> Loading Class List...</td></tr>";

    try {
        const snap = await db.collection('students').where('class', '==', sClass).where('section', '==', sSection).get();
        let students = [];
        snap.forEach(doc => students.push(doc.data()));
        students.sort((a, b) => (a.rollNo || a.uniqueID) - (b.rollNo || b.uniqueID));

        tbody.innerHTML = "";
        students.forEach(s => {
            const isTerm = document.getElementById('examType').value.includes("Term");
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="fw-bold text-royal">${s.rollNo || '-'}</div>
                    <div class="small text-muted">ID: ${s.uniqueID}</div>
                </td>
                <td><img src="${s.photo || 'https://via.placeholder.com/50'}" class="std-img"></td>
                <td style="text-align: left;"><b>${s.name.toUpperCase()}</b></td>
                <td><input type="number" class="marks-input main-m" data-id="${s.uniqueID}" oninput="validateAll()"></td>
                <td class="term-only ${isTerm ? '' : 'hidden'}"><input type="number" class="marks-input note-m" max="5"></td>
                <td class="term-only ${isTerm ? '' : 'hidden'}"><input type="number" class="marks-input sea-m" max="5"></td>
            `;
            tbody.appendChild(tr);
        });
        
        if(document.getElementById('subjectSelect').value) loadExistingMarks();
        
    } catch (e) { alert("Error: " + e.message); }
}

async function loadExistingMarks() {
    const exam = document.getElementById('examType').value;
    const cls = document.getElementById('examClass').value;
    const sec = document.getElementById('sSection').value;
    const subject = document.getElementById('subjectSelect').value;

    if(!exam || !cls || !sec || !subject) return;

    showStatus("Syncing with archives...", "info");

    try {
        const snap = await db.collection('marks_entry')
            .where('class', '==', cls)
            .where('section', '==', sec)
            .where('exam', '==', exam)
            .where('subject', '==', subject)
            .get();

        if(!snap.empty) {
            snap.forEach(doc => {
                const data = doc.data();
                const row = document.querySelector(`.main-m[data-id="${data.uID}"]`);
                if(row) {
                    const parentTr = row.closest('tr');
                    row.value = data.marks;
                    if(parentTr.querySelector('.note-m')) parentTr.querySelector('.note-m').value = data.notebook;
                    if(parentTr.querySelector('.sea-m')) parentTr.querySelector('.sea-m').value = data.sea;
                }
            });
            showStatus("Existing marks loaded for editing.", "success");
        } else {
            document.querySelectorAll('.marks-input').forEach(i => i.value = "");
            showStatus("Ready for fresh entry.", "info");
        }
    } catch (e) { console.error(e); }
}

async function saveMarks() {
    const subject = document.getElementById('subjectSelect').value;
    if(!subject) return alert("Please select a subject first!");
    if(document.querySelectorAll('.error').length > 0) return alert("Error: Some marks exceed the maximum limit!");

    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.innerText = "Synchronizing Records...";

    const batch = db.batch();
    const rows = document.querySelectorAll('#studentBody tr');
    const exam = document.getElementById('examType').value;
    const cls = document.getElementById('examClass').value;
    const sec = document.getElementById('sSection').value;

    rows.forEach(row => {
        const mainInput = row.querySelector('.main-m');
        if(!mainInput) return;
        
        const uID = mainInput.getAttribute('data-id');
        const m = mainInput.value;
        const n = row.querySelector('.note-m')?.value || 0;
        const s = row.querySelector('.sea-m')?.value || 0;

        const docId = `${cls}_${sec}_${exam}_${subject}_${uID}`.replace(/\s+/g, '');
        batch.set(db.collection('marks_entry').doc(docId), {
            uID, class: cls, section: sec, exam, subject, marks: Number(m), notebook: Number(n), sea: Number(s), timestamp: Date.now()
        });
    });

    try {
        await batch.commit();
        showStatus("Marks committed to archives successfully!", "success");
        setTimeout(() => location.reload(), 1500);
    } catch (e) { 
        alert(e.message); 
        btn.disabled = false;
        btn.innerText = "COMMIT MARKS TO ARCHIVE";
    }
}

function showStatus(text, type) {
    const s = document.getElementById('status-msg');
    s.className = `msg-${type}`;
    s.innerText = text;
    s.classList.remove('hidden');
}
</script>

<script src="menu.js"></script>
</body>
</html>
