<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lalit - Advanced Report System</title>
    <style>
        :root { 
            --royal-blue: #002366;
            --gold: #D4AF37;
            --deep-gold: #aa8a2e;
            --light-gold: #FDFBF0;
            --white: #ffffff;
        }

        @page { size: A4; margin: 0; }
        body { font-family: 'Georgia', serif; background: var(--light-gold); margin: 0; padding: 0; }

        /* BRANDED CONTROL PANEL */
        .admin-container {
            max-width: 1100px; margin: 30px auto; background: var(--white);
            padding: 40px; border: 1px solid var(--gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 8px;
        }

        .admin-header { text-align: center; border-bottom: 3px double var(--gold); margin-bottom: 30px; padding-bottom: 20px; }
        .school-logo-main { width: 100px; margin-bottom: 10px; }

        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        label { font-size: 0.8rem; font-weight: bold; color: var(--deep-gold); text-transform: uppercase; margin-bottom: 5px; display: block; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ccc; border-bottom: 2px solid var(--gold); outline: none; }

        .btn-group { display: flex; gap: 15px; }
        .main-btn { flex: 1; padding: 15px; background: var(--royal-blue); color: var(--gold); border: 1px solid var(--gold); font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .main-btn:hover { background: #001a4d; }
        .print-btn { background: #27ae60; color: white; border: none; }

        /* REPORT CARD STYLES */
        .report-card { 
            width: 210mm; height: 296mm; padding: 10mm; background: white; 
            margin: 40px auto; border: 15px double var(--royal-blue);
            box-sizing: border-box; position: relative; page-break-after: always;
            display: flex; flex-direction: column;
        }

        .card-header-table { width: 100%; border: none; margin-bottom: 10px; }
        .card-logo { width: 90px; height: 90px; object-fit: contain; }
        .card-student-photo { width: 90px; height: 110px; border: 2px solid var(--gold); object-fit: cover; }
        .card-school-name { font-size: 28px; font-weight: bold; color: var(--royal-blue); margin: 0; }

        .exam-title-bar { 
            background: var(--royal-blue); color: var(--gold); text-align: center; 
            padding: 8px; font-weight: bold; margin: 10px 0; border-radius: 4px; font-size: 18px;
        }

        .std-info-table { width: 100%; border: 1px solid #000; margin-bottom: 15px; font-size: 14px; border-collapse: collapse; }
        .std-info-table td { padding: 8px; border: 1px solid #eee; }

        .marks-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px; }
        .marks-table th, .marks-table td { border: 1px solid #000; padding: 5px; text-align: center; }
        .marks-table th { background: #f2f2f2; }

        /* Result Summary Box */
        .result-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0; border: 2px solid #000; margin-bottom: 15px; background: #f9f9f9; }
        .res-item { padding: 10px; text-align: center; border-right: 1px solid #000; }
        .res-item:last-child { border-right: none; }
        .res-label { font-size: 11px; font-weight: bold; color: var(--royal-blue); display: block; }
        .res-val { font-size: 16px; font-weight: bold; color: #000; }

        .co-scholastic-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }

        .footer-signs { display: flex; justify-content: space-between; margin-top: auto; padding-bottom: 20px; text-align: center; }
        .sig-box { width: 160px; }
        .sig-img { width: 130px; height: 50px; object-fit: contain; mix-blend-mode: multiply; }
        .sig-text { border-top: 1px solid #000; margin-top: 5px; font-weight: bold; }

        @media print { .no-print { display: none !important; } .report-card { margin: 0; border: 10px double var(--royal-blue); } }
    </style>
</head>
<body>

<div class="admin-container no-print">
    <div class="admin-header">
        <img src="logo.png" alt="Logo" class="school-logo-main">
        <h1 style="color: var(--royal-blue); margin: 5px 0;">REPORT CARD MASTER</h1>
        <p style="color: var(--gold);">THE LALIT INTERNATIONAL SCHOOL - BULK SYSTEM</p>
    </div>

    <div class="controls-grid">
        <div><label>Class</label><select id="selClass"><script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">Class ${i}</option>`)</script></select></div>
        <div><label>Section</label><select id="selSection"><option value="A">A</option><option value="B">B</option></select></div>
        <div><label>Mode</label><select id="reportMode"><option value="1">Half Yearly (Term-I)</option><option value="2">Annual (Term-I + II)</option></select></div>
        <div><label>Teacher Sign</label><input type="file" onchange="loadSign(this, 'ct')"></div>
        <div><label>Principal Sign</label><input type="file" onchange="loadSign(this, 'pr')"></div>
    </div>
    <div class="btn-group">
        <button class="main-btn" onclick="generateBulk()">GENERATE CARDS</button>
        <button class="main-btn print-btn" onclick="window.print()">PRINT PDF</button>
    </div>
</div>

<div id="bulkContainer"></div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let ctSign = "", prSign = "";
function loadSign(input, type) { if (input.files && input.files[0]) { let r = new FileReader(); r.onload = e => { if(type==='ct') ctSign = e.target.result; else prSign = e.target.result; }; r.readAsDataURL(input.files[0]); } }

async function generateBulk() {
    const sClass = document.getElementById('selClass').value;
    const sSec = document.getElementById('selSection').value;
    const mode = document.getElementById('reportMode').value;
    const container = document.getElementById('bulkContainer');
    container.innerHTML = "<h2>Generating Reports...</h2>";

    try {
        const stdSnap = await db.collection('students').where('class','==',sClass).where('section','==',sSec).get();
        const marksSnap = await db.collection('marks_entry').where('class','==',sClass).where('section','==',sSec).get();

        let allMarks = {};
        marksSnap.forEach(doc => { let d = doc.data(); if(!allMarks[d.studentID]) allMarks[d.studentID] = {}; allMarks[d.studentID][`${d.subject}_${d.examType}`] = d; });

        const subjects = ["English", "Hindi", "Mathematics", "Science", "Social Science", "Computer", "General Knowledge"];
        let students = [];
        stdSnap.forEach(doc => {
            let sData = doc.data();
            let grandTotal = 0;
            subjects.forEach(sub => {
                const t1 = Math.round(((allMarks[sData.uniqueID]?.[`${sub}_Periodic Test -I`]?.marks || 0)/4) + (allMarks[sData.uniqueID]?.[`${sub}_Term -I`]?.notebook || 0) + (allMarks[sData.uniqueID]?.[`${sub}_Term -I`]?.sea || 0) + (allMarks[sData.uniqueID]?.[`${sub}_Term -I`]?.marks || 0));
                const t2 = Math.round(((allMarks[sData.uniqueID]?.[`${sub}_Periodic -II`]?.marks || 0)/4) + (allMarks[sData.uniqueID]?.[`${sub}_Term -II`]?.notebook || 0) + (allMarks[sData.uniqueID]?.[`${sub}_Term -II`]?.sea || 0) + (allMarks[sData.uniqueID]?.[`${sub}_Term -II`]?.marks || 0));
                grandTotal += (mode === "2") ? (t1 + t2) : t1;
            });
            sData.tempTotal = grandTotal;
            students.push(sData);
        });

        // Calculate Rank
        students.sort((a,b) => b.tempTotal - a.tempTotal);
        students.forEach((s, index) => s.rank = index + 1);
        students.sort((a,b) => a.uniqueID - b.uniqueID);

        let html = "";
        students.forEach(s => {
            let rows = ""; let totalObtained = 0;
            subjects.forEach(sub => {
                const sm = allMarks[s.uniqueID] || {};
                const t1 = Math.round(((sm[`${sub}_Periodic Test -I`]?.marks || 0)/4) + (sm[`${sub}_Term -I`]?.notebook || 0) + (sm[`${sub}_Term -I`]?.sea || 0) + (sm[`${sub}_Term -I`]?.marks || 0));
                const t2 = Math.round(((sm[`${sub}_Periodic -II`]?.marks || 0)/4) + (sm[`${sub}_Term -II`]?.notebook || 0) + (sm[`${sub}_Term -II`]?.sea || 0) + (sm[`${sub}_Term -II`]?.marks || 0));
                const subFinal = (mode === "2") ? (t1 + t2) : t1;
                totalObtained += subFinal;
                rows += `<tr><td style="text-align:left; padding-left:10px;"><b>${sub}</b></td><td>${sm[`${sub}_Periodic Test -I`]?.marks || 0}</td><td>${sm[`${sub}_Term -I`]?.notebook || 0}</td><td>${sm[`${sub}_Term -I`]?.sea || 0}</td><td>${sm[`${sub}_Term -I`]?.marks || 0}</td><td><b>${t1}</b></td><td>${calcGrade(t1)}</td>${mode==="2"?`<td>${sm[`${sub}_Periodic -II`]?.marks||0}</td><td>${sm[`${sub}_Term -II`]?.notebook||0}</td><td>${sm[`${sub}_Term -II`]?.sea||0}</td><td>${sm[`${sub}_Term -II`]?.marks||0}</td><td><b>${t2}</b></td><td>${calcGrade(t2)}</td>`:""}</tr>`;
            });

            const maxTotal = mode === "2" ? (subjects.length * 200) : (subjects.length * 100);
            const perc = ((totalObtained / maxTotal) * 100).toFixed(1);
            const examLabel = mode === "1" ? "HALF YEARLY EXAMINATION" : "ANNUAL EXAMINATION";

            html += `
            <div class="report-card">
                <table class="card-header-table">
                    <tr>
                        <td style="width:100px; border:none;"><img src="logo.png" class="card-logo"></td>
                        <td style="text-align:center; border:none;">
                            <h1 class="card-school-name">THE LALIT INTERNATIONAL SCHOOL</h1>
                            <p style="margin:2px 0;">Affiliated to CBSE | Session: 2025-26</p>
                        </td>
                        <td style="width:100px; border:none;"><img src="${s.photo || 'https://via.placeholder.com/100'}" class="card-student-photo"></td>
                    </tr>
                </table>

                <div class="exam-title-bar">${examLabel}</div>

                <table class="std-info-table">
                    <tr><td>Name: <b>${s.name}</b></td><td>Roll No: <b>${s.uniqueID - 1000}</b></td></tr>
                    <tr><td>Father: <b>${s.father}</b></td><td>Class: <b>${s.class} - ${s.section}</b></td></tr>
                </table>

                <table class="marks-table">
                    <thead>
                        <tr><th rowspan="2">SUBJECTS</th><th colspan="6">TERM - I</th>${mode==="2"?"<th colspan='6'>TERM - II</th>":""}</tr>
                        <tr><th>PT</th><th>NB</th><th>SEA</th><th>Exam</th><th>Tot</th><th>Gr</th>${mode==="2"?"<th>PT</th><th>NB</th><th>SEA</th><th>Exam</th><th>Tot</th><th>Gr</th>":""}</tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>

                <div class="result-summary">
                    <div class="res-item"><span class="res-label">GRAND TOTAL</span><span class="res-val">${totalObtained} / ${maxTotal}</span></div>
                    <div class="res-item"><span class="res-label">PERCENTAGE</span><span class="res-val">${perc}%</span></div>
                    <div class="res-item"><span class="res-label">OVERALL GRADE</span><span class="res-val">${calcGrade(perc)}</span></div>
                    <div class="res-item"><span class="res-label">CLASS RANK</span><span class="res-val">${s.rank}</span></div>
                </div>

                <div class="section-title" style="background:var(--royal-blue); color:var(--gold); text-align:center; padding:5px; margin-bottom:10px;">CO-SCHOLASTIC AREAS</div>
                <div class="co-scholastic-section">
                    <table class="marks-table"><tr><th>Term I Activity</th><th>Grade</th></tr><tr><td>Work/Art/Health/Disc.</td><td>A</td></tr></table>
                    <table class="marks-table"><tr><th>Term II Activity</th><th>Grade</th></tr><tr><td>Work/Art/Health/Disc.</td><td>A</td></tr></table>
                </div>

                <div style="border:1px solid #000; padding:10px; font-size:13px; flex-grow:1;">
                    <b>Remarks:</b> ${perc > 33 ? "Congratulations! Promoted to next class." : "Needs more effort."}
                </div>

                <div class="footer-signs">
                    <div class="sig-box">${ctSign?`<img src="${ctSign}" class="sig-img">`:''}<div class="sig-text">Class Teacher</div></div>
                    <div class="sig-box">${prSign?`<img src="${prSign}" class="sig-img">`:''}<div class="sig-text">Principal</div></div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    } catch (e) { alert(e.message); }
}

function calcGrade(m) {
    if(m>=91) return 'A1'; if(m>=81) return 'A2'; if(m>=71) return 'B1'; if(m>=61) return 'B2';
    if(m>=51) return 'C1'; if(m>=41) return 'C2'; if(m>=33) return 'D'; return 'E';
}
</script>
</body>
</html>
