<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Card Master | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="auth-guard.js"></script>
    <script src="brand.js"></script>

    <style>
        :root { 
            --royal-blue: #002366; --gold: #D4AF37; --deep-gold: #aa8a2e;
            --light-gold: #FDFBF0; --white: #ffffff;
        }

        /* Printing & PDF Adjustments */
        @page { size: A4; margin: 0; }
        
        .admin-container { max-width: 1100px; margin: 0 auto; }

        .controls-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; background: #fff; padding: 25px; border-radius: 12px;
            border: 1px solid var(--gold); margin-bottom: 25px;
        }

        /* Report Card Design with Watermark & Security Pattern */
        .report-card { 
            width: 210mm; height: 296mm; padding: 12mm; background: white; 
            margin: 40px auto; border: 15px double var(--royal-blue);
            box-sizing: border-box; position: relative; page-break-after: always;
            display: flex; flex-direction: column; color: #000;
            overflow: hidden;
            background-image: radial-gradient(rgba(212, 175, 55, 0.1) 0.5px, transparent 0.5px);
            background-size: 4px 4px; /* Micro-dots like stamp paper */
        }

        /* The Logo Watermark */
        .report-card::before {
            content: "";
            position: absolute;
            top: 55%; left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            width: 450px; height: 450px;
            background-image: url('logo.png'); /* Ensure logo path is correct */
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: 0.07;
            z-index: 0;
            pointer-events: none;
        }

        /* Guilloche / Security Line Pattern */
        .report-card::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                rgba(0, 35, 102, 0.02) 0px,
                rgba(0, 35, 102, 0.02) 0.5px,
                transparent 0.5px,
                transparent 8px
            );
            z-index: 0;
            pointer-events: none;
        }

        .report-card * { position: relative; z-index: 1; }

        .exam-title-bar { 
            background: var(--royal-blue); color: var(--gold); text-align: center; 
            padding: 8px; font-weight: bold; margin: 15px 0; border-radius: 4px; 
            font-size: 18px; font-family: 'Cinzel', serif;
        }

        .marks-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 11.5px; background: rgba(255,255,255,0.8); }
        .marks-table th, .marks-table td { border: 1px solid #000; padding: 6px 4px; text-align: center; }
        .marks-table th { background: #f2f2f2; font-size: 10px; }

        .result-summary { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            border: 2px solid #000; margin-bottom: 15px; background: rgba(249, 249, 249, 0.9); 
        }
        .res-item { padding: 10px; text-align: center; border-right: 1px solid #000; }
        .res-item:last-child { border-right: none; }
        .res-label { font-size: 10px; font-weight: bold; color: var(--royal-blue); display: block; text-transform: uppercase; }
        .res-val { font-size: 18px; font-weight: bold; }

        .footer-signs { display: flex; justify-content: space-between; margin-top: auto; padding-bottom: 20px; text-align: center; }
        .sig-box { width: 160px; }
        .sig-img { width: 130px; height: 50px; object-fit: contain; mix-blend-mode: multiply; }
        .sig-text { border-top: 1px solid #000; margin-top: 5px; font-weight: bold; font-size: 13px; }

        @media print { 
            .no-print, #menu-container { display: none !important; } 
            body { background: white; padding: 0; }
            .main-content { margin: 0 !important; padding: 0 !important; }
            .report-card { margin: 0; border: 10px double var(--royal-blue); box-shadow: none; } 
        }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="main-content">
    <div class="admin-container no-print">
        <div class="royal-card">
            <div class="header" id="brand-header-container"></div>
            
            <h2 class="brand-font text-center mb-4" style="color: var(--royal-blue);">Report Card Generation System</h2>

            <div class="controls-grid">
                <div>
                    <label>Target Class</label>
                    <select id="selClass" class="form-select">
                        <option value="Pre-Nursery">Pre-Nursery</option>
                        <option value="Nursery">Nursery</option>
                        <option value="LKG">LKG</option>
                        <option value="UKG">UKG</option>
                        <script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">Class ${i}</option>`)</script>
                    </select>
                </div>
                <div>
                    <label>Section</label>
                    <select id="selSection" class="form-select">
                        <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                    </select>
                </div>
                <div>
                    <label>Report Mode</label>
                    <select id="reportMode" class="form-select">
                        <option value="1">Half Yearly (Term-I)</option>
                        <option value="2">Annual (Term-I + II)</option>
                    </select>
                </div>
                <div>
                    <label>Teacher Sign</label>
                    <input type="file" class="form-control form-control-sm" onchange="loadSign(this, 'ct')">
                </div>
                <div>
                    <label>Principal Sign</label>
                    <input type="file" class="form-control form-control-sm" onchange="loadSign(this, 'pr')">
                </div>
            </div>

            <div class="d-flex gap-2 flex-wrap">
                <button class="royal-btn" onclick="generateBulk()" style="flex:1">
                    <i class="fas fa-sync-alt me-2"></i>GENERATE CARDS
                </button>
                <button class="royal-btn" onclick="downloadPDF()" style="background:#c0392b; flex:1">
                    <i class="fas fa-file-pdf me-2"></i>DOWNLOAD PDF
                </button>
                <button class="royal-btn" onclick="window.print()" style="background:#27ae60; flex:1">
                    <i class="fas fa-print me-2"></i>PRINT ALL
                </button>
            </div>
        </div>
    </div>

    <div id="bulkContainer"></div>
</div>

<script>
let ctSign = "", prSign = "";

function loadSign(input, type) { 
    if (input.files && input.files[0]) { 
        let r = new FileReader(); 
        r.onload = e => { if(type==='ct') ctSign = e.target.result; else prSign = e.target.result; }; 
        r.readAsDataURL(input.files[0]); 
    } 
}

async function downloadPDF() {
    const element = document.getElementById('bulkContainer');
    if(!element.innerHTML || element.innerHTML.includes('fa-spinner')) {
        return alert("Pehle 'GENERATE CARDS' button par click karein!");
    }
    
    const opt = {
        margin: 0,
        filename: `Report_Cards_${new Date().getTime()}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, letterRendering: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save();
}

async function generateBulk() {
    const sClass = document.getElementById('selClass').value;
    const sSec = document.getElementById('selSection').value;
    const mode = document.getElementById('reportMode').value;
    const container = document.getElementById('bulkContainer');
    
    container.innerHTML = "<div class='text-center p-5'><i class='fas fa-spinner fa-spin fa-3x mb-3'></i><p>Compiling Scholastic Data...</p></div>";

    try {
        const stdSnap = await db.collection('students').where('class','==',sClass).where('section','==',sSec).get();
        const marksSnap = await db.collection('marks_entry').where('class','==',sClass).where('section','==',sSec).get();

        let allMarks = {};
        marksSnap.forEach(doc => { 
            let d = doc.data(); 
            let sID = d.uID; 
            if(!allMarks[sID]) allMarks[sID] = {}; 
            allMarks[sID][`${d.subject}_${d.exam}`] = d; 
        });

        const subjects = ["English", "Hindi", "Mathematics", "Science", "Social Science", "Computer", "General Knowledge"];
        let students = [];

        stdSnap.forEach(doc => {
            let sData = doc.data();
            let sid = sData.uniqueID;
            let grandTotal = 0;
            
            subjects.forEach(sub => {
                const sm = allMarks[sid] || {};
                const t1 = Math.round((Number(sm[`${sub}_Periodic Test -I`]?.marks || 0)/4) + Number(sm[`${sub}_Term -I`]?.notebook || 0) + Number(sm[`${sub}_Term -I`]?.sea || 0) + Number(sm[`${sub}_Term -I`]?.marks || 0));
                const t2 = Math.round((Number(sm[`${sub}_Periodic -II`]?.marks || 0)/4) + Number(sm[`${sub}_Term -II`]?.notebook || 0) + Number(sm[`${sub}_Term -II`]?.sea || 0) + Number(sm[`${sub}_Term -II`]?.marks || 0));
                grandTotal += (mode === "2") ? (t1 + t2) : t1;
            });
            sData.tempTotal = grandTotal;
            students.push(sData);
        });

        students.sort((a,b) => b.tempTotal - a.tempTotal);
        students.forEach((s, index) => s.rank = index + 1);
        students.sort((a,b) => (a.rollNo || a.uniqueID) - (b.rollNo || b.uniqueID));

        let html = "";
        students.forEach(s => {
            let rows = ""; let totalObtained = 0;
            const sid = s.uniqueID;
            
            subjects.forEach(sub => {
                const sm = allMarks[sid] || {};
                const t1_pt = sm[`${sub}_Periodic Test -I`]?.marks || 0;
                const t1_nb = sm[`${sub}_Term -I`]?.notebook || 0;
                const t1_sea = sm[`${sub}_Term -I`]?.sea || 0;
                const t1_exam = sm[`${sub}_Term -I`]?.marks || 0;
                const t1 = Math.round((t1_pt/4) + t1_nb + t1_sea + t1_exam);

                const t2_pt = sm[`${sub}_Periodic -II`]?.marks || 0;
                const t2_nb = sm[`${sub}_Term -II`]?.notebook || 0;
                const t2_sea = sm[`${sub}_Term -II`]?.sea || 0;
                const t2_exam = sm[`${sub}_Term -II`]?.marks || 0;
                const t2 = Math.round((t2_pt/4) + t2_nb + t2_sea + t2_exam);

                const subFinal = (mode === "2") ? (t1 + t2) : t1;
                totalObtained += subFinal;

                rows += `<tr>
                    <td style="text-align:left; padding-left:10px;"><b>${sub.toUpperCase()}</b></td>
                    <td>${t1_pt}</td><td>${t1_nb}</td><td>${t1_sea}</td><td>${t1_exam}</td><td><b>${t1}</b></td><td>${calcGrade(t1)}</td>
                    ${mode==="2"?`<td>${t2_pt}</td><td>${t2_nb}</td><td>${t2_sea}</td><td>${t2_exam}</td><td><b>${t2}</b></td><td>${calcGrade(t2)}</td>`:""}
                </tr>`;
            });

            const maxTotal = mode === "2" ? (subjects.length * 200) : (subjects.length * 100);
            const perc = ((totalObtained / maxTotal) * 100).toFixed(1);
            const examLabel = mode === "1" ? "HALF YEARLY EXAMINATION (TERM-I)" : "ANNUAL PROGRESS REPORT";

            html += `
            <div class="report-card">
                <table style="width:100%; border:none;">
                    <tr>
                        <td style="width:100px; border:none;"><img src="logo.png" style="width:90px;" onerror="this.src='https://via.placeholder.com/90'"></td>
                        <td style="text-align:center; border:none;">
                            <h1 style="font-size:26px; color:var(--royal-blue); margin:0;">THE LALIT INTERNATIONAL SCHOOL</h1>
                            <p style="margin:5px 0; font-size:12px;">(An English Medium Senior Secondary School, Affiliated to CBSE)<br>Session: 2025-26</p>
                        </td>
                        <td style="width:100px; border:none; text-align:right;"><img src="${s.photo || 'https://via.placeholder.com/100'}" style="width:90px; border:1px solid #000;"></td>
                    </tr>
                </table>

                <div class="exam-title-bar">${examLabel}</div>

                <table class="marks-table" style="margin-bottom:10px;">
                    <tr><td style="text-align:left;">Student Name: <b>${s.name.toUpperCase()}</b></td><td style="text-align:left;">Roll No: <b>${s.rollNo || (s.uniqueID-1000)}</b></td></tr>
                    <tr><td style="text-align:left;">Father's Name: <b>${s.father.toUpperCase()}</b></td><td style="text-align:left;">Class-Section: <b>${s.class} - ${s.section}</b></td></tr>
                </table>

                <table class="marks-table">
                    <thead>
                        <tr><th rowspan="2">SCHOLASTIC SUBJECTS</th><th colspan="6">TERM - I (100)</th>${mode==="2"?"<th colspan='6'>TERM - II (100)</th>":""}</tr>
                        <tr><th>PT</th><th>NB</th><th>SEA</th><th>EXAM</th><th>TOT</th><th>GR</th>${mode==="2"?"<th>PT</th><th>NB</th><th>SEA</th><th>EXAM</th><th>TOT</th><th>GR</th>":""}</tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>

                <div class="result-summary">
                    <div class="res-item"><span class="res-label">GRAND TOTAL</span><span class="res-val">${totalObtained} / ${maxTotal}</span></div>
                    <div class="res-item"><span class="res-label">PERCENTAGE</span><span class="res-val">${perc}%</span></div>
                    <div class="res-item"><span class="res-label">RESULT</span><span class="res-val">${perc > 33 ? 'PASS' : 'FAIL'}</span></div>
                    <div class="res-item"><span class="res-label">CLASS RANK</span><span class="res-val">${s.rank}</span></div>
                </div>

                <div style="background:var(--royal-blue); color:var(--gold); text-align:center; padding:5px; margin-bottom:10px; font-weight:bold; font-size:12px;">CO-SCHOLASTIC AREAS & DISCIPLINE</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                    <table class="marks-table"><tr><th>Term I Activity</th><th>Grade</th></tr><tr><td>Work/Art/Health/Disc.</td><td>A</td></tr></table>
                    <table class="marks-table"><tr><th>Term II Activity</th><th>Grade</th></tr><tr><td>Work/Art/Health/Disc.</td><td>A</td></tr></table>
                </div>

                <div style="border:1px solid #000; padding:10px; font-size:13px; min-height:60px; background:rgba(255,255,255,0.7);">
                    <b>Class Teacher's Remarks:</b> ${perc > 80 ? "Excellent Performance! Keep it up." : perc > 60 ? "Good Progress, can do better in Math." : "Hard work required in core subjects."}
                </div>

                <div class="footer-signs">
                    <div class="sig-box">${ctSign?`<img src="${ctSign}" class="sig-img">`:''}<div class="sig-text">Class Teacher</div></div>
                    <div class="sig-box"><div class="sig-text" style="border:none;">Parent's Signature</div></div>
                    <div class="sig-box">${prSign?`<img src="${prSign}" class="sig-img">`:''}<div class="sig-text">Principal</div></div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    } catch (e) { 
        alert("Error Generating Reports: " + e.message); 
        container.innerHTML = "";
    }
}

function calcGrade(m) {
    if(m>=91) return 'A1'; if(m>=81) return 'A2'; if(m>=71) return 'B1'; if(m>=61) return 'B2';
    if(m>=51) return 'C1'; if(m>=41) return 'C2'; if(m>=33) return 'D'; return 'E';
}
</script>

<script src="menu.js"></script>
</body>
</html>
