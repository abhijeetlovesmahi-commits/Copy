<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Advance Ledger & Demand Center</title>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --royal: #002147; --gold: #ffd700; --soft-bg: #f4f7f6; }
        body { background: var(--soft-bg); font-family: 'Segoe UI', sans-serif; }

        /* Ledger UI Improvements */
        #ledgerArea { display: none; background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 20px; }
        .table-ledger { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #ddd; }
        .table-ledger th { background: var(--royal); color: var(--gold); padding: 12px; font-size: 13px; text-align: center; }
        .table-ledger td { border: 1px solid #eee; padding: 10px; font-size: 13px; font-weight: 600; text-align: center; }
        
        .disc-input { width: 60px; padding: 4px; border: 1px solid var(--gold); border-radius: 4px; text-align: center; font-weight: bold; color: #d35400; }
        
        /* Action Buttons */
        .action-bar { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 25px; }
        .btn-adv { padding: 12px 20px; border-radius: 8px; font-weight: bold; border: none; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-calc { background: #27ae60; color: white; }
        .btn-print { background: var(--royal); color: var(--gold); }
        .btn-hist { background: #8e44ad; color: white; }
        .btn-demand { background: #e67e22; color: white; }

        /* Demand Slip Styling (Print Ready) */
        .demand-slip-container { display: none; padding: 20px; }
        .slip-card { 
            width: 100%; max-width: 450px; border: 2px solid #333; padding: 15px; 
            margin: 10px auto; background: #fff; position: relative;
            page-break-inside: avoid;
        }
        .slip-header { display: flex; align-items: center; border-bottom: 2px solid var(--royal); padding-bottom: 10px; margin-bottom: 10px; }
        .slip-logo { width: 50px; height: 50px; margin-right: 10px; }
        .slip-photo { width: 60px; height: 75px; border: 1px solid #333; position: absolute; right: 15px; top: 60px; }
        .whatsapp-btn { background: #25D366; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }

        /* Filter Panel */
        .filter-panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--gold); }

        @media print {
            .no-print, #menu-container, .filter-panel, .action-bar { display: none !important; }
            #ledgerArea, .demand-slip-container { display: block !important; box-shadow: none !important; border: none !important; }
            .slip-card { border: 1px solid #000 !important; }
        }
    </style>
</head>
<body>

<div id="menu-container" class="no-print"></div>

<div class="container main-content mt-4">
    <header id="brand-header-container" class="text-center no-print mb-4"></header>

    <div class="search-box-wrapper no-print text-center mb-4">
        <input type="text" id="searchID" class="form-control d-inline-block w-50" placeholder="Enter Student Name or ID..." oninput="liveSearch()">
        <div id="searchSuggestions" class="mt-2 list-group" style="max-width:50%; margin:auto;"></div>
    </div>

    <div class="filter-panel no-print text-center">
        <h6 class="fw-bold mb-3"><i class="fas fa-filter me-2"></i>DEMAND SLIP GENERATOR</h6>
        <div class="row g-2 justify-content-center">
            <div class="col-md-2">
                <select id="fClass" class="form-select">
                    <option value="All">All Classes</option>
                    <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
                </select>
            </div>
            <div class="col-md-2">
                <select id="fMonth" class="form-select">
                    <option value="Current">Current Month</option>
                    <script>["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"].forEach(m => document.write(`<option value="${m}">${m}</option>`));</script>
                </select>
            </div>
            <button class="btn btn-adv btn-demand col-md-auto" onclick="generateMultiDemandSlips()">
                <i class="fas fa-file-invoice"></i> GENERATE SLIPS
            </button>
        </div>
    </div>

    <div id="ledgerArea">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="brand-font m-0 text-primary"><i class="fas fa-book-open me-2"></i>MASTER LEDGER</h4>
            <div class="text-end">
                <span class="badge bg-dark" id="lID_badge"></span>
            </div>
        </div>
        
        <div class="student-strip d-flex align-items-center p-3 border rounded bg-light mb-3">
            <img id="lPhoto" src="" class="rounded border" style="width:80px; height:100px; object-fit: cover;">
            <div class="ms-4 row w-100" style="font-size: 14px;">
                <div class="col-md-4">NAME: <b id="lName"></b></div>
                <div class="col-md-4">FATHER: <b id="lFather"></b></div>
                <div class="col-md-4">CLASS: <b id="lClass"></b></div>
                <div class="col-md-4">TRANSPORT: <b id="lTrans"></b></div>
                <div class="col-md-4">CONTACT: <b id="lContact"></b></div>
            </div>
        </div>

        <table class="table-ledger">
            <thead>
                <tr>
                    <th style="width: 20%;">PARTICULARS</th>
                    <th>BASE FEE</th>
                    <th>DISC %</th>
                    <th>NET PAYABLE</th>
                    <th>PAID</th>
                    <th>BALANCE</th>
                </tr>
            </thead>
            <tbody id="lBody"></tbody>
            <tfoot class="bg-light fw-bold">
                <tr>
                    <td colspan="3" class="text-end">CUMULATIVE TOTAL</td>
                    <td id="totalPay">0</td>
                    <td id="totalPaid">0</td>
                    <td id="totalDue" class="text-danger">0</td>
                </tr>
            </tfoot>
        </table>

        <div class="action-bar no-print">
            <button class="btn-adv btn-calc" onclick="calculateLedger()"><i class="fas fa-sync"></i> RE-CALCULATE</button>
            <button class="btn-adv btn-print" onclick="window.print()"><i class="fas fa-print"></i> PRINT LEDGER</button>
            <button class="btn-adv btn-hist" onclick="showHistory()"><i class="fas fa-history"></i> STATEMENT</button>
            <button class="btn-adv btn-demand" onclick="generateSingleDemand()"><i class="fas fa-receipt"></i> THIS SLIP</button>
        </div>
        
        <div id="historySection" class="mt-4"></div>
    </div>

    <div id="demandSlipsPrint" class="demand-slip-container"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="brand.js"></script>
<script src="menu.js"></script>

<script>
    const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];
    let curStu = null;
    let academicRates = {};
    let transRates = {};

    // Load initial configuration
    async function loadRates() {
        const aSnap = await db.collection('fee_master').get();
        aSnap.forEach(doc => academicRates[doc.id] = doc.data());
        const tSnap = await db.collection('transport_master').get();
        tSnap.forEach(doc => transRates[doc.id] = doc.data());
    }
    loadRates();

    async function liveSearch() {
        const val = document.getElementById('searchID').value.toLowerCase();
        const sugg = document.getElementById('searchSuggestions');
        if(val.length < 2) { sugg.style.display='none'; return; }
        const snap = await db.collection('students').get();
        let html = '';
        snap.forEach(doc => {
            const d = doc.data();
            if(d.name.toLowerCase().includes(val) || d.uniqueID.toString().includes(val)) {
                html += `<div class="list-group-item list-group-item-action cursor-pointer" onclick='loadLedger(${JSON.stringify(d)})'>
                            ${d.name} <small class="text-muted">(ID: ${d.uniqueID}, Class: ${d.class})</small>
                         </div>`;
            }
        });
        sugg.innerHTML = html; sugg.style.display='block';
    }

    async function loadLedger(s) {
        curStu = s;
        document.getElementById('searchSuggestions').style.display='none';
        document.getElementById('ledgerArea').style.display='block';
        document.getElementById('demandSlipsPrint').style.display='none';
        
        document.getElementById('lName').innerText = s.name.toUpperCase();
        document.getElementById('lID_badge').innerText = "STU-ID: " + s.uniqueID;
        document.getElementById('lClass').innerText = s.class;
        document.getElementById('lFather').innerText = s.father || "N/A";
        document.getElementById('lTrans').innerText = s.transportDistance || "NONE";
        document.getElementById('lContact').innerText = s.contact || "N/A";
        document.getElementById('lPhoto').src = s.photo || 'https://via.placeholder.com/80x100';

        calculateLedger();
    }

    async function calculateLedger() {
        const s = curStu;
        const fm = academicRates[s.class] || {};
        const tRate = (s.transport === 'Yes') ? (transRates[s.transportDistance]?.amount || 0) : 0;
        
        const transSnap = await db.collection('fee_transactions').where('studentID', '==', String(s.uniqueID)).get();
        let payData = []; transSnap.forEach(d => payData.push(d.data()));

        let html = '', gPay = 0, gPaid = 0, rb = 0;

        // 1. Admission / Annual Row
        const annBase = Number(fm.admission||0) + Number(fm.development||0) + Number(fm.exam||0);
        html += renderRow("ADMISSION/ANNUAL", annBase, "Annual", s.discounts?.Annual || 0);

        // 2. Monthly Rows
        const monthlyBase = Number(fm.tuition||0) + Number(fm.hostel||0) + tRate;
        months.forEach(m => {
            html += renderRow(m, monthlyBase, m, s.discounts?.[m] || 0);
        });

        function renderRow(label, base, payMonth, disc) {
            let net = base - (base * disc / 100);
            let paid = payData.filter(p => p.month === payMonth).reduce((sum, p) => sum + Number(p.amount), 0);
            rb = (rb + net) - paid;
            gPay += net; gPaid += paid;
            return `<tr>
                <td>${label.toUpperCase()}</td>
                <td>₹${base}</td>
                <td><input type="number" class="disc-input no-print" value="${disc}" onchange="updateDiscount('${payMonth}', this.value)"></td>
                <td>₹${net.toFixed(0)}</td>
                <td>₹${paid}</td>
                <td class="${rb > 0 ? 'text-danger' : 'text-success'}">₹${rb.toFixed(0)}</td>
            </tr>`;
        }

        document.getElementById('lBody').innerHTML = html;
        document.getElementById('totalPay').innerText = "₹" + gPay.toFixed(0);
        document.getElementById('totalPaid').innerText = "₹" + gPaid.toFixed(0);
        document.getElementById('totalDue').innerText = "₹" + (gPay - gPaid).toFixed(0);
    }

    async function updateDiscount(month, val) {
        const updatePath = `discounts.${month}`;
        await db.collection('students').doc(curStu.uniqueID.toString()).update({ [updatePath]: Number(val) });
        curStu.discounts = curStu.discounts || {};
        curStu.discounts[month] = Number(val);
        calculateLedger();
    }

    // --- DEMAND SLIP ENGINE ---
    function generateSingleDemand() {
        renderDemandSlips([curStu]);
    }

    async function generateMultiDemandSlips() {
        const selClass = document.getElementById('fClass').value;
        let query = db.collection('students');
        if(selClass !== "All") query = query.where('class', '==', selClass);
        const snap = await query.get();
        let list = []; snap.forEach(doc => list.push(doc.data()));
        renderDemandSlips(list);
    }

    async function renderDemandSlips(students) {
        const printArea = document.getElementById('demandSlipsPrint');
        printArea.innerHTML = "";
        printArea.style.display = "block";
        document.getElementById('ledgerArea').style.display = "none";
        const selMonth = document.getElementById('fMonth').value === "Current" ? months[new Date().getMonth()] : document.getElementById('fMonth').value;

        for (let s of students) {
            // Get balance and last transaction for this student
            const fm = academicRates[s.class] || {};
            const tRate = (s.transport === 'Yes') ? (transRates[s.transportDistance]?.amount || 0) : 0;
            const mBase = Number(fm.tuition||0) + Number(fm.hostel||0) + tRate;
            const disc = s.discounts?.[selMonth] || 0;
            const netM = mBase - (mBase * disc / 100);

            const transSnap = await db.collection('fee_transactions').where('studentID', '==', String(s.uniqueID)).orderBy('timestamp', 'desc').limit(1).get();
            let lastT = transSnap.empty ? "No Payment" : "₹" + transSnap.docs[0].data().amount + " (" + transSnap.docs[0].data().date + ")";

            const slip = document.createElement('div');
            slip.className = "slip-card";
            slip.innerHTML = `
                <div class="slip-header">
                    <img src="logo.png" class="slip-logo">
                    <div>
                        <h6 class="m-0 fw-bold">THE LALIT INTERNATIONAL SCHOOL</h6>
                        <small>Monthly Fee Demand Slip - ${selMonth}</small>
                    </div>
                </div>
                <img src="${s.photo || ''}" class="slip-photo">
                <div style="font-size:12px; margin-bottom:10px;">
                    <b>Name:</b> ${s.name} <br>
                    <b>ID:</b> ${s.uniqueID} | <b>Class:</b> ${s.class} <br>
                    <b>Father:</b> ${s.father}
                </div>
                <table class="table table-bordered table-sm" style="font-size:11px;">
                    <tr class="bg-light"><th>Description</th><th>Amount</th></tr>
                    <tr><td>Current Month Fee (${selMonth})</td><td>₹${netM.toFixed(0)}</td></tr>
                    <tr><td>Previous Arrears (Pending)</td><td class="text-danger fw-bold">₹TBC</td></tr>
                    <tr class="table-dark"><td>TOTAL PAYABLE</td><td>₹TBC</td></tr>
                </table>
                <div style="font-size:10px;"><b>Last Transaction:</b> ${lastT}</div>
                <div class="mt-2 no-print d-flex gap-2">
                    <button class="whatsapp-btn" onclick="sendWA('${s.whatsapp || s.contact}', '${s.name}', '${selMonth}')">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="btn btn-sm btn-dark" onclick="window.print()">Print Slip</button>
                </div>
            `;
            printArea.appendChild(slip);
        }
    }

    function sendWA(num, name, month) {
        const msg = `Dear Parent, this is to inform you that the fee for ${name} for the month of ${month} is due. Please clear it at the earliest. - The Lalit Intl. School`;
        window.open(`https://wa.me/91${num}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    async function showHistory() {
        const transSnap = await db.collection('fee_transactions').where('studentID', '==', String(curStu.uniqueID)).get();
        let h = `<div class="card p-3 shadow-sm border"><h6 class="brand-font">Payment Log History</h6><table class="table table-sm"><thead><tr><th>Date</th><th>Month</th><th>Amount</th><th>Method</th></tr></thead><tbody>`;
        transSnap.forEach(d => { const p = d.data(); h += `<tr><td>${p.date}</td><td>${p.month}</td><td>₹${p.amount}</td><td>${p.method || 'Cash'}</td></tr>`; });
        h += `</tbody></table><button class="btn btn-sm btn-dark no-print" onclick="this.parentElement.remove()">Close History</button></div>`;
        document.getElementById('historySection').innerHTML = h;
    }
</script>
</body>
</html>
