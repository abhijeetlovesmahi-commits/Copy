<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Ledger | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="brand.js"></script>

    <style>
        :root { --royal: #002147; --gold: #D4AF37; }
        .pending-text { color: #f39c12; font-size: 11px; font-weight: bold; display: block; }
        .paid-amount { color: #27ae60; font-weight: bold; }
        .balance-row { background: #fdf2f2; font-weight: bold; }
        table th { background: var(--royal); color: #fff; font-size: 13px; text-transform: uppercase; }
        .summary-card { background: #fff; border-radius: 10px; padding: 15px; border-left: 5px solid var(--gold); }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="container-fluid mt-4">
    <div id="brand-header-container"></div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="summary-card shadow-sm">
                <small class="text-muted">TOTAL PAYABLE</small>
                <h4 id="tPayable">₹0</h4>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card shadow-sm" style="border-left-color: #27ae60;">
                <small class="text-muted">TOTAL PAID</small>
                <h4 id="tPaid" class="text-success">₹0</h4>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card shadow-sm" style="border-left-color: #e74c3c;">
                <small class="text-muted">CURRENT BALANCE</small>
                <h4 id="tBalance" class="text-danger">₹0</h4>
            </div>
        </div>
    </div>

    <div class="table-responsive bg-white shadow-sm p-3 rounded">
        <table class="table table-bordered text-center">
            <thead>
                <tr>
                    <th>Particulars (Month)</th>
                    <th>Tuition</th>
                    <th>Hostel</th>
                    <th>Trans.</th>
                    <th>Annual</th>
                    <th>Total Due</th>
                    <th>Paid</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody id="lBody">
                </tbody>
        </table>
    </div>
</div>

<script>
let curStu = null; 
let fm = {}; 
const months = ["April","May","June","July","August","September","October","November","December","January","February","March"];

// Ye function ID se data nikalne ke liye hai
function getD(id) {
    let el = document.getElementById(id);
    return el ? Number(el.value) : 0;
}

async function init() {
    // 1. Maan lete hain humne URL se Student ID li (Jaise aapke software mein hai)
    const urlParams = new URLSearchParams(window.location.search);
    const sid = urlParams.get('id');
    
    if(!sid) { 
        document.getElementById('lBody').innerHTML = '<tr><td colspan="8">Please select a student first.</td></tr>';
        return; 
    }

    // Student aur Fee Master ka data lana
    const sDoc = await db.collection('students').doc(sid).get();
    curStu = sDoc.data();
    
    const fDoc = await db.collection('fee_master').doc(curStu.class).get();
    fm = fDoc.data();

    calculateLedger();
}

async function calculateLedger() {
    // Discount defaults (Aapke purane code ke hisab se)
    const d = { tui:0, hos:0, tra:0, adm:0, dev:0, exa:0, boo:0, mis:0 };
    if(curStu.discounts) Object.assign(d, curStu.discounts);

    // Calculation Logic
    const netAnnual = (Number(fm.admission||0)*(1-d.adm/100))+(Number(fm.development||0)*(1-d.dev/100))+(Number(fm.exam||0)*(1-d.exa/100))+(Number(fm.books||0)*(1-d.boo/100))+(Number(fm.misc||0)*(1-d.mis/100));
    const tuiNet = Number(fm.tuition||0)*(1-d.tui/100);
    const hosNet = (curStu.hostel==='Yes'?Number(fm.hostel||0):0)*(1-d.hos/100);
    const traNet = (curStu.transport==='Yes'?Number(fm.transport_fee||0):0)*(1-d.tra/100);

    // Transactions fetch karna (New Logic)
    const tSnap = await db.collection('fee_transactions').where('studentID', '==', String(curStu.uniqueID)).get();
    let allPays = []; tSnap.forEach(p => allPays.push(p.data()));

    let html = '', runBal = 0, tPay = 0, tPaid = 0;

    // 1. Registration Row
    let aPaid = allPays.filter(p => p.month === 'Annual' && p.status === 'Paid').reduce((s, p) => s + Number(p.amount), 0);
    let aPending = allPays.filter(p => p.month === 'Annual' && p.status === 'Pending').reduce((s, p) => s + Number(p.amount), 0);
    
    runBal += (netAnnual - aPaid); tPay += netAnnual; tPaid += aPaid;
    html += `<tr>
        <td class="text-start"><b>ANNUAL CHARGES</b> ${aPending > 0 ? `<span class="pending-text">Awaiting Approval: ₹${aPending}</span>` : ''}</td>
        <td>-</td><td>-</td><td>-</td><td>₹${Math.round(netAnnual)}</td>
        <td>₹${Math.round(netAnnual)}</td><td class="paid-amount">₹${aPaid}</td><td>₹${Math.round(runBal)}</td>
    </tr>`;

    // 2. Monthly Rows
    months.forEach(m => {
        let mPaid = allPays.filter(p => p.month === m && p.status === 'Paid').reduce((s, p) => s + Number(p.amount), 0);
        let mPending = allPays.filter(p => p.month === m && p.status === 'Pending').reduce((s, p) => s + Number(p.amount), 0);
        
        let mTotal = tuiNet + hosNet + traNet;
        runBal += (mTotal - mPaid); tPay += mTotal; tPaid += mPaid;
        
        html += `<tr>
            <td class="text-start"><b>${m.toUpperCase()}</b> ${mPending > 0 ? `<span class="pending-text">Awaiting Approval: ₹${mPending}</span>` : ''}</td>
            <td>₹${Math.round(tuiNet)}</td>
            <td>${hosNet? '₹'+Math.round(hosNet) : '-'}</td>
            <td>${traNet? '₹'+Math.round(traNet) : '-'}</td>
            <td>-</td>
            <td>₹${Math.round(mTotal)}</td>
            <td class="paid-amount">₹${mPaid}</td>
            <td>₹${Math.round(runBal)}</td>
        </tr>`;
    });

    document.getElementById('lBody').innerHTML = html;
    document.getElementById('tPayable').innerText = "₹" + Math.round(tPay);
    document.getElementById('tPaid').innerText = "₹" + tPaid;
    document.getElementById('tBalance').innerText = "₹" + Math.round(runBal);
}

window.onload = init;
</script>

<script src="menu.js"></script>
</body>
</html>
