<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Demand Slip | The Lalit Intl.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        :root { --royal: #002147; --gold: #8c7018; --line: #444; }
        body { background: #e9ecef; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Currency-style Micro Pattern for borders */
        .currency-border {
            border: 1px solid var(--line);
            outline: 3px double var(--line);
            outline-offset: -6px;
            padding: 25px;
            background: #fff;
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
            page-break-after: always; /* Har slip naye page par */
        }

        /* Logo Watermark */
        .watermark {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 400px; opacity: 0.06;
            z-index: 0; pointer-events: none;
        }

        .slip-content { position: relative; z-index: 1; }

        .header-line { border-bottom: 2px solid var(--line); margin-bottom: 5px; }
        .sub-line { border-bottom: 1px dashed var(--line); margin-bottom: 15px; }

        .stu-photo { width: 90px; height: 110px; border: 1px solid #000; object-fit: cover; }
        
        .fee-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .fee-table th { background: #f2f2f2; border: 1px solid #000; padding: 5px 10px; font-size: 13px; }
        .fee-table td { border: 1px solid #000; padding: 5px 10px; font-weight: 700; font-size: 14px; }
        
        .total-box { background: #eee; border: 2px solid #000 !important; font-size: 18px; }

        /* Controls Area */
        .controls { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        @media print {
            .no-print { display: none !important; }
            body { background: #fff; margin: 0; padding: 0; }
            .currency-border { margin: 0; border: none; outline: none; border-bottom: 1px dashed #ccc; }
        }
    </style>
</head>
<body>

<div id="menu-container" class="no-print"></div>

<div class="container mt-4">
    <div class="controls no-print">
        <h4 class="mb-3 text-center text-primary fw-bold">BULK DEMAND SLIP GENERATOR</h4>
        <div class="row g-3">
            <div class="col-md-3">
                <label class="small fw-bold">Select Month</label>
                <select id="targetMonth" class="form-select">
                    <option value="April">April</option><option value="May">May</option>
                    <option value="June">June</option><option value="July">July</option>
                    <option value="August">August</option><option value="September">September</option>
                    <option value="October">October</option><option value="November">November</option>
                    <option value="December">December</option><option value="January">January</option>
                    <option value="February">February</option><option value="March">March</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="small fw-bold">Filter Class</label>
                <select id="classFilter" class="form-select">
                    <option value="ALL">ALL CLASSES</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                    </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary w-100 fw-bold" onclick="generateBulk()"><i class="fas fa-sync"></i> GENERATE LIST</button>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-dark w-100 fw-bold" onclick="window.print()"><i class="fas fa-print"></i> PRINT ALL SLIPS</button>
            </div>
        </div>
    </div>

    <div id="bulkContainer"></div>
</div>

<script>
const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];

async function generateBulk() {
    const container = document.getElementById('bulkContainer');
    const selectedClass = document.getElementById('classFilter').value;
    const targetMonth = document.getElementById('targetMonth').value;
    
    container.innerHTML = `<div class="text-center no-print"><h4>Generating Slips, please wait...</h4></div>`;

    let query = db.collection('students');
    if(selectedClass !== "ALL") {
        query = query.where('class', '==', selectedClass);
    }
    
    const stuSnap = await query.get();
    if(stuSnap.empty) {
        container.innerHTML = `<div class="alert alert-warning">No students found for this selection.</div>`;
        return;
    }

    let allHtml = '';
    
    // Fee Master cache to avoid multiple calls
    const fmSnap = await db.collection('fee_master').get();
    let feeMaster = {};
    fmSnap.forEach(doc => feeMaster[doc.id] = doc.data());

    // Fetch All Transactions at once for performance
    const transSnap = await db.collection('fee_transactions').get();
    let allTrans = [];
    transSnap.forEach(t => allTrans.push(t.data()));

    // Transport Master
    const tSnap = await db.collection('transport_master').get();
    let transMaster = {};
    tSnap.forEach(doc => transMaster[doc.id] = doc.data());

    for (const doc of stuSnap.docs) {
        const s = doc.data();
        const fm = feeMaster[s.class] || {};
        const d = s.discounts || {};
        
        // Calculations Logic (Same as ledger)
        const getNet = (base, disc) => Number(base || 0) * (1 - (Number(disc) || 0) / 100);
        let tRate = (s.transport === 'Yes' && transMaster[s.transportDistance]) ? transMaster[s.transportDistance].amount : 0;

        const fees = {
            tui: getNet(fm.tuition, d.tuition),
            hos: s.hostel === 'Yes' ? getNet(fm.hostel, d.hostel) : 0,
            tra: getNet(tRate, d.trans),
            ann: getNet(fm.admission, d.adm) + getNet(fm.development, d.dev) + getNet(fm.exam, d.exam) + getNet(fm.books, d.books) + getNet(fm.misc, d.misc)
        };

        const stuTrans = allTrans.filter(t => t.studentID == String(s.uniqueID));
        
        let prevDues = 0;
        let targetIdx = months.indexOf(targetMonth);
        let annualPaid = stuTrans.filter(p => p.month === 'Annual').reduce((acc, p) => acc + Number(p.amount), 0);
        prevDues += (fees.ann - annualPaid);

        for(let i = 0; i < targetIdx; i++) {
            let mTotal = fees.tui + fees.hos + fees.tra;
            let mPaid = stuTrans.filter(p => p.month === months[i]).reduce((acc, p) => acc + Number(p.amount), 0);
            prevDues += (mTotal - mPaid);
        }

        let currPaid = stuTrans.filter(p => p.month === targetMonth).reduce((acc, p) => acc + Number(p.amount), 0);
        let netPayable = prevDues + (fees.tui + fees.hos + fees.tra) - currPaid;

        // Skip if net payable is 0 (Optional: Remove if you want to print 0 slips too)
        if(netPayable <= 0) continue; 

        // Generate Slip HTML
        allHtml += `
        <div class="currency-border">
            <img src="logo.png" class="watermark">
            <div class="slip-content">
                <div class="d-flex justify-content-between">
                    <div class="d-flex">
                        <img src="logo.png" style="width:60px; height:60px; margin-right:15px;">
                        <div>
                            <h3 class="m-0 fw-800" style="color:var(--royal); font-size:22px;">THE LALIT INTERNATIONAL SCHOOL</h3>
                            <p class="m-0 small fw-bold">SESSION 2025-26 | DEMAND SLIP: ${targetMonth.toUpperCase()}</p>
                        </div>
                    </div>
                    <div class="text-end small">
                        <b>DATE:</b> ${new Date().toLocaleDateString('en-GB')}<br>
                        <b>DUE DATE:</b> 10th ${targetMonth}
                    </div>
                </div>
                <div class="header-line mt-2"></div>
                <div class="sub-line"></div>

                <div class="row">
                    <div class="col-9">
                        <table class="w-100 mb-2" style="font-size:13px;">
                            <tr><td width="100">STUDENT ID:</td><td><b>${s.uniqueID}</b></td><td width="100">CLASS:</td><td><b>${s.class}</b></td></tr>
                            <tr><td>NAME:</td><td><b>${s.name.toUpperCase()}</b></td><td>FATHER:</td><td><b>${s.father || 'N/A'}</b></td></tr>
                            <tr><td>TRANSPORT:</td><td><b>${s.transportDistance || 'NONE'}</b></td><td>STATUS:</td><td><b class="text-success">ACTIVE</b></td></tr>
                        </table>
                    </div>
                    <div class="col-3 text-end">
                        <img src="${s.photo || 'placeholder.png'}" class="stu-photo">
                    </div>
                </div>

                <table class="fee-table">
                    <thead>
                        <tr><th>PARTICULARS / DESCRIPTION</th><th class="text-end">AMOUNT (₹)</th></tr>
                    </thead>
                    <tbody>
                        ${prevDues > 0 ? `<tr><td>PREVIOUS OUTSTANDING BALANCE</td><td class="text-end">${Math.round(prevDues)}</td></tr>` : ''}
                        <tr><td>MONTHLY TUITION FEE</td><td class="text-end">${Math.round(fees.tui)}</td></tr>
                        ${fees.hos > 0 ? `<tr><td>HOSTEL CHARGES</td><td class="text-end">${Math.round(fees.hos)}</td></tr>` : ''}
                        ${fees.tra > 0 ? `<tr><td>TRANSPORTATION FEE</td><td class="text-end">${Math.round(fees.tra)}</td></tr>` : ''}
                        ${currPaid > 0 ? `<tr class="text-primary"><td>LESS: PAID THIS MONTH</td><td class="text-end">(-) ${currPaid}</td></tr>` : ''}
                        <tr class="total-box">
                            <td class="text-end">NET PAYABLE BY 10th:</td>
                            <td class="text-end">₹ ${Math.round(netPayable)}</td>
                        </tr>
                    </tbody>
                </table>
                <p style="font-size:10px; font-style:italic;">* Please ignore if already paid. This is a system-generated document.</p>
                <div class="row mt-4">
                    <div class="col-6"><hr class="mx-4"><center><small>Parent Signature</small></center></div>
                    <div class="col-6"><hr class="mx-4"><center><small>Cashier/Principal</small></center></div>
                </div>
            </div>
        </div>`;
    }
    
    container.innerHTML = allHtml;
}
</script>
</body>
</html>
