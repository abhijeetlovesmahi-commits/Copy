<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Demand Portal | The Lalit Intl.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="auth-guard.js"></script>
    <script src="brand.js"></script>

    <style>
        :root { --royal-blue: #002366; --gold-foil: #a67c00; --soft-gold: #f4e4bc; }
        
        body { background: #f0f2f5; font-family: 'Montserrat', sans-serif; margin: 0; }

        /* Admin UI Styles */
        .admin-panel { 
            max-width: 1100px; margin: 20px auto; background: #fff; padding: 30px; 
            border-radius: 15px; border-top: 6px solid var(--royal-blue);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* Printable Slip Styles */
        .slip-card {
            background: #fff; width: 210mm; height: 148mm; /* A5 Landscape approx */
            padding: 25px 40px; position: relative; overflow: hidden;
            box-sizing: border-box; display: flex; flex-direction: column;
            border-bottom: 1px dashed #ccc; margin: 0 auto;
        }

        .header-section { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid var(--gold-foil); padding-bottom: 10px; margin-bottom: 15px; 
        }

        .school-title { font-family: 'Cinzel', serif; color: var(--royal-blue); font-size: 22px; font-weight: bold; }

        .student-photo-box {
            width: 80px; height: 95px; border: 2px solid var(--gold-foil);
            padding: 2px; border-radius: 4px; background: white;
        }

        .fee-table { width: 100%; border-collapse: collapse; margin-top: 10px; z-index: 2; }
        .fee-table th { background: var(--royal-blue); color: #fff; padding: 6px; border: 1px solid #333; font-size: 11px; }
        .fee-table td { padding: 8px; border: 1px solid #333; font-size: 12px; font-weight: 600; }

        .total-banner { 
            background: var(--royal-blue); color: #fff; 
            padding: 10px 20px; margin-top: auto; display: flex; justify-content: space-between;
            align-items: center; border-left: 8px solid var(--gold-foil);
        }

        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 250px; opacity: 0.05; pointer-events: none;
        }

        @media print {
            .no-print, #menu-container { display: none !important; }
            body { background: white; padding: 0; }
            .slip-card { border-bottom: 1px dashed #000; page-break-after: always; }
        }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="main-content">
    <div class="admin-panel no-print">
        <div class="header" id="brand-header-container"></div>
        
        <h4 class="text-center mb-4 fw-bold text-royal"><i class="fas fa-file-invoice-dollar me-2"></i> FEE DEMAND ADVISORY</h4>
        
        <div class="row g-3">
            <div class="col-md-3">
                <label class="small fw-bold">BILLING MONTH</label>
                <select id="monthSelect" class="form-select border-primary">
                    <option value="April">April</option><option value="May">May</option>
                    <option value="June">June</option><option value="July">July</option>
                    <option value="August">August</option><option value="September">September</option>
                    <option value="October">October</option><option value="November">November</option>
                    <option value="December">December</option><option value="January">January</option>
                    <option value="February">February</option><option value="March">March</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="small fw-bold">CLASS</label>
                <select id="classSelect" class="form-select border-primary">
                    <option value="">All Classes</option>
                    <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
                </select>
            </div>
            <div class="col-md-2">
                <label class="small fw-bold">SECTION</label>
                <select id="sectionSelect" class="form-select border-primary">
                    <option value="">All</option><option value="A">A</option><option value="B">B</option>
                </select>
            </div>
            <div class="col-md-5 d-flex align-items-end gap-2">
                <button class="btn btn-primary flex-grow-1 fw-bold" onclick="generateSlips()">
                    <i class="fas fa-cog me-2"></i>GENERATE SLIPS
                </button>
                <button class="btn btn-dark fw-bold" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>PRINT
                </button>
            </div>
        </div>
    </div>

    <div id="printArea"></div>
</div>

<script>
const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];

async function generateSlips() {
    const area = document.getElementById('printArea');
    const targetMonth = document.getElementById('monthSelect').value;
    const targetClass = document.getElementById('classSelect').value;
    const targetSec = document.getElementById('sectionSelect').value;
    const targetMonthIdx = months.indexOf(targetMonth);

    area.innerHTML = "<div class='text-center mt-5'><i class='fas fa-sync fa-spin fa-2x'></i><br>Calculating Dues...</div>";

    try {
        // Fetch All Data needed for calculation
        const [feeMasterSnap, transSnap, stdSnap] = await Promise.all([
            db.collection('fee_master').get(),
            db.collection('fee_transactions').get(),
            db.collection('students').get()
        ]);

        const feeMaster = {}; 
        feeMasterSnap.forEach(d => feeMaster[d.id] = d.data());

        const transactions = []; 
        transSnap.forEach(d => transactions.push(d.data()));

        let html = "";

        stdSnap.forEach(doc => {
            const s = doc.data();
            // Filters
            if (targetClass && s.class != targetClass) return;
            if (targetSec && s.section != targetSec) return;

            const m = feeMaster[s.class];
            if(!m) return;

            // 1. Calculate Monthly Fee (Tuition + Optional)
            const tuition = Number(m.tuition || 0);
            const hostel = s.hostel === 'Yes' ? Number(m.hostel || 0) : 0;
            const transport = s.transport === 'Yes' ? Number(m.transport || 0) : 0;
            const monthlyTotal = tuition + hostel + transport;

            // 2. Annual Charges (Only in first month or total debt)
            const annualCharges = Number(m.admission || 0) + Number(m.development || 0) + Number(m.exam || 0);

            // 3. Total Demand up to Target Month
            const totalDemand = annualCharges + (monthlyTotal * (targetMonthIdx + 1));

            // 4. Total Paid by student so far
            const totalPaid = transactions
                .filter(t => String(t.studentID) === String(s.uniqueID))
                .reduce((acc, curr) => acc + Number(curr.amount), 0);

            const netDues = totalDemand - totalPaid;

            // Only generate slip if there is a pending balance
            if (netDues > 0) {
                html += `
                <div class="slip-card">
                    <img src="logo.png" class="watermark">
                    <div class="header-section">
                        <img src="logo.png" style="width: 50px;">
                        <div class="text-end">
                            <div class="school-title">THE LALIT INTERNATIONAL SCHOOL</div>
                            <div class="small fw-bold text-muted">FEE DEMAND ADVISORY | SESSION 2025-26</div>
                        </div>
                    </div>

                    <div class="d-flex mb-3">
                        <div class="student-photo-box">
                            <img src="${s.photo || 'https://via.placeholder.com/80'}" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div class="ps-4 flex-grow-1">
                            <h4 class="text-royal fw-bold mb-1">${s.name.toUpperCase()}</h4>
                            <div class="row g-0 small">
                                <div class="col-6"><b>Student ID:</b> ${s.uniqueID}</div>
                                <div class="col-6"><b>Class-Sec:</b> ${s.class}-${s.section}</div>
                                <div class="col-12"><b>Father's Name:</b> ${s.father}</div>
                            </div>
                        </div>
                        <div class="text-end small">
                            <b>Billing Month:</b> ${targetMonth}<br>
                            <b>Date:</b> ${new Date().toLocaleDateString('en-GB')}
                        </div>
                    </div>

                    <table class="fee-table">
                        <thead>
                            <tr><th>DESCRIPTION</th><th class="text-end">AMOUNT (INR)</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Consolidated Dues up to ${targetMonth} (including Tuition & Annual)</td><td class="text-end">₹ ${totalDemand}</td></tr>
                            <tr class="text-success"><td>Total Credit Received (Paid Till Date)</td><td class="text-end">(-) ₹ ${totalPaid}</td></tr>
                        </tbody>
                    </table>

                    <div class="total-banner">
                        <span class="fw-bold">NET OUTSTANDING PAYABLE</span>
                        <span class="fs-3 fw-bold">₹ ${netDues}</span>
                    </div>

                    <div class="mt-3 d-flex justify-content-between align-items-end">
                        <div style="font-size: 10px; color: #666; width: 70%;">
                            * Please clear the dues by 10th of the month to avoid late fine.<br>
                            * This is a computer generated demand advice. Please ignore if already paid.
                        </div>
                        <div class="text-center" style="width: 150px; border-top: 1px solid #000; font-size: 11px; font-weight: bold; padding-top: 5px;">
                            Accountant Office
                        </div>
                    </div>
                </div>
                `;
            }
        });

        area.innerHTML = html || "<div class='alert alert-success text-center mt-5'>All dues are clear for the selected filters!</div>";
    } catch (e) {
        alert("Error: " + e.message);
        area.innerHTML = "";
    }
}
</script>

<script src="menu.js"></script>
</body>
</html>
