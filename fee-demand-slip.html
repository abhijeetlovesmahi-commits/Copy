<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Demand Slip | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="brand.js"></script>

    <style>
        :root { --royal: #002147; --gold: #D4AF37; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        
        /* Branding & Controls */
        .control-panel { background: #fff; padding: 20px; border-bottom: 3px solid var(--gold); margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Professional Slip Styling */
        .slip-card { 
            background: white; width: 100%; max-width: 800px; 
            margin: 0 auto 30px auto; padding: 30px; border: 2px solid #000; 
            page-break-after: always; position: relative;
        }
        
        .fee-table { width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #000; }
        .fee-table th, .fee-table td { border: 1px solid #000; padding: 12px; font-size: 15px; }
        .fee-table th { background: #f8f9fa; text-align: left; font-weight: 800; }
        
        .total-row { background: var(--royal); color: #fff; font-size: 20px; font-weight: bold; }
        
        /* Buttons */
        .btn-gen { background: var(--royal); color: var(--gold); font-weight: bold; border: 2px solid var(--gold); transition: 0.3s; }
        .btn-gen:hover { background: var(--gold); color: #000; }
        .btn-print { background: var(--gold); color: #000; font-weight: bold; border: none; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .slip-card { margin: 0; border: 1px solid #000; padding: 20px; width: 100%; box-shadow: none; }
            .control-panel { display: none; }
        }
    </style>
</head>
<body>

<div id="menu-container" class="no-print"></div>

<div class="control-panel no-print">
    <div class="container">
        <div id="brand-header-container" class="mb-3"></div>
        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="small fw-bold text-uppercase">1. Select Month</label>
                <select id="slipMonth" class="form-select">
                    <option value="April">April</option><option value="May">May</option>
                    <option value="June">June</option><option value="July">July</option>
                    <option value="August">August</option><option value="September">September</option>
                    <option value="October">October</option><option value="November">November</option>
                    <option value="December">December</option><option value="January">January</option>
                    <option value="February">February</option><option value="March">March</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="small fw-bold text-uppercase">2. Class Filter</label>
                <select id="classFilter" class="form-select">
                    <option value="">-- All Classes --</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="small fw-bold text-uppercase">3. Search Student</label>
                <input type="text" id="searchName" class="form-control" placeholder="Type Name or ID..." oninput="liveSearch()">
                <div id="suggestions" class="list-group position-absolute w-25" style="z-index:100; display:none; max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-gen w-100" onclick="startGeneration()"><i class="fas fa-sync-alt"></i> GENERATE</button>
            </div>
            <div class="col-md-2">
                <button class="btn btn-print w-100" onclick="window.print()"><i class="fas fa-print"></i> PRINT SLIPS</button>
            </div>
        </div>
    </div>
</div>

<div id="printArea">
    <div class="text-center mt-5 text-muted no-print">
        <i class="fas fa-receipt fa-5x mb-3" style="color:#ddd"></i>
        <h3>Demand Slip Preview Area</h3>
        <p>Select criteria above and click <b>Generate</b> to see slips.</p>
    </div>
</div>

<script>
// Data Containers
let students = [];
let feeMaster = {};
let transMaster = {};

// 1. Initial Data Load
async function init() {
    const [sS, fS, tS] = await Promise.all([
        db.collection('students').get(),
        db.collection('fee_master').get(),
        db.collection('transport_master').get()
    ]);
    
    sS.forEach(d => students.push(d.data()));
    fS.forEach(d => feeMaster[d.id] = d.data());
    tS.forEach(d => transMaster[d.id] = d.data().amount);

    // Populate Class Dropdown
    const classes = [...new Set(students.map(s => s.class))].sort();
    const cf = document.getElementById('classFilter');
    classes.forEach(c => cf.innerHTML += `<option value="${c}">${c}</option>`);
}

// 2. Search Logic
function liveSearch() {
    const val = document.getElementById('searchName').value.toLowerCase();
    const sugg = document.getElementById('suggestions');
    if(val.length < 1) { sugg.style.display='none'; return; }
    
    let matches = students.filter(s => 
        s.name.toLowerCase().includes(val) || 
        s.uniqueID.toString().includes(val)
    );
    
    sugg.innerHTML = matches.map(s => 
        `<button class="list-group-item list-group-item-action" onclick="setSearch('${s.uniqueID}', '${s.name}')">
            ${s.name} <small class="text-muted">(${s.uniqueID} - Class ${s.class})</small>
        </button>`
    ).join('');
    sugg.style.display = matches.length > 0 ? 'block' : 'none';
}

function setSearch(id, name) {
    document.getElementById('searchName').value = name;
    document.getElementById('searchName').dataset.id = id;
    document.getElementById('suggestions').style.display='none';
}

// 3. Generation Logic
function startGeneration() {
    const month = document.getElementById('slipMonth').value;
    const cls = document.getElementById('classFilter').value;
    const singleId = document.getElementById('searchName').dataset.id;
    const nameInput = document.getElementById('searchName').value;

    let targetList = students;
    
    // Filter Priority: Search > Class > All
    if (nameInput && singleId) {
        targetList = students.filter(s => s.uniqueID.toString() === singleId);
    } else if (cls) {
        targetList = students.filter(s => s.class === cls);
    }

    renderSlips(targetList, month);
}

// 4. Core Render Function (Synced with Ledger)
function renderSlips(list, month) {
    let html = '';
    
    if(list.length === 0) {
        document.getElementById('printArea').innerHTML = '<h4 class="text-center mt-5 text-danger">No Student Found!</h4>';
        return;
    }

    list.forEach(s => {
        const fm = feeMaster[s.class] || {};
        const d = s.discounts || {};

        // Monthly Components (Ledger Logic)
        const tui = (fm.tuition || 0) * (1 - (d.tuition || 0)/100);
        const hos = (s.hostel === 'Yes' ? (fm.hostel || 0) : 0) * (1 - (d.hostel || 0)/100);
        const tra = (s.transport === 'Yes' ? (transMaster[s.transportDistance] || 0) : 0) * (1 - (d.trans || 0)/100);

        // Annual Sync (Only for April)
        let annualTotal = 0;
        let annualRow = '';
        if (month === 'April') {
            const adm = (fm.admission || 0) * (1 - (d.adm || 0)/100);
            const dev = (fm.development || 0) * (1 - (d.dev || 0)/100);
            const exa = (fm.exam || 0) * (1 - (d.exam || 0)/100);
            const boo = (fm.books || 0) * (1 - (d.books || 0)/100);
            const mis = (fm.misc || 0) * (1 - (d.misc || 0)/100);
            
            annualTotal = Math.round(adm + dev + exa + boo + mis);
            if(annualTotal > 0) {
                annualRow = `<tr><td>Registration & Annual Fee (Discounted)</td><td class="text-end">₹${annualTotal}</td></tr>`;
            }
        }

        const netPayable = Math.round(tui + hos + tra + annualTotal);

        html += `
        <div class="slip-card">
            <div class="d-flex justify-content-between border-bottom border-dark pb-2 mb-3">
                <img src="logo.png" style="width:75px; object-fit:contain;">
                <div class="text-center">
                    <h3 class="m-0" style="color:var(--royal); font-weight:900">THE LALIT INTERNATIONAL SCHOOL</h3>
                    <p class="m-0 fw-bold text-uppercase" style="letter-spacing:1px">Fee Demand Slip | ${month} 2026</p>
                </div>
                <div class="text-end small">
                    <b>DATE:</b> ${new Date().toLocaleDateString('en-GB')}<br>
                    <span class="text-muted">Office Copy</span>
                </div>
            </div>

            <div class="row mb-3 px-2 bg-light py-2 border mx-0">
                <div class="col-4">Student ID: <b>${s.uniqueID}</b></div>
                <div class="col-4 text-center">Name: <b>${s.name.toUpperCase()}</b></div>
                <div class="col-4 text-end">Class: <b>${s.class}</b></div>
            </div>

            <table class="fee-table">
                <thead>
                    <tr><th>DESCRIPTION</th><th class="text-end">AMOUNT</th></tr>
                </thead>
                <tbody>
                    <tr><td>Monthly Tuition Fee</td><td class="text-end">₹${Math.round(tui)}</td></tr>
                    ${tra > 0 ? `<tr><td>Transport Fee (Slab: ${s.transportDistance})</td><td class="text-end">₹${Math.round(tra)}</td></tr>` : ''}
                    ${hos > 0 ? `<tr><td>Hostel Charges</td><td class="text-end">₹${Math.round(hos)}</td></tr>` : ''}
                    ${annualRow}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td class="text-end text-uppercase">Net Payable Amount:</td>
                        <td class="text-end">₹${netPayable}</td>
                    </tr>
                </tfoot>
            </table>

            <div class="row mt-5 pt-3">
                <div class="col-6">
                    <p class="small text-muted italic">Note: Please clear all dues before the 10th of the month.</p>
                </div>
                <div class="col-6 d-flex justify-content-between">
                    <div class="text-center" style="width:140px"><hr class="mb-1"><b>Cashier</b></div>
                    <div class="text-center" style="width:140px"><hr class="mb-1"><b>Parent</b></div>
                </div>
            </div>
        </div>`;
    });
    
    document.getElementById('printArea').innerHTML = html;
}

// Initialize on Load
window.onload = init;
</script>

<script src="menu.js"></script>
</body>
</html>
