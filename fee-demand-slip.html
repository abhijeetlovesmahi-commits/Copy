<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Demand Slip | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="brand.js"></script>

    <style>
        :root { --royal: #002147; --gold: #D4AF37; --table-border: #222; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        
        /* Container for multiple slips */
        #slipsContainer { margin-top: 20px; }

        /* Individual Slip Box */
        .slip-box { 
            background: #fff; width: 850px; margin: 30px auto; 
            padding: 40px; border: 1px solid #999; position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            page-break-after: always; /* Har slip naye page par ayegi */
            overflow: hidden;
        }

        /* Currency-style Security Thread */
        .security-thread {
            position: absolute; left: 40px; top: 0; bottom: 0;
            width: 4px; background: repeating-linear-gradient(
                to bottom, #d4af37 0%, #d4af37 5%, #002147 5%, #002147 10%
            );
            opacity: 0.2; pointer-events: none;
        }

        /* Logo Watermark */
        .watermark {
            position: absolute; top: 55%; left: 50%;
            transform: translate(-50%, -50%);
            width: 400px; opacity: 0.06; z-index: 0; pointer-events: none;
        }

        .slip-header { border-bottom: 3px double var(--table-border); padding-bottom: 10px; margin-bottom: 20px; z-index: 1; position: relative; }
        
        .student-info-grid {
            display: grid; grid-template-columns: 110px 1fr 1fr; gap: 20px;
            margin-bottom: 20px; z-index: 1; position: relative;
        }
        .stu-photo { width: 100px; height: 120px; border: 1px solid #333; object-fit: cover; background: #eee; }
        .info-col p { margin: 1px 0; font-size: 13px; border-bottom: 1px dotted #ccc; }
        .info-col b { color: var(--royal); }

        .fee-table { width: 100%; border-collapse: collapse; margin-top: 10px; z-index: 1; position: relative; }
        .fee-table th { background: #f2f2f2; border: 1px solid var(--table-border); padding: 8px; font-size: 13px; }
        .fee-table td { border: 1px solid var(--table-border); padding: 8px; font-weight: 600; font-size: 14px; }
        
        .total-row { background: #fffde7; font-size: 18px; color: #b71c1c; }
        .note-box { border: 1px solid #999; padding: 8px; margin-top: 15px; font-size: 11px; background: #fafafa; }

        @media print {
            .no-print { display: none !important; }
            body { background: #fff; padding: 0; }
            .slip-box { margin: 0; border: none; width: 100%; box-shadow: none; }
            .security-thread { opacity: 0.15; -webkit-print-color-adjust: exact; }
            .watermark { opacity: 0.08; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div id="menu-container" class="no-print"></div>

<div class="container mt-4 no-print">
    <div id="brand-header-container" class="mb-4"></div>
    <div class="card p-4 shadow-sm">
        <h5 class="mb-3"><i class="fas fa-layer-group"></i> Bulk Demand Slip Generator</h5>
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold">Select Class</label>
                <select id="classSelect" class="form-select">
                    <option value="All">All Classes</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                    <option value="1">Class 1</option>
                    <option value="2">Class 2</option>
                    </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Fee Month</label>
                <select id="targetMonth" class="form-select">
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="generateBulk()"><i class="fas fa-sync"></i> GENERATE SLIPS</button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-dark w-100" onclick="window.print()"><i class="fas fa-print"></i> PRINT ALL</button>
            </div>
        </div>
    </div>
</div>

<div id="slipsContainer">
    </div>

<script>
const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];

async function generateBulk() {
    const cls = document.getElementById('classSelect').value;
    const month = document.getElementById('targetMonth').value;
    const container = document.getElementById('slipsContainer');
    container.innerHTML = '<div class="text-center mt-5"><div class="spinner-border"></div><p>Generating slips, please wait...</p></div>';

    let q = db.collection('students');
    if(cls !== "All") q = q.where('class', '==', cls);
    
    const snap = await q.get();
    if(snap.empty) { container.innerHTML = "<p class='text-center mt-5'>No students found!</p>"; return; }

    // Fetch Fee Master for all classes once to save time
    const fmSnap = await db.collection('fee_master').get();
    let feeMasters = {};
    fmSnap.forEach(doc => feeMasters[doc.id] = doc.data());

    // Fetch Transport Master
    const tmSnap = await db.collection('transport_master').get();
    let transRates = {};
    tmSnap.forEach(doc => transRates[doc.id] = doc.data().amount);

    let allHtml = '';

    for(const doc of snap.docs) {
        const s = doc.data();
        const fm = feeMasters[s.class] || {};
        const d = s.discounts || {};
        
        // Fetch Transactions for this student
        const tSnap = await db.collection('fee_transactions').where('studentID', '==', String(s.uniqueID)).get();
        let trans = []; tSnap.forEach(t => trans.push(t.data()));

        // Calculation Logic
        const getNet = (base, disc) => Number(base || 0) * (1 - (Number(disc) || 0) / 100);
        const tRate = (s.transport === 'Yes' && s.transportDistance) ? (transRates[s.transportDistance] || 0) : 0;

        const monthlyFee = getNet(fm.tuition, d.tuition) + (s.hostel === 'Yes' ? getNet(fm.hostel, d.hostel) : 0) + getNet(tRate, d.trans);
        const annualFee = getNet(fm.admission, d.adm) + getNet(fm.development, d.dev) + getNet(fm.exam, d.exam) + getNet(fm.books, d.books) + getNet(fm.misc, d.misc);

        // Previous Dues
        let prevDues = 0;
        let targetIdx = months.indexOf(month);
        let annualPaid = trans.filter(p => p.month === 'Annual').reduce((acc, p) => acc + Number(p.amount), 0);
        prevDues += (annualFee - annualPaid);

        for(let i = 0; i < targetIdx; i++) {
            let mPaid = trans.filter(p => p.month === months[i]).reduce((acc, p) => acc + Number(p.amount), 0);
            prevDues += (monthlyFee - mPaid);
        }

        let currentPaid = trans.filter(p => p.month === month).reduce((acc, p) => acc + Number(p.amount), 0);
        let netPayable = prevDues + monthlyFee - currentPaid;

        // Generate Slip HTML
        allHtml += `
        <div class="slip-box">
            <div class="security-thread"></div>
            <img src="logo.png" class="watermark">
            
            <div class="slip-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <img src="logo.png" style="width:60px; margin-right:15px;">
                    <div>
                        <h3 style="margin:0; color:var(--royal); font-weight:800; letter-spacing: -1px;">THE LALIT INTERNATIONAL SCHOOL</h3>
                        <p class="m-0 small fw-bold">OFFICIAL FEE DEMAND NOTICE | SESSION 2025-26</p>
                    </div>
                </div>
                <div class="text-end">
                    <small><b>MONTH:</b> ${month.toUpperCase()}</small><br>
                    <small><b>DATE:</b> ${new Date().toLocaleDateString('en-GB')}</small>
                </div>
            </div>

            <div class="student-info-grid">
                <img src="${s.photo || 'placeholder.png'}" class="stu-photo">
                <div class="info-col">
                    <p>STUDENT ID: <b>${s.uniqueID}</b></p>
                    <p>NAME: <b>${s.name.toUpperCase()}</b></p>
                    <p>CLASS: <b>${s.class}</b></p>
                </div>
                <div class="info-col">
                    <p>FATHER'S NAME: <b>${(s.father || 'N/A').toUpperCase()}</b></p>
                    <p>TRANSPORT: <b>${s.transportDistance || 'N/A'}</b></p>
                    <p>DUE DATE: <b>10th ${month}</b></p>
                </div>
            </div>

            <table class="fee-table">
                <thead>
                    <tr>
                        <th>PARTICULARS / FEE HEADS</th>
                        <th style="width:180px;" class="text-end">AMOUNT (₹)</th>
                    </tr>
                </thead>
                <tbody>
                    ${prevDues > 0 ? `<tr><td>PREVIOUS OUTSTANDING BALANCE</td><td class="text-end">₹${Math.round(prevDues)}</td></tr>` : ''}
                    <tr><td>TUITION FEE (${month.toUpperCase()})</td><td class="text-end">₹${Math.round(getNet(fm.tuition, d.tuition))}</td></tr>
                    ${s.hostel==='Yes' ? `<tr><td>HOSTEL CHARGES</td><td class="text-end">₹${Math.round(getNet(fm.hostel, d.hostel))}</td></tr>` : ''}
                    ${tRate > 0 ? `<tr><td>TRANSPORTATION FEE</td><td class="text-end">₹${Math.round(getNet(tRate, d.trans))}</td></tr>` : ''}
                    ${currentPaid > 0 ? `<tr class="text-success"><td>LESS: PAID THIS MONTH</td><td class="text-end">- ₹${currentPaid}</td></tr>` : ''}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td class="text-end">TOTAL PAYABLE AMOUNT:</td>
                        <td class="text-end">₹${Math.round(netPayable)}</td>
                    </tr>
                </tfoot>
            </table>

            <div class="note-box">
                <b>Instructions:</b> 1. Please pay by the 10th to avoid late fine. 2. Ignore if already paid. 3. This is an official document generated by the ERP system of The Lalit International School.
            </div>

            <div class="row mt-4">
                <div class="col-6"><br><br><hr class="mx-4"><center><small>Parent Signature</small></center></div>
                <div class="col-6 text-center">
                    <img src="sign.png" style="width:80px; margin-bottom:-10px;">
                    <hr class="mx-4">
                    <small>Authorized Signatory</small>
                </div>
            </div>
        </div>`;
    }

    container.innerHTML = allHtml;
}
</script>
<script src="menu.js"></script>
</body>
</html>
