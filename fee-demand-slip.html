<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Demand Portal | The Lalit Intl.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="style.css"> <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="auth-guard.js"></script>
    <script src="brand.js"></script>

    <style>
        /* Slip Specific Overrides - Taaki print sahi aaye */
        .slip-card {
            background: #fff; width: 210mm; height: 140mm; 
            padding: 20px 35px; position: relative; overflow: hidden;
            box-sizing: border-box; display: flex; flex-direction: column;
            border: 1px solid #eee; border-bottom: 2px dashed #002366; 
            margin: 20px auto; background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
        }

        /* Logo and Watermark Control */
        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            width: 400px; opacity: 0.04; pointer-events: none; z-index: 0;
        }

        .slip-header-logo {
            height: 65px; width: auto; object-fit: contain; z-index: 2;
        }

        .header-section { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid var(--gold); padding-bottom: 10px; margin-bottom: 15px; 
            z-index: 2;
        }

        .fee-table { width: 100%; border-collapse: collapse; margin-top: 10px; z-index: 2; position: relative; }
        .fee-table th { background: var(--royal-blue); color: var(--gold); padding: 8px; border: 1px solid #333; font-size: 11px; }
        .fee-table td { padding: 10px; border: 1px solid #333; font-size: 13px; font-weight: 600; background: rgba(255,255,255,0.8); }

        .total-banner { 
            background: var(--royal-blue); color: var(--gold); 
            padding: 12px 20px; margin-top: auto; display: flex; justify-content: space-between;
            align-items: center; border-left: 10px solid var(--gold); z-index: 2;
        }

        @media print {
            .no-print, #menu-container { display: none !important; }
            body { background: white; padding: 0; }
            .slip-card { margin: 0; border-bottom: 1px dashed #000; page-break-after: always; box-shadow: none; }
            .main-content { padding: 0; }
        }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="main-content">
    <div class="royal-card no-print mb-4">
        <div class="header" id="brand-header-container">
             </div>
        
        <h2 class="brand-font">FEE DEMAND ADVISORY</h2>
        
        <div class="form-section mt-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="section-title">BILLING MONTH</label>
                    <select id="monthSelect">
                        <option value="April">April</option><option value="May">May</option>
                        <option value="June">June</option><option value="July">July</option>
                        <option value="August">August</option><option value="September">September</option>
                        <option value="October">October</option><option value="November">November</option>
                        <option value="December">December</option><option value="January">January</option>
                        <option value="February">February</option><option value="March">March</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="section-title">CLASS</label>
                    <select id="classSelect">
                        <option value="">All Classes</option>
                        <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="section-title">SECTION</label>
                    <select id="sectionSelect">
                        <option value="">All</option><option value="A">A</option><option value="B">B</option>
                    </select>
                </div>
                <div class="col-md-5 d-flex align-items-end gap-2">
                    <button class="royal-btn btn-block" onclick="generateSlips()">
                        <i class="fas fa-cog me-2"></i>GENERATE SLIPS
                    </button>
                    <button class="royal-btn btn-danger" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>PRINT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="printArea" style="width: 100%;"></div>
</div>

<script>
// (Sames logic as your script but with updated HTML structure for the slip)
const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];

async function generateSlips() {
    const area = document.getElementById('printArea');
    const targetMonth = document.getElementById('monthSelect').value;
    const targetClass = document.getElementById('classSelect').value;
    const targetSec = document.getElementById('sectionSelect').value;
    const targetMonthIdx = months.indexOf(targetMonth);

    area.innerHTML = "<div class='text-center mt-5'><i class='fas fa-sync fa-spin fa-2x' style='color:var(--royal-blue)'></i><br>Calculating Dues...</div>";

    try {
        const [feeMasterSnap, transSnap, stdSnap] = await Promise.all([
            db.collection('fee_master').get(),
            db.collection('fee_transactions').get(),
            db.collection('students').get()
        ]);

        const feeMaster = {}; 
        feeMasterSnap.forEach(d => feeMaster[d.id] = d.data());

        const transactions = []; 
        transSnap.forEach(d => transactions.push(d.data()));

        let html = "";

        stdSnap.forEach(doc => {
            const s = doc.data();
            if (targetClass && s.class != targetClass) return;
            if (targetSec && s.section != targetSec) return;

            const m = feeMaster[s.class];
            if(!m) return;

            const tuition = Number(m.tuition || 0);
            const hostel = s.hostel === 'Yes' ? Number(m.hostel || 0) : 0;
            const transport = s.transport === 'Yes' ? Number(m.transport || 0) : 0;
            const monthlyTotal = tuition + hostel + transport;
            const annualCharges = Number(m.admission || 0) + Number(m.development || 0) + Number(m.exam || 0);
            const totalDemand = annualCharges + (monthlyTotal * (targetMonthIdx + 1));
            const totalPaid = transactions
                .filter(t => String(t.studentID) === String(s.uniqueID))
                .reduce((acc, curr) => acc + Number(curr.amount), 0);

            const netDues = totalDemand - totalPaid;

            if (netDues > 0) {
                html += `
                <div class="slip-card">
                    <img src="logo.png" class="watermark">
                    <div class="header-section">
                        <img src="logo.png" class="slip-header-logo">
                        <div class="text-end">
                            <div class="brand-font" style="font-size: 20px;">THE LALIT INTERNATIONAL SCHOOL</div>
                            <div class="small fw-bold text-muted">FEE DEMAND ADVISORY | SESSION 2025-26</div>
                        </div>
                    </div>

                    <div class="d-flex mb-3" style="position:relative; z-index:2;">
                        <div class="id-photo" style="width: 80px; height: 95px; border: 2px solid var(--gold);">
                            <img src="${s.photo || 'https://via.placeholder.com/80'}" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div class="ps-4 flex-grow-1">
                            <h4 style="color:var(--royal-blue); font-weight: bold; margin-bottom: 5px;">${s.name.toUpperCase()}</h4>
                            <div class="row g-0 small">
                                <div class="col-6"><b>ID:</b> ${s.uniqueID}</div>
                                <div class="col-6"><b>Class:</b> ${s.class}-${s.section}</div>
                                <div class="col-12"><b>Father:</b> ${s.father}</div>
                            </div>
                        </div>
                        <div class="text-end small">
                            <b>Month:</b> ${targetMonth}<br>
                            <b>Date:</b> ${new Date().toLocaleDateString('en-GB')}
                        </div>
                    </div>

                    <table class="fee-table">
                        <thead>
                            <tr><th>PARTICULARS / DESCRIPTION</th><th class="text-end">AMOUNT (INR)</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Consolidated Dues up to ${targetMonth} (Tuition + Annual)</td><td class="text-end">₹ ${totalDemand}</td></tr>
                            <tr style="color: #27ae60;"><td>Total Credit Received (Paid Till Date)</td><td class="text-end">(-) ₹ ${totalPaid}</td></tr>
                        </tbody>
                    </table>

                    <div class="total-banner">
                        <span class="fw-bold">NET OUTSTANDING PAYABLE</span>
                        <span class="fs-3 fw-bold">₹ ${netDues}</span>
                    </div>

                    <div class="mt-3 d-flex justify-content-between align-items-end" style="z-index:2;">
                        <div style="font-size: 10px; color: #555; width: 70%; font-style: italic;">
                            * Note: Please clear the dues by 10th of the month.<br>
                            * This is a system generated advice.
                        </div>
                        <div class="text-center" style="width: 150px; border-top: 1px solid var(--royal-blue); font-size: 11px; font-weight: bold; padding-top: 5px; color: var(--royal-blue);">
                            Authorized Signatory
                        </div>
                    </div>
                </div>
                `;
            }
        });

        area.innerHTML = html || "<div class='royal-card text-center mt-5'><h3>All dues are clear!</h3></div>";
    } catch (e) {
        alert("Error: " + e.message);
        area.innerHTML = "";
    }
}
</script>

<script src="menu.js"></script>
</body>
</html>
