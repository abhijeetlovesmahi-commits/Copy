<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lalit - Secure Royal Billing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --royal-blue: #002366; --gold-foil: #a67c00; --soft-gold: #f4e4bc; }
        body { background: #cfd3d6; font-family: 'Montserrat', sans-serif; margin: 0; }

        /* Admin UI matching Logo Theme */
        .admin-panel { 
            max-width: 1000px; margin: 20px auto; background: #fff; padding: 25px; 
            border-radius: 15px; border-top: 6px solid var(--royal-blue);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        /* SLIP DESIGN - Secure & Professional */
        .slip-card {
            background: #fff; width: 210mm; height: 148.5mm; 
            padding: 30px 45px; position: relative; overflow: hidden;
            box-sizing: border-box; display: flex; flex-direction: column;
            border-bottom: 2px dashed #000;
        }

        /* 1. SECURITY WATERMARK - Micro Text */
        .slip-card::before {
            content: "THE LALIT INTERNATIONAL SCHOOL OFFICIAL DOCUMENT THE LALIT INTERNATIONAL SCHOOL OFFICIAL DOCUMENT ";
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            font-size: 5px; color: rgba(0,35,102,0.04); line-height: 14px;
            transform: rotate(-25deg); pointer-events: none; z-index: 0;
        }

        /* 2. CENTRAL EMBOSSED LOGO WATERMARK */
        .central-stamp {
            position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; background: url('logo.png') no-repeat center;
            background-size: contain; opacity: 0.06; z-index: 0; pointer-events: none;
        }

        .header-section { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid var(--gold-foil); padding-bottom: 10px; 
            margin-bottom: 15px; position: relative; z-index: 2; 
        }
        .school-name { font-family: 'Cinzel', serif; color: var(--royal-blue); font-size: 24px; margin: 0; }
        
        /* Golden Ornate Frame for Photo */
        .photo-frame {
            width: 85px; height: 105px; padding: 4px;
            background: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #aa771c);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); border-radius: 3px;
        }
        .student-photo { width: 100%; height: 100%; object-fit: cover; background: white; }

        .student-info { flex-grow: 1; padding-left: 25px; position: relative; z-index: 2; }
        .student-info h3 { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--royal-blue); margin-bottom: 5px; }
        
        .fee-table { width: 100%; border-collapse: collapse; margin-top: 10px; position: relative; z-index: 2; background: rgba(255,255,255,0.6); }
        .fee-table th { background: var(--royal-blue); color: #fff; padding: 8px; border: 1px solid #000; font-size: 11px; text-transform: uppercase; }
        .fee-table td { padding: 6px; border: 1px solid #000; font-size: 10px; font-weight: 700; color: #111; }

        /* Professional Balance Banner */
        .total-banner { 
            background: var(--royal-blue); color: #fff; 
            padding: 12px 25px; margin-top: auto; display: flex; justify-content: space-between;
            align-items: center; border-left: 8px solid var(--gold-foil); position: relative; z-index: 2;
        }
        .total-banner span:first-child { font-size: 13px; letter-spacing: 1px; }
        .total-banner span:last-child { font-family: 'Cinzel', serif; font-size: 28px; color: var(--soft-gold); }

        .cut-line { text-align: center; font-size: 10px; font-weight: bold; color: #555; background: #eee; padding: 2px 0; border-bottom: 1px dashed #000; }

        @media print {
            @page { size: A4 portrait; margin: 0; }
            .no-print { display: none !important; }
            body { background: white; }
            .slip-card { box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="admin-panel no-print">
    <div class="text-center mb-3">
        <img src="logo.png" style="width: 70px;">
        <h2 class="school-name mt-2">THE LALIT INTERNATIONAL SCHOOL</h2>
        <p class="text-muted small">Secure Multi-Slip Demand Portal</p>
    </div>
    
    <div class="row g-2 align-items-end">
        <div class="col-md-3">
            <label class="small fw-bold">Billing Month</label>
            <select id="monthSelect" class="form-select border-primary">
                <script>
                    const mList = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];
                    mList.forEach(m => document.write(`<option value="${m}">${m}</option>`));
                </script>
            </select>
        </div>
        <div class="col-md-2">
            <label class="small fw-bold">Class</label>
            <select id="classSelect" class="form-select border-primary">
                <option value="">All Classes</option>
                <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
            </select>
        </div>
        <div class="col-md-2">
            <label class="small fw-bold">Section</label>
            <select id="sectionSelect" class="form-select border-primary">
                <option value="">All</option><option value="A">A</option><option value="B">B</option><option value="C">C</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="small fw-bold">Search</label>
            <input type="text" id="searchID" class="form-control border-primary" placeholder="Name or ID...">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100 fw-bold" onclick="fetchAndGenerate()"><i class="fas fa-magic"></i> GENERATE</button>
        </div>
    </div>
    <div class="text-center mt-3">
        <button class="btn btn-dark btn-sm" onclick="window.print()">PRINT SLIPS</button>
    </div>
</div>

<div id="printArea"></div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function fetchAndGenerate() {
    const area = document.getElementById('printArea');
    const targetMonth = document.getElementById('monthSelect').value;
    const targetClass = document.getElementById('classSelect').value;
    const targetSec = document.getElementById('sectionSelect').value;
    const searchVal = document.getElementById('searchID').value.toLowerCase();
    
    area.innerHTML = "<h5 class='text-center mt-5'>Processing Financial Secure Records...</h5>";

    const [mSnap, tSnap, sSnap] = await Promise.all([
        db.collection('fee_master').get(),
        db.collection('fee_transactions').get(),
        db.collection('students').get()
    ]);

    const masters = {}; mSnap.forEach(d => masters[d.id] = d.data());
    const allTrans = []; tSnap.forEach(d => allTrans.push(d.data()));
    let html = "";
    const targetMonthIdx = mList.indexOf(targetMonth);

    sSnap.forEach(doc => {
        const s = doc.data();
        if (targetClass && s.class != targetClass) return;
        if (targetSec && s.section != targetSec) return;
        if (searchVal && !s.name.toLowerCase().includes(searchVal)) return;

        const m = masters[s.class];
        if(!m) return;

        const monthlyFee = Number(m.tuition||0) + (s.hostel==='Yes'?Number(m.hostel||0):0) + (s.transport==='Yes'?500:0);
        const annualCharge = Number(m.admission||0) + Number(m.development||0) + Number(m.exam||0);

        let totalDemand = annualCharge + (monthlyFee * (targetMonthIdx + 1));
        let totalPaidOverall = allTrans.filter(t => String(t.studentID) === String(s.uniqueID)).reduce((a, b) => a + Number(b.amount), 0);
        
        let prevDemand = annualCharge + (monthlyFee * targetMonthIdx);
        let prevPaid = allTrans.filter(t => String(t.studentID) === String(s.uniqueID) && mList.indexOf(t.month) < targetMonthIdx && t.month !== "Registration").reduce((a, b) => a + Number(b.amount), 0);
        prevPaid += allTrans.filter(t => String(t.studentID) === String(s.uniqueID) && ["Admission", "Annual", "Registration"].includes(t.month)).reduce((a, b) => a + Number(b.amount), 0);
        
        let arrears = prevDemand - prevPaid;
        let currentMonthPaid = allTrans.filter(t => String(t.studentID) === String(s.uniqueID) && t.month === targetMonth).reduce((a, b) => a + Number(b.amount), 0);
        let netPayable = totalDemand - totalPaidOverall;

        html += `
        <div class="slip-card">
            <div class="central-stamp"></div>
            <div class="header-section">
                <img src="logo.png" style="width: 60px;">
                <div class="text-end">
                    <h2 class="school-name">THE LALIT INTERNATIONAL SCHOOL</h2>
                    <div style="font-weight:600; font-size:10px; color:var(--gold-foil); letter-spacing:1px;">OFFICIAL FINANCIAL STATEMENT | SESSION 2025-26</div>
                </div>
            </div>

            <div class="d-flex position-relative" style="z-index:2;">
                <div class="photo-frame"><img src="${s.photo || ''}" class="student-photo"></div>
                <div class="student-info">
                    <h3>${s.name.toUpperCase()}</h3>
                    <div class="row g-0" style="font-size:12px; color:#111;">
                        <div class="col-4"><b>Student ID:</b> ${s.uniqueID}</div>
                        <div class="col-4"><b>Class-Sec:</b> ${s.class}-${s.section || 'A'}</div>
                        <div class="col-4 text-end"><b>Date:</b> ${new Date().toLocaleDateString('en-GB')}</div>
                        <div class="col-12 mt-1"><b>Father's Name:</b> ${s.father}</div>
                    </div>
                </div>
            </div>

            <table class="fee-table">
                <thead>
                    <tr><th>Ledger Description</th><th class="text-end">Balance (INR)</th></tr>
                </thead>
                <tbody>
                    <tr><td>Previous Consolidated Arrears (Pending)</td><td class="text-end">₹${arrears}</td></tr>
                    <tr><td>Current Month Fees (${targetMonth.toUpperCase()})</td><td class="text-end">₹${monthlyFee}</td></tr>
                    <tr style="color:green; background:rgba(0,128,0,0.05);"><td>Credit Received (Current Payment Cycle)</td><td class="text-end">- ₹${currentMonthPaid}</td></tr>
                </tbody>
            </table>

            <div class="total-banner">
                <span>NET OUTSTANDING BALANCE UP-TO ${targetMonth.toUpperCase()}</span>
                <span>₹${netPayable > 0 ? netPayable : 0}</span>
            </div>

            <div class="mt-2 d-flex justify-content-between align-items-end" style="position:relative; z-index:2;">
                <div style="font-size:9px; color:#444; width:65%; line-height:1.2;">* This is a secure digital record. No physical signature required for demand advisory. Please ignore if already paid.</div>
                <div class="text-center" style="width:140px; border-top:1px solid #000; font-size:10px; font-weight:bold; padding-top:2px;">ADMINISTRATIVE OFFICE</div>
            </div>
        </div>
        <div class="no-print cut-line">✂️ CUT ALONG THIS LINE TO SEPARATE SLIPS</div>
        `;
    });
    area.innerHTML = html || "<h4 class='text-center mt-5'>No Records Found.</h4>";
}
</script>
<script src="menu.js"></script>
</body>
</html>
