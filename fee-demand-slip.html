<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demand Slip Generator | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="brand.js"></script>

    <style>
        :root { --royal: #002147; --gold: #D4AF37; --table-border: #333; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        
        /* Slip Container */
        #slipArea { 
            display: none; background: #fff; width: 800px; margin: 20px auto; 
            padding: 40px; border: 2px solid var(--table-border); position: relative;
        }

        .slip-header { border-bottom: 3px double var(--table-border); padding-bottom: 15px; margin-bottom: 20px; }
        
        /* Watermark */
        #slipArea::before {
            content: "OFFICIAL COPY"; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 80px; color: rgba(0,0,0,0.03); font-weight: bold; z-index: 0; pointer-events: none;
        }

        .student-info-grid {
            display: grid; grid-template-columns: 120px 1fr 1fr; gap: 20px;
            margin-bottom: 25px; align-items: center;
        }
        .stu-photo { width: 110px; height: 130px; border: 1px solid #ccc; object-fit: cover; }
        .info-col p { margin: 2px 0; font-size: 14px; border-bottom: 1px dotted #ccc; }
        .info-col b { color: var(--royal); }

        .fee-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .fee-table th { background: #eee; border: 1px solid var(--table-border); padding: 10px; text-align: left; }
        .fee-table td { border: 1px solid var(--table-border); padding: 10px; font-weight: 600; }
        
        .total-row { background: #f9f9f9; font-size: 18px; color: #d32f2f; }
        .note-box { border: 1px dashed #666; padding: 10px; margin-top: 20px; font-size: 12px; font-style: italic; }

        @media print {
            .no-print { display: none !important; }
            #slipArea { display: block !important; border: 1px solid #000; width: 100%; margin: 0; box-shadow: none; }
            body { background: #fff; }
        }
    </style>
</head>
<body>

<div id="menu-container" class="no-print"></div>

<div class="container mt-4 no-print">
    <div id="brand-header-container" class="mb-4"></div>
    <div class="card p-4 shadow-sm">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-bold">Search Student</label>
                <input type="text" id="searchID" class="form-control" placeholder="Name or ID..." oninput="liveSearch()">
                <div id="searchSuggestions" class="list-group position-absolute w-100" style="z-index: 1000; display:none;"></div>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Select Month</label>
                <select id="targetMonth" class="form-select" onchange="calculateSlip()">
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-dark w-100" onclick="window.print()"><i class="fas fa-print"></i> PRINT SLIP</button>
            </div>
        </div>
    </div>
</div>

<div id="slipArea">
    <div class="slip-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="logo.png" style="width:70px; margin-right:15px;">
            <div>
                <h2 style="margin:0; color:var(--royal); font-weight:800;">THE LALIT INTERNATIONAL SCHOOL</h2>
                <p class="m-0 fw-bold">FEE DEMAND SLIP | SESSION 2025-26</p>
            </div>
        </div>
        <div class="text-end">
            <div class="badge bg-danger mb-1" style="font-size: 12px;">DUE DATE: 10th <span class="selMonth"></span></div><br>
            <small><b>Date:</b> <span id="pDate"></span></small>
        </div>
    </div>

    <div class="student-info-grid">
        <img id="sPhoto" src="" class="stu-photo">
        <div class="info-col">
            <p>ID: <b id="sID"></b></p>
            <p>Name: <b id="sName"></b></p>
            <p>Class: <b id="sClass"></b></p>
        </div>
        <div class="info-col">
            <p>Father's Name: <b id="sFather"></b></p>
            <p>Transport: <b id="sTrans"></b></p>
            <p>Month: <b class="selMonth text-uppercase"></b></p>
        </div>
    </div>

    <table class="fee-table">
        <thead>
            <tr>
                <th>DESCRIPTION / PARTICULARS</th>
                <th style="width: 150px; text-align: right;">AMOUNT (₹)</th>
            </tr>
        </thead>
        <tbody id="slipBody">
            </tbody>
        <tfoot>
            <tr class="total-row">
                <td class="text-end">NET PAYABLE AMOUNT:</td>
                <td class="text-end" id="netPayable">₹0</td>
            </tr>
        </tfoot>
    </table>

    <div class="note-box">
        <b>Note:</b> Please clear the dues before the 10th of every month to avoid a late fee of ₹50 per day. This is a computer-generated demand slip and does not require a physical signature for notification.
    </div>

    <div class="row mt-5">
        <div class="col-6 text-center">
            <br><br>
            <hr class="mx-5">
            <small>Parent/Guardian Signature</small>
        </div>
        <div class="col-6 text-center">
            <img src="sign.png" style="width: 100px; display: block; margin: 0 auto -15px auto;" alt="">
            <hr class="mx-5">
            <small>Authorized Signatory (Accounts)</small>
        </div>
    </div>
</div>

<script>
const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];
let curStu = null;
let fm = {};

async function liveSearch() {
    const val = document.getElementById('searchID').value.toLowerCase();
    const sugg = document.getElementById('searchSuggestions');
    if(val.length < 2) { sugg.style.display='none'; return; }
    const snap = await db.collection('students').get();
    let html = '';
    snap.forEach(doc => {
        const d = doc.data();
        if(d.name.toLowerCase().includes(val) || d.uniqueID.toString().includes(val)) {
            html += `<button class="list-group-item list-group-item-action" onclick='initSlip(${JSON.stringify(d)})'>${d.name} (${d.uniqueID})</button>`;
        }
    });
    sugg.innerHTML = html; sugg.style.display='block';
}

async function initSlip(s) {
    curStu = s;
    document.getElementById('searchSuggestions').style.display='none';
    document.getElementById('slipArea').style.display='block';
    document.getElementById('pDate').innerText = new Date().toLocaleDateString('en-GB');
    
    document.getElementById('sName').innerText = s.name.toUpperCase();
    document.getElementById('sID').innerText = s.uniqueID;
    document.getElementById('sClass').innerText = s.class;
    document.getElementById('sFather').innerText = (s.father || "N/A").toUpperCase();
    document.getElementById('sTrans').innerText = s.transportDistance || "NONE";
    document.getElementById('sPhoto').src = s.photo || 'placeholder.png';

    // Fetch Fee Master for the class
    const fDoc = await db.collection('fee_master').doc(s.class).get();
    fm = fDoc.exists ? fDoc.data() : {};
    
    calculateSlip();
}

async function calculateSlip() {
    if(!curStu) return;
    
    const targetMonth = document.getElementById('targetMonth').value;
    document.querySelectorAll('.selMonth').forEach(el => el.innerText = targetMonth);
    
    // 1. Get Base Fees & Discounts
    const d = curStu.discounts || {};
    const getNet = (base, disc) => Number(base || 0) * (1 - (Number(disc) || 0) / 100);

    // Transport Rate
    let tRate = 0;
    if(curStu.transport === 'Yes' && curStu.transportDistance) {
        const tDoc = await db.collection('transport_master').doc(curStu.transportDistance).get();
        if(tDoc.exists) tRate = tDoc.data().amount;
    }

    const fees = {
        tuition: getNet(fm.tuition, d.tuition),
        hostel: curStu.hostel === 'Yes' ? getNet(fm.hostel, d.hostel) : 0,
        trans: getNet(tRate, d.trans),
        annual: getNet(fm.admission, d.adm) + getNet(fm.development, d.dev) + getNet(fm.exam, d.exam) + getNet(fm.books, d.books) + getNet(fm.misc, d.misc)
    };

    // 2. Fetch Transactions
    const tSnap = await db.collection('fee_transactions').where('studentID', '==', String(curStu.uniqueID)).get();
    let transactions = [];
    tSnap.forEach(p => transactions.push(p.data()));

    // 3. Logic for Previous Dues and Current Month
    let prevDues = 0;
    let targetIdx = months.indexOf(targetMonth);

    // Calculate Annual + Previous Months
    let annualPaid = transactions.filter(p => p.month === 'Annual').reduce((s, p) => s + Number(p.amount), 0);
    prevDues += (fees.annual - annualPaid);

    for(let i = 0; i < targetIdx; i++) {
        let mName = months[i];
        let mTotal = fees.tuition + fees.hostel + fees.trans;
        let mPaid = transactions.filter(p => p.month === mName).reduce((s, p) => s + Number(p.amount), 0);
        prevDues += (mTotal - mPaid);
    }

    // Current Month Calculations
    let currPaid = transactions.filter(p => p.month === targetMonth).reduce((s, p) => s + Number(p.amount), 0);
    
    // 4. Build Table
    let html = '';
    if(prevDues > 0) {
        html += `<tr><td>PREVIOUS OUTSTANDING DUES</td><td class="text-end">₹${Math.round(prevDues)}</td></tr>`;
    }
    
    html += `<tr><td>TUITION FEE (${targetMonth.toUpperCase()})</td><td class="text-end">₹${Math.round(fees.tuition)}</td></tr>`;
    
    if(fees.hostel > 0) 
        html += `<tr><td>HOSTEL CHARGES</td><td class="text-end">₹${Math.round(fees.hostel)}</td></tr>`;
    
    if(fees.trans > 0) 
        html += `<tr><td>TRANSPORTATION FEE</td><td class="text-end">₹${Math.round(fees.trans)}</td></tr>`;

    if(currPaid > 0)
        html += `<tr class="text-success"><td>LESS: PAID AMOUNT (THIS MONTH)</td><td class="text-end">- ₹${Math.round(currPaid)}</td></tr>`;

    document.getElementById('slipBody').innerHTML = html;
    
    // Final Total
    let finalPayable = prevDues + (fees.tuition + fees.hostel + fees.trans) - currPaid;
    document.getElementById('netPayable').innerText = "₹" + Math.round(finalPayable);
}
</script>
<script src="menu.js"></script>
</body>
</html>
