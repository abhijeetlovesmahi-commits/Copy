<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Demand Slip | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="brand.js"></script>

    <style>
        :root { --royal: #002147; --gold: #D4AF37; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .control-panel { background: #fff; padding: 20px; border-bottom: 3px solid var(--gold); margin-bottom: 30px; }
        .slip-card { 
            background: white; width: 100%; max-width: 800px; 
            margin: 0 auto 30px auto; padding: 30px; 
            border: 3px double var(--royal); position: relative;
            background-image: radial-gradient(circle at 2px 2px, rgba(0, 33, 71, 0.03) 1px, transparent 0);
            background-size: 4px 4px; page-break-after: always;
        }
        .slip-header-centered { text-align: center; border-bottom: 2px solid var(--royal); padding-bottom: 10px; margin-bottom: 20px; }
        .slip-header-centered img { width: 75px; }
        .fee-table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid #000; }
        .fee-table th, .fee-table td { border: 1px solid #000; padding: 10px; font-size: 14px; }
        .total-row { background: var(--royal) !important; color: #fff; font-size: 18px; font-weight: bold; }
        #suggestions { position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; }
        @media print { .no-print, #menu-container, .control-panel { display: none !important; } }
    </style>
</head>
<body>

<div id="menu-container" class="no-print"></div>

<div class="control-panel no-print">
    <div class="container">
        <div id="brand-header-container" class="mb-3"></div>
        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="small fw-bold">Select Month</label>
                <select id="slipMonth" class="form-select">
                    <option value="April">April</option><option value="May">May</option>
                    <option value="June">June</option><option value="July">July</option>
                    <option value="August">August</option><option value="September">September</option>
                    <option value="October">October</option><option value="November">November</option>
                    <option value="December">December</option><option value="January">January</option>
                    <option value="February">February</option><option value="March">March</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="small fw-bold">Class Filter</label>
                <select id="classFilter" class="form-select">
                    <option value="">-- All Classes --</option>
                    <option value="Pre-Nursery">Pre-Nursery</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                    <option value="1">Class 1</option><option value="2">Class 2</option>
                    <option value="3">Class 3</option><option value="4">Class 4</option>
                    <option value="5">Class 5</option><option value="6">Class 6</option>
                    <option value="7">Class 7</option><option value="8">Class 8</option>
                    <option value="9">Class 9</option><option value="10">Class 10</option>
                    <option value="11">Class 11</option><option value="12">Class 12</option>
                </select>
            </div>
            <div class="col-md-3 position-relative">
                <label class="small fw-bold">Search Student</label>
                <input type="text" id="searchName" class="form-control" placeholder="Enter Name or ID..." oninput="liveSearch()">
                <div id="suggestions" class="list-group" style="display:none;"></div>
            </div>
            <div class="col-md-2"><button class="btn btn-dark w-100" onclick="startGeneration()">GENERATE</button></div>
            <div class="col-md-2"><button class="btn btn-warning w-100 fw-bold" onclick="window.print()">PRINT</button></div>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script>
let students = []; 

// Student data fetch karna
async function init() {
    const sS = await db.collection('students').get();
    students = [];
    sS.forEach(d => students.push(d.data()));
}

function liveSearch() {
    const val = document.getElementById('searchName').value.toLowerCase();
    const sugg = document.getElementById('suggestions');
    if(val.length < 1) { 
        sugg.style.display='none'; 
        delete document.getElementById('searchName').dataset.id;
        return; 
    }
    
    let matches = students.filter(s => 
        s.name.toLowerCase().includes(val) || 
        s.uniqueID.toString().includes(val)
    );
    
    if(matches.length > 0) {
        sugg.innerHTML = matches.map(s => `
            <button class="list-group-item list-group-item-action py-2" onclick="setSearch('${s.uniqueID}', '${s.name}')">
                <div class="fw-bold">${s.name}</div>
                <small class="text-muted">ID: ${s.uniqueID} | Class: ${s.class}</small>
            </button>`).join('');
        sugg.style.display='block';
    } else {
        sugg.style.display='none';
    }
}

function setSearch(id, name) {
    document.getElementById('searchName').value = name;
    document.getElementById('searchName').dataset.id = id;
    document.getElementById('suggestions').style.display='none';
}

async function startGeneration() {
    const month = document.getElementById('slipMonth').value;
    const cls = document.getElementById('classFilter').value;
    const singleId = document.getElementById('searchName').dataset.id;
    const nameInput = document.getElementById('searchName').value;

    let targetList = [];
    
    // Priority: 1. ID Search, 2. Class Filter, 3. All Students
    if (nameInput && singleId) {
        targetList = students.filter(s => s.uniqueID.toString() === singleId.toString());
    } else if (cls) {
        targetList = students.filter(s => s.class.toString() === cls.toString());
    } else {
        targetList = students;
    }

    if (targetList.length === 0) {
        alert("No students found!");
        return;
    }

    document.getElementById('printArea').innerHTML = "<h4 class='text-center mt-5'><i class='fas fa-spinner fa-spin'></i> Syncing with Ledger Database...</h4>";
    
    let html = '';
    for(let s of targetList) {
        // Seedha Ledger Collection se Balance uthana
        const ledgerDoc = await db.collection('ledger').doc(String(s.uniqueID)).get();
        if(ledgerDoc.exists) {
            const ledgerData = ledgerDoc.data();
            const monthData = ledgerData[month] || {};
            const balance = Number(monthData.balance || 0);

            // Sirf unhi ko dikhao jinka balance 0 se zyada hai
            if(balance > 0) {
                html += `
                <div class="slip-card">
                    <div class="slip-header-centered">
                        <img src="logo.png">
                        <h3 class="m-0" style="color:var(--royal); font-weight:900">THE LALIT INTERNATIONAL SCHOOL</h3>
                        <p class="m-0 fw-bold">FEE DEMAND SLIP | ${month.toUpperCase()} 2026</p>
                    </div>
                    <div class="row mb-3 px-2">
                        <div class="col-4 small text-start">STUDENT ID: <b>${s.uniqueID}</b></div>
                        <div class="col-4 text-center small">NAME: <b>${s.name.toUpperCase()}</b></div>
                        <div class="col-4 text-end small">CLASS: <b>${s.class}</b></div>
                    </div>
                    <table class="fee-table">
                        <thead class="table-light">
                            <tr><th>PARTICULARS / FEE DESCRIPTION</th><th class="text-end">AMOUNT (INR)</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="py-4">
                                    <b>Net Outstanding Balance</b><br>
                                    <span class="text-muted small">Current month dues including any previous carry-forward balance.</span>
                                </td>
                                <td class="text-end py-4 fw-bold">₹${balance.toLocaleString('en-IN')}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td class="text-end">NET PAYABLE AMOUNT:</td>
                                <td class="text-end">₹${balance.toLocaleString('en-IN')}</td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="mt-3 small italic text-muted text-center">
                        * Please ignore if already paid. Detailed breakdown is available in the Master Ledger.
                    </div>
                    <div class="d-flex justify-content-between mt-5 pt-3">
                        <div class="text-center" style="width:180px"><hr class="border-dark">Office Seal / Cashier</div>
                        <div class="text-center" style="width:180px"><hr class="border-dark">Parent / Guardian Signature</div>
                    </div>
                </div>`;
            }
        }
    }
    document.getElementById('printArea').innerHTML = html || "<h4 class='text-center mt-5 text-success'>Great! No pending dues found for selected criteria.</h4>";
}

// Page load par data init karein
window.onload = init;
</script>
<script src="menu.js"></script>
</body>
</html>
