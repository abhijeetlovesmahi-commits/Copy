<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lalit - Fee Demand System</title>
    <style>
        :root { 
            --royal-blue: #002366; 
            --gold: #D4AF37; 
            --danger: #c0392b; 
            --light-gold: #fcf8e3;
        }
        
        body { background: #f0f2f5; margin: 0; padding: 0; font-family: 'Georgia', serif; }

        .main-header {
            background: white; padding: 25px; text-align: center;
            border-bottom: 5px solid var(--gold); box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .main-logo { height: 100px; margin-bottom: 10px; }

        .no-print-zone {
            max-width: 900px; margin: 20px auto;
            background: white; padding: 25px; border-radius: 8px;
            border: 1px solid var(--gold);
        }

        .search-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin: 15px 0; }
        input, select { padding: 12px; border: 1px solid var(--gold); border-radius: 4px; outline: none; }
        
        .btn { padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-gen { background: var(--royal-blue); color: var(--gold); width: 100%; }
        .btn-print { background: var(--gold); color: var(--royal-blue); width: 100%; margin-top: 10px; font-size: 1rem; border: 1px solid var(--royal-blue); }

        /* --- Slip Print Layout --- */
        #printArea { max-width: 800px; margin: 0 auto; }

        .slip-container {
            background: white; padding: 25px; border: 2px solid #000;
            box-sizing: border-box; height: 500px; margin-bottom: 10px;
            page-break-inside: avoid; position: relative;
        }

        .cut-line {
            width: 100%; height: 20px; border-top: 2px dashed #888;
            margin: 15px 0; text-align: center; position: relative;
        }
        .cut-line::after { content: '‚úÇ CUT HERE'; color: #888; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #f0f2f5; padding: 0 10px; font-size: 0.7rem; letter-spacing: 2px; }

        .header-flex { display: flex; align-items: center; border-bottom: 2px solid var(--gold); padding-bottom: 10px; }
        .slip-logo { height: 65px; margin-right: 15px; }
        .student-photo { width: 85px; height: 100px; border: 1px solid var(--gold); margin-left: auto; object-fit: cover; }
        
        .details-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.95rem; }
        .details-table td { padding: 6px; border-bottom: 1px solid #eee; }
        
        .amount-section { background: var(--light-gold); padding: 12px; border: 1px solid var(--gold); }
        .amount-row { font-size: 1.3rem; font-weight: bold; color: var(--danger); display: flex; justify-content: space-between; margin-top: 5px; border-top: 1px solid var(--gold); padding-top: 5px; }

        .footer-signs { display: flex; justify-content: space-between; margin-top: 40px; }

        @media print {
            .no-print-zone, .main-header { display: none; }
            body { background: white; }
            .slip-container { height: 48vh; border: 2px solid black; }
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="main-header no-print">
    <img src="logo.png" class="main-logo" alt="Logo">
    <h1 style="margin:0; color:var(--royal-blue);">THE LALIT INTERNATIONAL SCHOOL</h1>
    <p style="color:var(--gold); font-weight: bold; letter-spacing: 2px;">FEE DEMAND SLIP GENERATOR</p>
</div>

<div class="no-print-zone no-print">
    <div class="search-grid">
        <input type="text" id="searchVal" placeholder="Student ID or Name...">
        <select id="classSelect">
            <option value="">-- All Classes --</option>
            <option value="Pre-Nursery">Pre-Nursery</option>
            <option value="Nursery">Nursery</option>
            <option value="LKG">LKG</option>
            <option value="UKG">UKG</option>
            <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
        </select>
        <button class="btn btn-gen" onclick="processSlips()">GENERATE SLIPS</button>
    </div>
    <button class="btn btn-print" onclick="window.print()">PRINT ALL GENERATED SLIPS</button>
</div>

<div id="printArea"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function processSlips() {
    const searchVal = document.getElementById('searchVal').value.trim().toLowerCase();
    const className = document.getElementById('classSelect').value;
    const printArea = document.getElementById('printArea');
    
    printArea.innerHTML = "<h3 style='text-align:center'>Generating Slips... üñ®Ô∏è</h3>";

    try {
        // Fetch Masters and Transactions in bulk for speed
        const [mSnap, tSnap] = await Promise.all([
            db.collection('fee_master').get(),
            db.collection('fee_transactions').get()
        ]);

        const masters = {};
        mSnap.forEach(doc => masters[doc.id] = doc.data());

        const payments = {};
        tSnap.forEach(doc => {
            const d = doc.data();
            payments[d.studentID] = (payments[d.studentID] || 0) + Number(d.amount);
        });

        const sSnap = await db.collection('students').get();
        printArea.innerHTML = "";
        let count = 0;

        sSnap.forEach(doc => {
            const s = doc.data();
            const sid = String(s.uniqueID).toLowerCase();
            const sName = (s.name || "").toLowerCase();

            let match = false;
            if (searchVal) {
                if (sid.includes(searchVal) || sName.includes(searchVal)) match = true;
            } else if (className) {
                if (s.class === className) match = true;
            } else {
                match = true;
            }

            if (match && masters[s.class]) {
                const m = masters[s.class];
                let expected = Number(m.tuition || 0) + Number(m.admission || 0);
                if(s.hostel === 'Yes') expected += Number(m.hostel || 0);
                if(s.transport === 'Yes') expected += Number(m.transport || 0);
                
                const balance = expected - (payments[s.uniqueID] || 0);

                if(balance > 0) {
                    renderSlip(s, expected, (payments[s.uniqueID] || 0), balance);
                    count++;
                    if (count % 2 === 0) printArea.innerHTML += `<div class="cut-line no-print"></div>`;
                }
            }
        });

        if(count === 0) printArea.innerHTML = "<h3 style='color:red; text-align:center;'>No Pending Dues Found.</h3>";

    } catch (e) {
        alert("Error: " + e.message);
    }
}

function renderSlip(student, expected, paid, balance) {
    const slipHtml = `
    <div class="slip-container">
        <div class="header-flex">
            <img src="logo.png" class="slip-logo">
            <div>
                <h2 style="margin:0; color:var(--royal-blue); font-size: 1.3rem;">THE LALIT INTERNATIONAL SCHOOL</h2>
                <div style="background:var(--royal-blue); color:var(--gold); display:inline-block; padding:2px 8px; font-weight:bold; font-size:0.7rem;">FEE DEMAND NOTICE</div>
            </div>
            <img src="${student.photo || 'https://via.placeholder.com/80'}" class="student-photo">
        </div>

        <table class="details-table">
            <tr><td><b>ID:</b> ${student.uniqueID}</td><td style="text-align:right;"><b>Date:</b> ${new Date().toLocaleDateString()}</td></tr>
            <tr><td><b>Name:</b> ${student.name}</td><td style="text-align:right;"><b>Class:</b> ${student.class}</td></tr>
            <tr><td colspan="2"><b>Father's Name:</b> ${student.father}</td></tr>
        </table>

        <div class="amount-section">
            <div style="display:flex; justify-content:space-between; font-size:0.9rem;"><span>Current Session Dues:</span> <span>‚Çπ${expected}</span></div>
            <div style="display:flex; justify-content:space-between; color:green; font-size:0.9rem;"><span>Amount Received:</span> <span>- ‚Çπ${paid}</span></div>
            <div class="amount-row"><span>NET BALANCE DUE:</span> <span>‚Çπ${balance}</span></div>
        </div>

        <p style="font-size: 0.75rem; text-align:center; color:#555; margin-top:10px;">Note: Please clear the dues to avoid any inconvenience.</p>

        <div class="footer-signs">
            <div style="border-top:1px solid #000; width:140px; text-align:center; font-size:0.8rem;">Parent Signature</div>
            <div style="border-top:1px solid #000; width:140px; text-align:center; font-size:0.8rem;">Accountant</div>
        </div>
    </div>`;
    
    document.getElementById('printArea').innerHTML += slipHtml;
}
</script>
<script src="menu.js"></script>
</body>
</html>
