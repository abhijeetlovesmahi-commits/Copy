<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Bulk Demand Slip | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="brand.js"></script>
    <script src="menu.js"></script> 

    <style>
        :root { --royal: #002147; --gold: #D4AF37; --table-border: #111; }
        body { background: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Menu Container specific styling */
        #menu-container { width: 100%; position: relative; z-index: 9999; }

        #slipsContainer { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px; }

        .slip-box { 
            background: #fff; width: 100%; max-width: 800px; height: 485px; 
            margin: 5px auto; padding: 25px 35px; border: 1px solid #ccc; position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); overflow: hidden;
        }

        .security-thread {
            position: absolute; left: 25px; top: 0; bottom: 0; width: 3px;
            background: repeating-linear-gradient(to bottom, var(--gold) 0%, var(--gold) 5%, var(--royal) 5%, var(--royal) 10%);
            opacity: 0.15; z-index: 2;
        }

        .watermark {
            position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; opacity: 0.05; z-index: 0; pointer-events: none;
        }

        .slip-header { border-bottom: 2px solid var(--table-border); padding-bottom: 8px; margin-bottom: 12px; z-index: 3; position: relative; }
        
        .student-info-grid {
            display: grid; grid-template-columns: 85px 1fr 1fr; gap: 15px;
            margin-bottom: 12px; z-index: 3; position: relative;
        }
        .stu-photo { width: 80px; height: 95px; border: 1px solid #444; object-fit: cover; background: #fafafa; padding: 2px; }
        .info-col p { margin: 0; font-size: 12px; line-height: 1.6; border-bottom: 1px dotted #ddd; }
        .info-col b { color: var(--royal); font-weight: 700; }

        .fee-table { width: 100%; border-collapse: collapse; z-index: 3; position: relative; margin-top: 5px; }
        .fee-table th { background: #f8f9fa; border: 1px solid var(--table-border); padding: 5px 10px; font-size: 11px; text-transform: uppercase; }
        .fee-table td { border: 1px solid var(--table-border); padding: 5px 10px; font-weight: 600; font-size: 13px; color: #333; }
        
        .total-row { background: #fffde7 !important; font-size: 16px !important; color: #c62828; }
        .note-box { border: 1px dashed #999; padding: 6px; margin-top: 10px; font-size: 10px; background: #fff; line-height: 1.2; }

        .sig-container { position: relative; height: 45px; }
        #authSignPreview { width: 90px; height: auto; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); }

        @media print {
            .no-print { display: none !important; }
            body { background: #fff; padding: 0; margin: 0; }
            #slipsContainer { display: block; padding: 0; }
            .slip-box { 
                margin: 0; border: 1px solid #eee; width: 100%; height: 50%; 
                box-shadow: none; page-break-inside: avoid;
            }
            .slip-box:nth-of-type(2n) { page-break-after: always; }
        }
    </style>
</head>
<body>

<div id="menu-container" class="no-print"></div>

<div class="container mt-4 no-print">
    <div id="brand-header-container" class="mb-4"></div>
    <div class="card p-4 shadow-sm border-0" style="border-radius: 15px;">
        <h5 class="mb-4 text-center text-primary"><i class="fas fa-print"></i> Bulk Slip Control Center</h5>
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label fw-bold small">1. Select Class</label>
                <select id="classSelect" class="form-select shadow-sm">
                    <option value="All">All Classes</option>
                    <option value="Pre-Nursery">Pre-Nursery</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                    <script>
                        for(let i=1; i<=12; i++) {
                            document.write(`<option value="${i}">Class ${i}</option>`);
                        }
                    </script>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold small">2. Billing Month</label>
                <select id="targetMonth" class="form-select shadow-sm">
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold small">3. Authority Signature</label>
                <input type="file" id="sigInput" class="form-control shadow-sm" accept="image/*" onchange="handleSignature(this)">
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
                <button class="btn btn-primary flex-grow-1 shadow" onclick="generateBulk()">GENERATE</button>
                <button class="btn btn-dark shadow" onclick="window.print()"><i class="fas fa-print"></i></button>
            </div>
        </div>
    </div>
</div>

<div id="slipsContainer"></div>

<script>
const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];
let globalSign = ""; 

function handleSignature(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) { globalSign = e.target.result; };
        reader.readAsDataURL(input.files[0]);
    }
}

async function generateBulk() {
    const cls = document.getElementById('classSelect').value;
    const month = document.getElementById('targetMonth').value;
    const container = document.getElementById('slipsContainer');
    
    container.innerHTML = `<div class="w-100 text-center mt-5"><div class="spinner-border text-primary"></div><p class="mt-2">Processing Data...</p></div>`;

    let q = db.collection('students');
    if(cls !== "All") q = q.where('class', '==', cls);
    
    const snap = await q.get();
    if(snap.empty) { container.innerHTML = "<div class='alert alert-warning mt-5 w-50 mx-auto text-center'>No student records found!</div>"; return; }

    const fmSnap = await db.collection('fee_master').get();
    let feeMasters = {};
    fmSnap.forEach(doc => feeMasters[doc.id] = doc.data());

    const tmSnap = await db.collection('transport_master').get();
    let transRates = {};
    tmSnap.forEach(doc => transRates[doc.id] = doc.data().amount);

    let allHtml = '';

    for(const doc of snap.docs) {
        const s = doc.data();
        const fm = feeMasters[s.class] || {};
        const d = s.discounts || {};
        
        const tSnap = await db.collection('fee_transactions').where('studentID', '==', String(s.uniqueID)).get();
        let trans = []; tSnap.forEach(t => trans.push(t.data()));

        const getNet = (base, disc) => Number(base || 0) * (1 - (Number(disc) || 0) / 100);
        const tRate = (s.transport === 'Yes' && s.transportDistance) ? (transRates[s.transportDistance] || 0) : 0;

        const monthlyFee = getNet(fm.tuition, d.tuition) + (s.hostel === 'Yes' ? getNet(fm.hostel, d.hostel) : 0) + getNet(tRate, d.trans);
        const annualFee = getNet(fm.admission, d.adm) + getNet(fm.development, d.dev) + getNet(fm.exam, d.exam) + getNet(fm.books, d.books) + getNet(fm.misc, d.misc);

        let prevDues = 0;
        let targetIdx = months.indexOf(month);
        let annualPaid = trans.filter(p => p.month === 'Annual').reduce((acc, p) => acc + Number(p.amount), 0);
        prevDues += (annualFee - annualPaid);

        for(let i = 0; i < targetIdx; i++) {
            let mPaid = trans.filter(p => p.month === months[i]).reduce((acc, p) => acc + Number(p.amount), 0);
            prevDues += (monthlyFee - mPaid);
        }

        let currentPaid = trans.filter(p => p.month === month).reduce((acc, p) => acc + Number(p.amount), 0);
        let netPayable = prevDues + monthlyFee - currentPaid;

        allHtml += `
        <div class="slip-box">
            <div class="security-thread"></div>
            <img src="logo.png" class="watermark">
            <div class="slip-header d-flex justify-content-between align-items-end">
                <div class="d-flex align-items-center">
                    <img src="logo.png" style="width:50px; margin-right:12px;">
                    <div>
                        <h4 style="margin:0; color:var(--royal); font-weight:900; letter-spacing: -0.5px; font-size: 20px;">VIDYA INTERNATIONAL SCHOOL</h4>
                        <p class="m-0 fw-bold text-muted" style="font-size: 10px;">FEE DEMAND SLIP | ACADEMIC SESSION 2025-26</p>
                    </div>
                </div>
                <div class="text-end" style="line-height: 1.2;">
                    <b style="font-size:12px;">${month.toUpperCase()}</b><br>
                    <small style="font-size:9px;">DATE: ${new Date().toLocaleDateString('en-GB')}</small>
                </div>
            </div>
            <div class="student-info-grid">
                <img src="${s.photo || 'placeholder.png'}" class="stu-photo">
                <div class="info-col">
                    <p>ID: <b>${s.uniqueID}</b></p>
                    <p>STUDENT: <b>${s.name.toUpperCase()}</b></p>
                    <p>CLASS: <b>${s.class}</b></p>
                </div>
                <div class="info-col">
                    <p>FATHER: <b>${(s.father || 'N/A').toUpperCase()}</b></p>
                    <p>TRANSPORT: <b>${s.transportDistance || 'N/A'}</b></p>
                    <p>DUE DATE: <b class="text-danger">10th ${month}</b></p>
                </div>
            </div>
            <table class="fee-table">
                <thead>
                    <tr><th>Fee Descriptions</th><th class="text-end">Amount (₹)</th></tr>
                </thead>
                <tbody>
                    ${prevDues > 0 ? `<tr><td>PREVIOUS BALANCE (DUE)</td><td class="text-end">₹${Math.round(prevDues)}</td></tr>` : ''}
                    <tr><td>TUITION FEE (${month.toUpperCase()})</td><td class="text-end">₹${Math.round(getNet(fm.tuition, d.tuition))}</td></tr>
                    ${s.hostel==='Yes' ? `<tr><td>HOSTEL CHARGES</td><td class="text-end">₹${Math.round(getNet(fm.hostel, d.hostel))}</td></tr>` : ''}
                    ${tRate > 0 ? `<tr><td>TRANSPORTATION FEE</td><td class="text-end">₹${Math.round(getNet(tRate, d.trans))}</td></tr>` : ''}
                    ${currentPaid > 0 ? `<tr class="text-success"><td>LESS: ALREADY PAID THIS MONTH</td><td class="text-end">- ₹${currentPaid}</td></tr>` : ''}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td class="text-end">NET PAYABLE AMOUNT:</td>
                        <td class="text-end">₹${Math.round(netPayable)}</td>
                    </tr>
                </tfoot>
            </table>
            <div class="note-box">
                <b>Terms:</b> Please clear the dues by the 10th of every month. Late fine of ₹50/day will be applicable thereafter. This is a system-generated notice.
            </div>
            <div class="row mt-3">
                <div class="col-6 text-center"><br><hr class="mx-4 mb-0"><small style="font-size:10px;">Parent/Guardian Signature</small></div>
                <div class="col-6 text-center">
                    <div class="sig-container">
                        ${globalSign ? `<img src="${globalSign}" id="authSignPreview">` : ''}
                    </div>
                    <hr class="mx-4 mb-0">
                    <small style="font-size:10px;">Authorized Signatory</small>
                </div>
            </div>
        </div>`;
    }
    container.innerHTML = allHtml;
}
</script>
</body>
</html>
