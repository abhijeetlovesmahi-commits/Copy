<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lalit - Fee Demand Slip</title>
    <style>
        :root {
            --royal-blue: #002366;
            --gold: #D4AF37;
            --white: #ffffff;
            --danger: #c0392b;
        }

        body {
            background: #f4f4f4;
            margin: 0;
            padding: 20px;
            font-family: 'Georgia', serif;
        }

        .no-print-zone {
            max-width: 600px;
            margin: 0 auto 20px auto;
            background: white;
            padding: 20px;
            border: 1px solid var(--gold);
            text-align: center;
        }

        input {
            padding: 10px;
            width: 60%;
            border: 1px solid var(--gold);
            outline: none;
        }

        .btn {
            padding: 10px 20px;
            background: var(--royal-blue);
            color: var(--gold);
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        /* Slip Design */
        #demandSlip {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border: 5px double var(--gold);
            display: none;
            position: relative;
        }

        .slip-header {
            text-align: center;
            border-bottom: 2px solid var(--royal-blue);
            margin-bottom: 20px;
        }

        .slip-title {
            background: var(--royal-blue);
            color: var(--gold);
            display: inline-block;
            padding: 5px 20px;
            margin-top: 10px;
            font-weight: bold;
        }

        .details-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .details-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .amount-row {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--danger);
        }

        .footer-note {
            margin-top: 30px;
            font-size: 0.9rem;
            font-style: italic;
            color: #555;
            text-align: center;
        }

        @media print {
            .no-print-zone { display: none; }
            body { background: white; padding: 0; }
            #demandSlip { display: block !important; border: 2px solid #000; width: 100%; }
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="no-print-zone">
    <h3>Generate Demand Slip</h3>
    <input type="number" id="slipID" placeholder="Enter Student ID">
    <button class="btn" onclick="generateSlip()">GENERATE</button>
    <button class="btn" style="background:var(--danger); color:white;" onclick="window.print()">PRINT / SAVE PDF</button>
</div>

<div id="demandSlip">
    <div class="slip-header">
        <h1 style="margin:0; color:var(--royal-blue);">THE LALIT INTERNATIONAL SCHOOL</h1>
        <p style="margin:5px 0;">Official Fee Reminder / Demand Slip</p>
        <div class="slip-title">FEES DUE NOTICE</div>
    </div>

    <table class="details-table">
        <tr>
            <td><b>Date:</b> <span id="dDate"></span></td>
            <td><b>Student ID:</b> <span id="dID"></span></td>
        </tr>
        <tr>
            <td><b>Student Name:</b> <span id="dName"></span></td>
            <td><b>Class:</b> <span id="dClass"></span></td>
        </tr>
        <tr>
            <td colspan="2"><b>Father's Name:</b> <span id="dFather"></span></td>
        </tr>
    </table>

    <div style="margin-top:30px;">
        <h4 style="border-bottom: 1px solid var(--gold);">OUTSTANDING BALANCE DETAILS</h4>
        <table class="details-table">
            <tr>
                <td>Total Fee Applicable (Yearly/Current):</td>
                <td style="text-align:right;">₹<span id="dTotalApplicable">0</span></td>
            </tr>
            <tr>
                <td>Total Amount Paid Till Date:</td>
                <td style="text-align:right; color:green;">- ₹<span id="dPaid">0</span></td>
            </tr>
            <tr class="amount-row">
                <td>NET PAYABLE BALANCE:</td>
                <td style="text-align:right;">₹<span id="dBalance">0</span></td>
            </tr>
        </table>
    </div>

    <div class="footer-note">
        <p>Kindly ignore this slip if the payment has already been made. Please clear the dues at the earliest to avoid any late fine or inconvenience.</p>
        <div style="margin-top:40px; display:flex; justify-content: space-between;">
            <span>Parent's Signature</span>
            <span>Accountant's Signature</span>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function generateSlip() {
    const id = document.getElementById('slipID').value;
    if(!id) return;

    // Fetch Student
    const sDoc = await db.collection('students').doc(id).get();
    if(!sDoc.exists) return alert("Student not found!");
    const student = sDoc.data();

    // Fetch Master
    const mDoc = await db.collection('fee_master').doc(student.class).get();
    if(!mDoc.exists) return alert("Master Fee not set for this class!");
    const master = mDoc.data();

    // Fetch Total Paid
    const tSnap = await db.collection('fee_transactions').where('studentID', '==', Number(id)).get();
    let paid = 0;
    tSnap.forEach(doc => paid += Number(doc.data().amount));

    // Calculation
    let expected = (master.admission || 0) + (master.tuition || 0) + (master.development || 0);
    if(student.hostel === 'Yes') expected += (master.hostel || 0);
    if(student.transport === 'Yes') expected += (master.transport || 0);

    const balance = expected - paid;

    // Fill UI
    document.getElementById('dDate').innerText = new Date().toLocaleDateString();
    document.getElementById('dID').innerText = student.uniqueID;
    document.getElementById('dName').innerText = student.name;
    document.getElementById('dClass').innerText = student.class;
    document.getElementById('dFather').innerText = student.father;
    document.getElementById('dTotalApplicable').innerText = expected;
    document.getElementById('dPaid').innerText = paid;
    document.getElementById('dBalance').innerText = balance;

    document.getElementById('demandSlip').style.display = 'block';
}
</script>
</body>
</html>
