<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demand Slip Generator | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="brand.js"></script>

    <style>
        :root { --royal: #002147; --gold: #D4AF37; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        
        /* Control Panel */
        .control-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
        
        /* Slip Styling */
        .slip-container { 
            background: white; 
            width: 100%; 
            max-width: 800px; 
            margin: 0 auto 20px auto; 
            padding: 20px; 
            border: 2px solid #000; 
            position: relative;
            page-break-after: always;
        }
        
        .slip-header { border-bottom: 2px solid var(--royal); padding-bottom: 10px; margin-bottom: 15px; }
        .fee-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .fee-table th, .fee-table td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 13px; }
        .fee-table th { background: #f2f2f2; }
        
        .total-box { background: var(--royal); color: #fff; padding: 10px; text-align: right; font-weight: bold; font-size: 18px; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .slip-container { margin: 0; border: 1px solid #000; }
        }
    </style>
</head>
<body>

<div id="menu-container" class="no-print"></div>

<div class="container mt-4 no-print">
    <div id="brand-header-container"></div>
    
    <div class="control-card">
        <h4 class="mb-3 text-center" style="color:var(--royal)">Demand Slip Control Panel</h4>
        <div class="row g-3">
            <div class="col-md-3">
                <label>Select Month</label>
                <select id="slipMonth" class="form-select">
                    <option value="April">April</option><option value="May">May</option>
                    <option value="June">June</option><option value="July">July</option>
                    <option value="August">August</option><option value="September">September</option>
                    <option value="October">October</option><option value="November">November</option>
                    <option value="December">December</option><option value="January">January</option>
                    <option value="February">February</option><option value="March">March</option>
                </select>
            </div>
            <div class="col-md-3">
                <label>Filter Class</label>
                <select id="classFilter" class="form-select" onchange="generateSlips('class')">
                    <option value="">-- All Classes --</option>
                    </select>
            </div>
            <div class="col-md-3">
                <label>Search Student</label>
                <input type="text" id="searchName" class="form-control" placeholder="Type Name/ID..." oninput="liveSearch()">
                <div id="suggestions" class="list-group position-absolute w-25" style="z-index:100"></div>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary w-100" onclick="window.print()"><i class="fas fa-print"></i> Print All Slips</button>
            </div>
        </div>
    </div>
</div>

<div id="printArea">
    </div>

<script>
let studentsData = [];
let feeMasterData = {};
let transportMasterData = {};

async function init() {
    // 1. Fetch Data
    const sSnap = await db.collection('students').get();
    sSnap.forEach(doc => studentsData.push(doc.data()));

    const fSnap = await db.collection('fee_master').get();
    fSnap.forEach(doc => feeMasterData[doc.id] = doc.data());

    const tSnap = await db.collection('transport_master').get();
    tSnap.forEach(doc => transportMasterData[doc.id] = doc.data().amount);

    // Populate Class Filter
    const classes = [...new Set(studentsData.map(s => s.class))];
    const cf = document.getElementById('classFilter');
    classes.forEach(c => cf.innerHTML += `<option value="${c}">${c}</option>`);
}

function liveSearch() {
    const val = document.getElementById('searchName').value.toLowerCase();
    const sugg = document.getElementById('suggestions');
    if(val.length < 2) { sugg.style.display='none'; return; }
    
    let matches = studentsData.filter(s => s.name.toLowerCase().includes(val) || s.uniqueID.toString().includes(val));
    sugg.innerHTML = matches.map(s => `<button class="list-group-item list-group-item-action" onclick="generateSlips('single', '${s.uniqueID}')">${s.name} (${s.uniqueID})</button>`).join('');
    sugg.style.display='block';
}

async function generateSlips(type, id = null) {
    document.getElementById('suggestions').style.display='none';
    const month = document.getElementById('slipMonth').value;
    const filter = document.getElementById('classFilter').value;
    const printArea = document.getElementById('printArea');
    printArea.innerHTML = '<h5 class="text-center no-print">Generating Slips...</h5>';

    let list = studentsData;
    if(type === 'class' && filter) list = studentsData.filter(s => s.class === filter);
    if(type === 'single') list = studentsData.filter(s => s.uniqueID.toString() === id.toString());

    let html = '';
    for(let s of list) {
        const fm = feeMasterData[s.class] || {};
        const disc = s.discounts || {};
        
        // Calculation matching Ledger Logic
        const tui = (fm.tuition || 0) * (1 - (disc.tuition || 0)/100);
        const hos = (s.hostel === 'Yes' ? (fm.hostel || 0) : 0) * (1 - (disc.hostel || 0)/100);
        const tra = (s.transport === 'Yes' ? (transportMasterData[s.transportDistance] || 0) : 0) * (1 - (disc.trans || 0)/100);
        
        const total = Math.round(tui + hos + tra);

        html += `
        <div class="slip-container">
            <div class="slip-header d-flex justify-content-between align-items-center">
                <img src="logo.png" style="width:60px">
                <div class="text-center">
                    <h5 class="m-0" style="color:var(--royal); font-weight:800">THE LALIT INTERNATIONAL SCHOOL</h5>
                    <p class="m-0 small">FEE DEMAND SLIP - ${month.toUpperCase()} 2026</p>
                </div>
                <div class="text-end small"><b>ID:</b> ${s.uniqueID}<br><b>Class:</b> ${s.class}</div>
            </div>
            
            <div class="row small mb-3">
                <div class="col-6"><b>Student:</b> ${s.name}</div>
                <div class="col-6 text-end"><b>Father:</b> ${s.father || 'N/A'}</div>
            </div>

            <table class="fee-table">
                <thead><tr><th>Fee Description</th><th class="text-end">Amount</th></tr></thead>
                <tbody>
                    <tr><td>Monthly Tuition Fee (After Discount)</td><td class="text-end">₹${Math.round(tui)}</td></tr>
                    ${hos > 0 ? `<tr><td>Hostel Charges</td><td class="text-end">₹${Math.round(hos)}</td></tr>` : ''}
                    ${tra > 0 ? `<tr><td>Transport Charges (${s.transportDistance})</td><td class="text-end">₹${Math.round(tra)}</td></tr>` : ''}
                </tbody>
            </table>

            <div class="total-box">NET PAYABLE: ₹${total}</div>
            
            <div class="mt-4 d-flex justify-content-between small">
                <span>Date: ${new Date().toLocaleDateString()}</span>
                <span>Signature: _________________</span>
            </div>
            <p class="text-center mt-3" style="font-size:10px; color:#666 border-top:1px dashed #ccc">Note: Please pay the fees by the 10th of every month.</p>
        </div>`;
    }
    printArea.innerHTML = html;
}

init();
</script>
<script src="menu.js"></script>
</body>
</html>
