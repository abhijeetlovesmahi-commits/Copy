<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defaulter List | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="brand.js"></script>

    <style>
        :root { --royal: #002147; --gold: #D4AF37; }
        
        /* Defaulter Specific UI */
        .defaulter-img { 
            width: 45px; height: 45px; border-radius: 50%; 
            object-fit: cover; border: 1px solid var(--royal); 
        }
        
        .action-btns .btn { border-radius: 20px; font-weight: bold; font-size: 12px; }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-call { background: #007bff; color: white; }
        
        #reportArea { 
            background: #fff; width: 1000px; margin: 20px auto; 
            padding: 30px; border: 1px solid #000; box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        @media print {
            .no-print { display: none !important; }
            #reportArea { width: 100%; border: none; margin: 0; padding: 0; }
            .btn-group { display: none; }
        }
    </style>
</head>
<body>

<div id="menu-container" class="no-print"></div>

<div class="container mt-4 no-print">
    <div id="brand-header-container" class="mb-4"></div>

    <div class="card p-4 shadow-sm border-0" style="background: #f8f9fa;">
        <div class="row align-items-end">
            <div class="col-md-4">
                <label class="fw-bold small">SELECT CLASS</label>
                <select id="fClass" class="form-select border-dark">
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                    <script>
                        for(let i=1; i<=12; i++) {
                            document.write(`<option value="${i}${i==1?'st':i==2?'nd':i==3?'rd':'th'}">${i}${i==1?'st':i==2?'nd':i==3?'rd':'th'}</option>`);
                        }
                    </script>
                </select>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">SELECT MONTH</label>
                <select id="fMonth" class="form-select border-dark">
                    <option value="April">April</option><option value="May">May</option>
                    <option value="June">June</option><option value="July">July</option>
                    <option value="August">August</option><option value="September">September</option>
                    <option value="October">October</option><option value="November">November</option>
                    <option value="December">December</option><option value="January">January</option>
                    <option value="February">February</option><option value="March">March</option>
                </select>
            </div>
            <div class="col-md-4">
                <button class="btn btn-dark w-100 fw-bold" onclick="generateList()">
                    <i class="fas fa-search me-2"></i> SEARCH DEFAULTERS
                </button>
            </div>
        </div>
    </div>
</div>

<div id="reportArea">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <img src="logo.png" style="width:60px; margin-right:15px;">
            <div>
                <h2 style="margin:0; color:var(--royal); font-weight:800;">THE LALIT INTERNATIONAL SCHOOL</h2>
                <p class="m-0 fw-bold text-danger" id="reportTitle">FEE DEFAULTER STATEMENT</p>
            </div>
        </div>
        <button class="btn btn-outline-dark no-print" onclick="window.print()">PRINT</button>
    </div>

    <table class="table table-bordered align-middle">
        <thead class="table-light">
            <tr class="small text-center">
                <th>PHOTO</th>
                <th class="text-start">STUDENT NAME</th>
                <th>FATHER'S NAME</th>
                <th>MONTHLY FEE</th>
                <th class="no-print">ACTIONS</th>
            </tr>
        </thead>
        <tbody id="defTableBody">
            <tr>
                <td colspan="5" class="text-center py-5">Please select filters to generate list.</td>
            </tr>
        </tbody>
    </table>
</div>

<script src="menu.js"></script>

<script>
async function generateList() {
    const selClass = document.getElementById('fClass').value;
    const selMonth = document.getElementById('fMonth').value;
    const tbody = document.getElementById('defTableBody');
    
    tbody.innerHTML = `<tr><td colspan="5" class="text-center">Scanning database...</td></tr>`;

    try {
        // 1. Get Fee Master for the class
        const fMaster = await db.collection('fee_master').doc(selClass).get();
        const baseFee = fMaster.exists ? (fMaster.data().tuition || 0) : 0;

        // 2. Get Students
        const stuSnap = await db.collection('students').where('class', '==', selClass).get();
        
        // 3. Get Paid Transactions for this month
        const transSnap = await db.collection('fee_transactions')
                            .where('month', '==', selMonth)
                            .get();
        
        const paidSet = new Set();
        transSnap.forEach(t => paidSet.add(String(t.data().studentID)));

        let html = '';
        let count = 0;

        stuSnap.forEach(doc => {
            const s = doc.data();
            if (!paidSet.has(String(s.uniqueID))) {
                count++;
                const phone = s.mobile || "";
                const msg = `Dear Parent, fee for ${s.name} for ${selMonth} is still pending. Kindly deposit at the earliest. - The Lalit Intl.`;

                html += `
                <tr class="text-center">
                    <td><img src="${s.photo || ''}" class="defaulter-img" onerror="this.src='https://via.placeholder.com/45'"></td>
                    <td class="text-start">
                        <div class="fw-bold">${s.name.toUpperCase()}</div>
                        <small>ID: ${s.uniqueID}</small>
                    </td>
                    <td>${s.father || 'N/A'}</td>
                    <td class="fw-bold text-danger">â‚¹${baseFee}</td>
                    <td class="no-print action-btns">
                        <a href="tel:${phone}" class="btn btn-call btn-sm me-1"><i class="fas fa-phone"></i></a>
                        <a href="https://wa.me/91${phone}?text=${encodeURIComponent(msg)}" target="_blank" class="btn btn-whatsapp btn-sm"><i class="fab fa-whatsapp"></i></a>
                    </td>
                </tr>`;
            }
        });

        tbody.innerHTML = count > 0 ? html : `<tr><td colspan="5" class="text-center py-4 text-success fw-bold">No Defaulters Found!</td></tr>`;
        document.getElementById('reportTitle').innerText = `FEE DEFAULTER LIST: ${selClass.toUpperCase()} - ${selMonth.toUpperCase()}`;

    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${e.message}</td></tr>`;
    }
}
</script>

</body>
</html>
