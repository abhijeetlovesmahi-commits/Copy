<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defaulter Registry | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="auth-guard.js"></script> 
    <script src="brand.js"></script>

    <style>
        :root { --royal: #002147; --gold: #D4AF37; --danger: #e74c3c; }
        .summary-cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        .stat-card-def {
            background: white; border: 1px solid var(--gold); border-radius: 12px;
            padding: 25px; text-align: center; box-shadow: var(--shadow-sm);
            border-bottom: 5px solid var(--danger);
        }
        .stat-card-def h2 { color: var(--danger); font-size: 2.2rem; margin: 10px 0 0; font-family: 'Cinzel', serif; }
        .stat-card-def p { color: var(--royal); font-weight: bold; text-transform: uppercase; font-size: 0.8rem; margin: 0; }
        
        .whatsapp-btn {
            background: #25D366; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.3s;
            display: inline-flex; align-items: center; gap: 8px; text-decoration: none; font-size: 13px;
        }
        .whatsapp-btn:hover { background: #128C7E; transform: scale(1.05); color: white; }
        .loader-container { text-align: center; padding: 100px 0; color: var(--gold); }
        
        @media print {
            .no-print, #menu-container, .whatsapp-btn { display: none !important; }
            .main-content { margin: 0 !important; padding: 0 !important; }
            .royal-card { border: none !important; box-shadow: none !important; }
            table { font-size: 10px; }
        }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="main-content">
    <div class="royal-card">
        <div class="header" id="brand-header-container"></div>

        <div class="d-flex justify-content-between align-items-center mb-4 no-print">
            <h2 class="brand-font" style="color: var(--royal); margin: 0;">
                <i class="fas fa-exclamation-triangle me-2" style="color: var(--danger);"></i>FEES DEFAULTER REGISTRY
            </h2>
            <div class="d-flex gap-2">
                <select id="uptoMonth" class="form-select form-select-sm" onchange="generateDefaulterList()">
                    <option value="March">Upto End of Session</option>
                    </select>
                <button class="royal-btn btn-sm" onclick="window.print()">
                    <i class="fas fa-print me-1"></i> PRINT
                </button>
            </div>
        </div>

        <div class="summary-cards">
            <div class="stat-card-def">
                <p>Total Students in Arrears</p>
                <h2 id="totalCount">0</h2>
            </div>
            <div class="stat-card-def">
                <p>Estimated Pending Amount</p>
                <h2 id="totalPending">₹0</h2>
            </div>
        </div>

        <div id="loading" class="loader-container">
            <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
            <p>Scanning Financial Ledgers for Arrears...</p>
        </div>

        <div id="defaulterWrapper" style="display:none;">
            <div style="overflow-x: auto;">
                <table class="table table-bordered">
                    <thead>
                        <tr style="background: var(--royal); color: var(--gold);">
                            <th>ADM ID</th>
                            <th>STUDENT NAME</th>
                            <th>CLASS</th>
                            <th>PARENT NAME</th>
                            <th>BALANCE DUE</th>
                            <th class="no-print">RECOVERY</th>
                        </tr>
                    </thead>
                    <tbody id="listBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const monthsArr = ["April","May","June","July","August","September","October","November","December","January","February","March"];

async function generateDefaulterList() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('defaulterWrapper').style.display = 'none';

    try {
        const [masterSnap, studentSnap, transSnap] = await Promise.all([
            db.collection('fee_master').get(),
            db.collection('students').get(),
            db.collection('fee_transactions').where('status', '==', 'Paid').get()
        ]);

        const masters = {};
        masterSnap.forEach(doc => masters[doc.id] = doc.data());

        const payments = {};
        transSnap.forEach(doc => {
            const d = doc.data();
            payments[d.studentID] = (payments[d.studentID] || 0) + Number(d.amount);
        });

        let grandTotal = 0;
        let count = 0;
        const tbody = document.getElementById('listBody');
        tbody.innerHTML = "";

        // Default target is March (End of Session)
        const targetMonth = document.getElementById('uptoMonth').value;
        const targetIdx = monthsArr.indexOf(targetMonth);

        studentSnap.forEach(doc => {
            const s = doc.data();
            const fm = masters[s.class];

            if (fm) {
                const d = s.discounts || { tui:0, hos:0, tra:0, adm:0, dev:0, exa:0, boo:0, mis:0 };

                // 1. Annual Charges with Discounts
                const annual = 
                    (Number(fm.admission||0)*(1-(d.adm||0)/100)) + 
                    (Number(fm.development||0)*(1-(d.dev||0)/100)) + 
                    (Number(fm.exam||0)*(1-(d.exa||0)/100)) + 
                    (Number(fm.books||0)*(1-(d.boo||0)/100)) + 
                    (Number(fm.misc||0)*(1-(d.mis||0)/100));

                // 2. Monthly Charges with Discounts
                const tuiNet = Number(fm.tuition||0)*(1-(d.tui||0)/100);
                const hosNet = (s.hostel === 'Yes' ? Number(fm.hostel||0) : 0) * (1-(d.hos||0)/100);
                const traNet = (s.transport === 'Yes' ? Number(s.transport_fee||0) : 0) * (1-(d.tra||0)/100);

                const monthlyTotal = tuiNet + hosNet + traNet;
                const expectedTotal = annual + (monthlyTotal * (targetIdx + 1));

                const paid = payments[s.uniqueID] || 0;
                const balance = Math.round(expectedTotal - paid);

                if (balance > 10) { // Threshold to avoid minor rounding differences
                    count++;
                    grandTotal += balance;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td class="text-center">${s.uniqueID}</td>
                            <td><b>${s.name.toUpperCase()}</b></td>
                            <td class="text-center">${s.class}</td>
                            <td>${s.father || 'N/A'}</td>
                            <td class="text-center text-danger fw-bold">₹ ${balance.toLocaleString('en-IN')}</td>
                            <td class="no-print text-center">
                                <button class="whatsapp-btn" onclick="sendWhatsApp('${s.contact || s.pContact}', '${s.name}', '${balance}')">
                                    <i class="fab fa-whatsapp"></i> REMIND
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
        });

        document.getElementById('totalCount').innerText = count;
        document.getElementById('totalPending').innerText = "₹" + Math.round(grandTotal).toLocaleString('en-IN');
        document.getElementById('loading').style.display = 'none';
        document.getElementById('defaulterWrapper').style.display = 'block';

    } catch (error) {
        console.error(error);
        alert("System Error: Could not sync with financial ledgers.");
    }
}

function sendWhatsApp(phone, name, amount) {
    if(!phone || phone === 'undefined' || phone === '') return alert("Contact number not found for this student!");
    const msg = `*THE LALIT INTERNATIONAL SCHOOL*%0A%0A*FEE REMINDER*%0A%0ADear Parent, this is a formal reminder that an amount of *₹${amount}* is pending for student *${name}*. Please clear the dues at the earliest to avoid late charges.%0A%0A_Ignore if already paid._`;
    window.open(`https://wa.me/91${phone}?text=${msg}`, '_blank');
}

generateDefaulterList();
</script>

<script src="menu.js"></script>

</body>
</html>
