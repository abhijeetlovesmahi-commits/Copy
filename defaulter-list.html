<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lalit - Defaulter List</title>
    <style>
        :root {
            --royal-blue: #002366;
            --gold: #D4AF37;
            --deep-gold: #aa8a2e;
            --light-gold: #FDFBF0;
            --white: #ffffff;
            --danger: #e74c3c;
        }

        body {
            background: var(--light-gold);
            margin: 0;
            padding: 20px;
            font-family: 'Georgia', serif;
            color: var(--royal-blue);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--white);
            padding: 30px;
            border: 1px solid var(--gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            border-bottom: 3px double var(--gold);
            margin-bottom: 30px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            padding: 20px;
            text-align: center;
            border: 1px solid var(--gold);
            background: #fff;
        }

        .card h2 { margin: 0; font-size: 1.8rem; color: var(--danger); }
        .card p { margin: 5px 0; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: var(--royal-blue);
            color: var(--gold);
            padding: 12px;
            border: 1px solid var(--gold);
        }

        td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        tr:nth-child(even) { background: #fefcf0; }

        .btn-remind {
            background: var(--danger);
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .loader { text-align: center; padding: 50px; font-style: italic; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>DEFAULTER LIST</h1>
        <p>THE LALIT INTERNATIONAL SCHOOL - RECOVERY DASHBOARD</p>
    </div>

    <div class="summary-cards">
        <div class="card">
            <p>Total Defaulters</p>
            <h2 id="totalCount">0</h2>
        </div>
        <div class="card">
            <p>Total Pending Amount</p>
            <h2 id="totalPending">₹0</h2>
        </div>
    </div>

    <div id="loading" class="loader">Calculating dues... Please wait...</div>

    <table id="defaulterTable" style="display:none;">
        <thead>
            <tr>
                <th>Student ID</th>
                <th>Name</th>
                <th>Class</th>
                <th>Father's Name</th>
                <th>Contact</th>
                <th>Pending Amount</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="listBody"></tbody>
    </table>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function generateDefaulterList() {
    try {
        // 1. Fetch all Masters, Students, and Transactions
        const masterSnap = await db.collection('fee_master').get();
        const studentSnap = await db.collection('students').get();
        const transSnap = await db.collection('fee_transactions').get();

        const masters = {};
        masterSnap.forEach(doc => masters[doc.id] = doc.data());

        const transactions = {};
        transSnap.forEach(doc => {
            const d = doc.data();
            transactions[d.studentID] = (transactions[d.studentID] || 0) + Number(d.amount);
        });

        let totalDues = 0;
        let count = 0;
        const tbody = document.getElementById('listBody');
        tbody.innerHTML = "";

        studentSnap.forEach(doc => {
            const s = doc.data();
            const m = masters[s.class];

            if (m) {
                // Calculate Expected Total
                let expected = (m.admission || 0) + (m.tuition || 0) + (m.development || 0);
                if(s.hostel === 'Yes') expected += (m.hostel || 0);
                if(s.transport === 'Yes') expected += (m.transport || 0);

                const paid = transactions[s.uniqueID] || 0;
                const balance = expected - paid;

                if (balance > 0) {
                    count++;
                    totalDues += balance;
                    
                    const row = `
                        <tr>
                            <td>${s.uniqueID}</td>
                            <td><b>${s.name}</b></td>
                            <td>${s.class}</td>
                            <td>${s.father}</td>
                            <td>${s.contact}</td>
                            <td style="color:red; font-weight:bold;">₹${balance}</td>
                            <td><button class="btn-remind" onclick="alert('Reminder sent to ${s.contact}')">REMIND</button></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            }
        });

        document.getElementById('totalCount').innerText = count;
        document.getElementById('totalPending').innerText = "₹" + totalDues;
        document.getElementById('loading').style.display = 'none';
        document.getElementById('defaulterTable').style.display = 'table';

    } catch (error) {
        console.error(error);
        alert("Data load karne mein problem hui!");
    }
}

generateDefaulterList();
</script>
</body>
</html>
