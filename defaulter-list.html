<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Defaulter List | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="brand.js"></script>

    <style>
        :root { --royal: #002147; --gold: #D4AF37; --danger: #d32f2f; }
        body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }

        /* Dashboard Cards */
        .stat-card {
            background: var(--royal); color: #fff; border-radius: 10px;
            padding: 20px; text-align: center; border-bottom: 5px solid var(--gold);
        }
        .stat-card h2 { font-weight: 800; font-size: 32px; margin: 0; color: var(--gold); }
        .stat-card p { margin: 0; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }

        /* Compact Table */
        .defaulter-table { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .defaulter-table thead { background: var(--royal); color: #fff; }
        .defaulter-table th { font-size: 11px; text-transform: uppercase; padding: 12px; font-weight: 600; border: none; }
        .defaulter-table td { font-size: 13px; vertical-align: middle; padding: 6px 12px; border-bottom: 1px solid #eee; font-weight: 500; }

        /* Nano Photo Styling */
        .nano-photo { 
            width: 30px; height: 30px; border-radius: 50%; object-fit: cover; 
            border: 1px solid #ddd; background: #eee;
        }

        /* Action Buttons */
        .btn-call { color: #2ecc71; background: #eafaf1; border: none; padding: 5px 10px; border-radius: 4px; transition: 0.3s; }
        .btn-wa { color: #25d366; background: #e9fbf0; border: none; padding: 5px 10px; border-radius: 4px; transition: 0.3s; }
        .btn-call:hover { background: #2ecc71; color: #fff; }
        .btn-wa:hover { background: #25d366; color: #fff; }

        .due-tag { color: var(--danger); font-weight: 800; background: #ffebee; padding: 2px 8px; border-radius: 12px; font-size: 12px; }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div id="menu-container" class="no-print"></div>

<div class="container mt-4">
    <div id="brand-header-container" class="mb-4"></div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <div class="stat-card">
                <p>Total Estimated Outstanding (Entire School)</p>
                <h2 id="totalSchoolDue">₹0</h2>
            </div>
        </div>
    </div>

    <div class="card p-3 mb-4 shadow-sm border-0 no-print">
        <div class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label small fw-bold">Select Class</label>
                <select id="classSelect" class="form-select border-0 bg-light shadow-sm">
                    <option value="All">All Classes</option>
                    <option value="Pre-Nursery">Pre-Nursery</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                    <script>
                        for(let i=1; i<=12; i++) {
                            document.write(`<option value="${i}">Class ${i}</option>`);
                        }
                    </script>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold">Due Till Month</label>
                <select id="targetMonth" class="form-select border-0 bg-light shadow-sm">
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                </select>
            </div>
            <div class="col-md-4">
                <button class="btn btn-dark w-100 fw-bold" onclick="generateList()">
                    <i class="fas fa-search"></i> FETCH DEFAULTERS
                </button>
            </div>
        </div>
    </div>

    <div class="defaulter-table table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>Photo</th>
                    <th>ID / Name</th>
                    <th>Father's Name</th>
                    <th>Class</th>
                    <th>Phone</th>
                    <th class="text-end">Default Amount</th>
                    <th class="no-print">Connect</th>
                </tr>
            </thead>
            <tbody id="listBody">
                </tbody>
        </table>
    </div>
</div>

<script>
const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];

// Initial Load: Calculate Global School Dues
window.onload = () => { calculateGlobalDues(); };

async function calculateGlobalDues() {
    const month = document.getElementById('targetMonth').value;
    const stuSnap = await db.collection('students').get();
    const fmSnap = await db.collection('fee_master').get();
    const tmSnap = await db.collection('transport_master').get();

    let feeMasters = {}; fmSnap.forEach(d => feeMasters[d.id] = d.data());
    let transRates = {}; tmSnap.forEach(d => transRates[d.id] = d.data().amount);

    let schoolTotal = 0;

    for(const doc of stuSnap.docs) {
        const s = doc.data();
        schoolTotal += await calculateStudentDue(s, month, feeMasters, transRates);
    }
    document.getElementById('totalSchoolDue').innerText = "₹" + Math.round(schoolTotal).toLocaleString('en-IN');
}

async function calculateStudentDue(s, month, feeMasters, transRates) {
    const fm = feeMasters[s.class] || {};
    const d = s.discounts || {};
    const getNet = (base, disc) => Number(base || 0) * (1 - (Number(disc) || 0) / 100);
    const tRate = (s.transport === 'Yes' && s.transportDistance) ? (transRates[s.transportDistance] || 0) : 0;

    const monthlyFee = getNet(fm.tuition, d.tuition) + (s.hostel === 'Yes' ? getNet(fm.hostel, d.hostel) : 0) + getNet(tRate, d.trans);
    const annualFee = getNet(fm.admission, d.adm) + getNet(fm.development, d.dev) + getNet(fm.exam, d.exam) + getNet(fm.books, d.books) + getNet(fm.misc, d.misc);

    const tSnap = await db.collection('fee_transactions').where('studentID', '==', String(s.uniqueID)).get();
    let trans = []; tSnap.forEach(t => trans.push(t.data()));

    let totalDue = 0;
    let targetIdx = months.indexOf(month);

    // Annual
    let annualPaid = trans.filter(p => p.month === 'Annual').reduce((acc, p) => acc + Number(p.amount), 0);
    totalDue += (annualFee - annualPaid);

    // Months
    for(let i = 0; i <= targetIdx; i++) {
        let mPaid = trans.filter(p => p.month === months[i]).reduce((acc, p) => acc + Number(p.amount), 0);
        totalDue += (monthlyFee - mPaid);
    }
    return totalDue > 0 ? totalDue : 0;
}

async function generateList() {
    const cls = document.getElementById('classSelect').value;
    const month = document.getElementById('targetMonth').value;
    const body = document.getElementById('listBody');
    body.innerHTML = '<tr><td colspan="7" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';

    const fmSnap = await db.collection('fee_master').get();
    let feeMasters = {}; fmSnap.forEach(d => feeMasters[d.id] = d.data());
    const tmSnap = await db.collection('transport_master').get();
    let transRates = {}; tmSnap.forEach(d => transRates[d.id] = d.data().amount);

    let q = db.collection('students');
    if(cls !== 'All') q = q.where('class', '==', cls);
    const snap = await q.get();

    let html = '';
    let rowsFound = 0;

    for(const doc of snap.docs) {
        const s = doc.data();
        const due = await calculateStudentDue(s, month, feeMasters, transRates);

        if(due > 1) { // Only show those with balance > 1 Rupee
            rowsFound++;
            const phone = s.phone || s.mobile || "";
            const waMsg = `Dear Parent, your ward ${s.name}'s school fee of ₹${Math.round(due)} is pending for the month of ${month}. Please ignore if already paid. - The Lalit Intl.`;
            
            html += `
            <tr>
                <td><img src="${s.photo || 'placeholder.png'}" class="nano-photo"></td>
                <td><small class="text-muted d-block">${s.uniqueID}</small><b>${s.name.toUpperCase()}</b></td>
                <td>${(s.father || 'N/A').toUpperCase()}</td>
                <td><span class="badge bg-secondary">${s.class}</span></td>
                <td>${phone}</td>
                <td class="text-end"><span class="due-tag">₹${Math.round(due)}</span></td>
                <td class="no-print">
                    <div class="d-flex gap-2">
                        <a href="tel:${phone}" class="btn-call"><i class="fas fa-phone-alt"></i></a>
                        <a href="https://wa.me/91${phone}?text=${encodeURIComponent(waMsg)}" target="_blank" class="btn-wa"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </td>
            </tr>`;
        }
    }

    body.innerHTML = rowsFound > 0 ? html : '<tr><td colspan="7" class="text-center py-5 text-muted">No Defaulters Found for this month!</td></tr>';
    // Update global total every time we filter to keep it fresh
    calculateGlobalDues();
}
</script>
<script src="menu.js"></script>
</body>
</html>
