<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance & Payroll - The Lalit International</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .staff-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid var(--gold);
        }
        .staff-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #eee;
        }
        .info-area { flex: 1; }
        .btn-group { display: flex; gap: 8px; margin-top: 10px; }
        .time-tag {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
            display: block;
        }
        .status-present { color: green; font-weight: bold; }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="main-content">
    <div class="royal-card">
        <div class="header">
            <h2 style="color:var(--royal-blue);">DAILY ATTENDANCE LOG</h2>
            <p id="currentDateDisplay" style="font-weight: bold; color: var(--gold);"></p>
        </div>

        <div class="attendance-grid" id="attendanceList">
            <p>Fetching staff list...</p>
        </div>
    </div>
</div>

<script>
const db = firebase.firestore();
const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
document.getElementById('currentDateDisplay').innerText = "Date: " + new Date().toDateString();

async function loadAttendanceSheet() {
    const attendanceList = document.getElementById('attendanceList');
    
    try {
        // 1. Get all staff
        const staffSnap = await db.collection('staff').get();
        // 2. Get today's attendance records
        const attSnap = await db.collection('attendance').where('date', '==', today).get();
        
        let attendanceData = {};
        attSnap.forEach(doc => { attendanceData[doc.data().staffID] = doc.data(); });

        attendanceList.innerHTML = "";
        
        staffSnap.forEach(doc => {
            const staff = doc.data();
            const record = attendanceData[staff.staffID] || null;

            const card = document.createElement('div');
            card.className = 'staff-card';
            
            card.innerHTML = `
                <img src="${staff.photo || 'https://via.placeholder.com/100'}" class="staff-img">
                <div class="info-area">
                    <strong style="font-size:1.1rem;">${staff.name}</strong>
                    <div style="font-size:0.8rem; color:#777;">ID: ${staff.staffID} | ${staff.designation}</div>
                    
                    <span class="time-tag">
                        In: ${record?.arrival || '--:--'} | Out: ${record?.departure || '--:--'}
                    </span>

                    <div class="btn-group">
                        <button class="royal-btn btn-sm" 
                            onclick="markArrival('${staff.staffID}', '${staff.name}')"
                            ${record?.arrival ? 'disabled style="opacity:0.5"' : ''}>
                            ARRIVAL
                        </button>
                        <button class="royal-btn btn-sm btn-danger" 
                            onclick="markDeparture('${staff.staffID}')"
                            ${!record?.arrival || record?.departure ? 'disabled style="opacity:0.5"' : ''}>
                            DEPARTURE
                        </button>
                    </div>
                </div>
            `;
            attendanceList.appendChild(card);
        });
    } catch (error) {
        console.error(error);
        attendanceList.innerHTML = "Error loading data.";
    }
}

async function markArrival(id, name) {
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const docId = `${id}_${today}`;
    
    await db.collection('attendance').doc(docId).set({
        staffID: Number(id),
        name: name,
        date: today,
        arrival: time,
        departure: "",
        month: today.substring(0, 7), // YYYY-MM for payroll
        timestamp: Date.now()
    });
    loadAttendanceSheet();
}

async function markDeparture(id) {
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const docId = `${id}_${today}`;
    
    await db.collection('attendance').doc(docId).update({
        departure: time
    });
    loadAttendanceSheet();
}

loadAttendanceSheet();
</script>
<script src="menu.js"></script>
</body>
</html>
