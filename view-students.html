<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lalit International School - Student Management</title>
    <style>
        :root { --royal-blue: #002366; --gold: #D4AF37; --white: #ffffff; --red: #dc3545; }
        body { background: #fdfbf0; margin: 0; padding: 10px; font-family: 'Segoe UI', sans-serif; color: var(--royal-blue); }
        .container { max-width: 1200px; margin: 0 auto; background: var(--white); padding: 15px; border: 1px solid var(--gold); }
        
        .header { text-align: center; border-bottom: 2px solid var(--gold); margin-bottom: 10px; padding-bottom: 5px; }
        .school-logo-img { width: 60px; height: auto; }
        .school-name { font-family: 'Georgia', serif; font-size: 22px; font-weight: bold; margin: 0; text-transform: uppercase; }
        .page-title { text-align: center; font-weight: bold; font-size: 16px; color: var(--gold); margin-bottom: 15px; text-decoration: underline; }

        .top-bar { display: flex; gap: 5px; margin-bottom: 10px; background: #f1f1f1; padding: 10px; flex-wrap: wrap; align-items: center; }
        input, select, .btn { padding: 6px; border: 1px solid var(--gold); font-size: 12px; }
        .btn-blue { background: var(--royal-blue); color: var(--gold); cursor: pointer; font-weight: bold; }
        .btn-print { color: white; cursor: pointer; font-weight: bold; border: none; padding: 6px 12px; display: flex; align-items: center; gap: 3px; }
        .btn-danger { background: var(--red); color: white; cursor: pointer; font-weight: bold; border: none; }
        
        .stats-bar { font-weight: bold; font-size: 14px; margin-bottom: 10px; color: #333; border-left: 4px solid var(--gold); padding-left: 10px; }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { border: 1px solid #ccc; padding: 3px 5px; text-align: left; }
        th { background: #f2f2f2; color: #333; }
        .st-photo { width: 30px; height: 35px; object-fit: cover; border: 1px solid #ddd; }
        .id-roll { font-size: 9px; color: #555; line-height: 1; }

        .double-col { column-count: 2; column-gap: 20px; column-rule: 1px solid #ddd; }

        @media print {
            @page { margin: 0.3cm; size: portrait; }
            .top-bar, .action-btns, .no-print, .modal { display: none !important; }
            .container { border: none; width: 100%; padding: 0; }
            table { break-inside: avoid; width: 100%; font-family: 'Arial Narrow', sans-serif; font-size: 11px; }
            th, td { border: 1px solid black !important; padding: 2px !important; }
            .gender-col { display: none !important; }
        }

        /* Edit Modal Advanced */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 3000; overflow-y: auto; }
        .modal-content { background: white; padding: 20px; width: 95%; max-width: 750px; border: 4px solid var(--gold); display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px; position: relative; }
        .modal-header { grid-column: span 2; border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; }
        .full-width { grid-column: span 2; }
        label { font-size: 11px; font-weight: bold; color: #666; display: block; }
        .read-only { background: #eee; cursor: not-allowed; }
        
        .photo-edit-box { grid-column: span 2; display: flex; align-items: center; gap: 20px; background: #f9f9f9; padding: 10px; border: 1px dashed var(--gold); }
        .preview-img-edit { width: 80px; height: 100px; object-fit: cover; border: 2px solid var(--gold); }
        
        .modal-footer { grid-column: span 2; display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="logo.png" alt="Logo" class="school-logo-img">
        <div class="school-name">THE LALIT INTERNATIONAL SCHOOL</div>
    </div>
    <div class="page-title no-print">STUDENT RECORD MANAGEMENT SYSTEM</div>

    <div class="top-bar no-print">
        <input type="text" id="masterSearch" style="flex:1" placeholder="Search Student Name/ID...">
        <select id="fClass">
            <option value="">Class</option>
            <option value="Pre-Nursery">Pre-Nursery</option><option value="Nursery">Nursery</option>
            <option value="LKG">LKG</option><option value="UKG">UKG</option>
            <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
        </select>
        <select id="fSection"><option value="">Sec</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
        <select id="fGender"><option value="">Gender</option><option value="Male">Male</option><option value="Female">Female</option></select>
        
        <button class="btn-blue" onclick="applyFilters()">GET LIST</button>
        <button class="btn-print" style="background:#6c757d" onclick="printList(1)">⎙ 1-COL</button>
        <button class="btn-print" style="background:#28a745" onclick="printList(2)">⎙ 2-COL</button>
    </div>

    <div class="stats-bar" id="statsBar">Total Students: 0</div>

    <div id="printWrapper">
        <table>
            <thead>
                <tr>
                    <th style="width:1%">S.N</th>
                    <th style="width:1%">Photo</th>
                    <th style="width:1%">Roll/ID</th>
                    <th>Student Name</th>
                    <th style="width:1%">Cls-Sec</th>
                    <th style="width:1%">H</th>
                    <th class="gender-col">Gender</th>
                    <th class="no-print">Manage</th>
                </tr>
            </thead>
            <tbody id="listBody"></tbody>
        </table>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0">Update Student Profile</h3>
            <button onclick="closeModal()" style="cursor:pointer; border:none; background:none; font-size:20px;">&times;</button>
        </div>
        <input type="hidden" id="editDocId">
        
        <div class="photo-edit-box">
            <img id="editPreview" src="" class="preview-img-edit" alt="Preview">
            <div>
                <label>Change Photo</label>
                <input type="file" id="photoInput" accept="image/*" onchange="handlePhoto(this)">
            </div>
        </div>

        <div><label>Unique ID (Locked)</label><input type="text" id="eID" class="read-only" readonly></div>
        <div><label>Roll Number (Locked)</label><input type="text" id="eRoll" class="read-only" readonly></div>
        
        <div class="full-width"><label>Full Name</label><input type="text" id="eName" style="width:100%"></div>
        
        <div><label>Class</label><input type="text" id="eClass" style="width:100%"></div>
        <div><label>Section</label><select id="eSec" style="width:100%"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>
        
        <div><label>House</label><select id="eHouse" style="width:100%"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>
        <div><label>Gender</label><select id="eGender" style="width:100%"><option value="Male">Male</option><option value="Female">Female</option></select></div>
        
        <div><label>Father's Name</label><input type="text" id="eFather" style="width:100%"></div>
        <div><label>Phone Number</label><input type="text" id="eContact" style="width:100%"></div>
        
        <div class="full-width"><label>Address</label><input type="text" id="eAddr" style="width:100%"></div>

        <div class="modal-footer">
            <button class="btn-blue" style="flex:2; padding:10px;" onclick="saveEdit()">SAVE ALL CHANGES</button>
            <button class="btn-danger" style="flex:1; padding:10px;" onclick="confirmDelete()">DELETE STUDENT</button>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentPhotoBase64 = "";

async function applyFilters() {
    let query = db.collection('students');
    const cls = document.getElementById('fClass').value;
    const sec = document.getElementById('fSection').value;
    const gen = document.getElementById('fGender').value;

    if(cls) query = query.where("class", "==", cls);
    if(sec) query = query.where("section", "==", sec);
    if(gen) query = query.where("gender", "==", gen);

    const snap = await query.get();
    render(snap);
}

function render(snap) {
    const tbody = document.getElementById('listBody');
    tbody.innerHTML = "";
    let count = 0;
    snap.forEach(doc => {
        count++;
        const d = doc.data();
        tbody.innerHTML += `
            <tr>
                <td style="text-align:center">${count}</td>
                <td><img src="${d.photo || 'https://via.placeholder.com/40'}" class="st-photo"></td>
                <td class="id-roll">R:${d.rollNo}<br>ID:${d.uniqueID}</td>
                <td><b>${d.name}</b></td>
                <td>${d.class}-${d.section}</td>
                <td style="text-align:center">${d.house || '-'}</td>
                <td class="gender-col">${d.gender || '-'}</td>
                <td class="no-print action-btns"><button class="btn-blue" style="padding:2px 8px; font-size:10px;" onclick="openEdit('${doc.id}')">EDIT</button></td>
            </tr>`;
    });
    document.getElementById('statsBar').innerText = `Total Students: ${count}`;
}

function handlePhoto(input) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onloadend = function() {
        currentPhotoBase64 = reader.result;
        document.getElementById('editPreview').src = reader.result;
    }
    if (file) reader.readAsDataURL(file);
}

async function openEdit(id) {
    const doc = await db.collection('students').doc(id).get();
    const d = doc.data();
    document.getElementById('editDocId').value = id;
    document.getElementById('eID').value = d.uniqueID || '';
    document.getElementById('eRoll').value = d.rollNo || '';
    document.getElementById('eName').value = d.name || '';
    document.getElementById('eClass').value = d.class || '';
    document.getElementById('eSec').value = d.section || 'A';
    document.getElementById('eHouse').value = d.house || 'A';
    document.getElementById('eGender').value = d.gender || 'Male';
    document.getElementById('eFather').value = d.father || '';
    document.getElementById('eContact').value = d.contact || '';
    document.getElementById('eAddr').value = d.currentAddr || d.address || '';
    
    currentPhotoBase64 = d.photo || "";
    document.getElementById('editPreview').src = d.photo || 'https://via.placeholder.com/80';
    document.getElementById('photoInput').value = ""; 
    
    document.getElementById('editModal').style.display = 'flex';
}

async function saveEdit() {
    const id = document.getElementById('editDocId').value;
    const data = {
        name: document.getElementById('eName').value,
        class: document.getElementById('eClass').value,
        section: document.getElementById('eSec').value,
        house: document.getElementById('eHouse').value,
        gender: document.getElementById('eGender').value,
        father: document.getElementById('eFather').value,
        contact: document.getElementById('eContact').value,
        currentAddr: document.getElementById('eAddr').value,
        photo: currentPhotoBase64
    };
    await db.collection('students').doc(id).update(data);
    alert("Record Updated!");
    closeModal();
    applyFilters();
}

async function confirmDelete() {
    const id = document.getElementById('editDocId').value;
    const name = document.getElementById('eName').value;
    if(confirm(`Kya aap pakka "${name}" ka record delete karna chahte hain? Ye wapas nahi aayega!`)) {
        await db.collection('students').doc(id).delete();
        alert("Student Deleted Successfully!");
        closeModal();
        applyFilters();
    }
}

function printList(cols) {
    const wrapper = document.getElementById('printWrapper');
    if(cols === 2) wrapper.classList.add('double-col');
    else wrapper.classList.remove('double-col');
    window.print();
}

function closeModal() { document.getElementById('editModal').style.display = 'none'; }

document.getElementById('masterSearch').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#listBody tr');
    let visibleCount = 0;
    rows.forEach(row => {
        const show = row.innerText.toLowerCase().includes(term);
        row.style.display = show ? '' : 'none';
        if(show) visibleCount++;
    });
    document.getElementById('statsBar').innerText = `Total Students: ${visibleCount}`;
});

applyFilters();
</script>
</body>
</html>
