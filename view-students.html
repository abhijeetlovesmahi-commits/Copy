<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Website Manager | Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        .manager-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .preview-img { width: 100px; height: 120px; object-fit: cover; display: none; margin: 10px 0; border: 2px solid var(--gold); border-radius: 5px; }
        .pdf-note { font-size: 11px; color: #c0392b; margin-top: 5px; }
    </style>
</head>
<body>

    <main class="main-content">
        <div class="royal-card">
            <header class="header">
                <h1 class="brand-font">Master Website Manager</h1>
                <p style="color:var(--gold)">CBSE Compliance & Live Content Control</p>
            </header>

            <div class="manager-grid">
                
                <div class="form-section">
                    <h3><i class="fas fa-bullhorn"></i> News Ticker & Updates</h3>
                    <textarea id="newsTicker" placeholder="Marquee mein chalne wali news likhein..."></textarea>
                    <button class="royal-btn" style="width:100%" onclick="saveSimpleData('content', 'newsData', 'newsTicker')">Update Ticker</button>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-user-tie"></i> Director's Message</h3>
                    <textarea id="dirMsg" placeholder="Director message..."></textarea>
                    <input type="file" accept="image/*" onchange="compressAndPreview(this, 'dirPrev')">
                    <input type="text" id="dirUrl" placeholder="Ya HD Image URL yahan dalein">
                    <img id="dirPrev" class="preview-img">
                    <button class="royal-btn" style="width:100%" onclick="saveComplexData('messages', 'director', 'dirMsg', 'dirUrl', 'dirPrev')">Update Director</button>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-user-graduate"></i> Principal's Message</h3>
                    <textarea id="priMsg" placeholder="Principal message..."></textarea>
                    <input type="file" accept="image/*" onchange="compressAndPreview(this, 'priPrev')">
                    <input type="text" id="priUrl" placeholder="Ya HD Image URL yahan dalein">
                    <img id="priPrev" class="preview-img">
                    <button class="royal-btn" style="width:100%" onclick="saveComplexData('messages', 'principal', 'priMsg', 'priUrl', 'priPrev')">Update Principal</button>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-images"></i> School Gallery (Latest Events)</h3>
                    <p style="font-size:12px;">Charo box mein Photos ke URL dalein:</p>
                    <input type="text" id="g1" placeholder="Photo URL 1" style="margin-bottom:5px;">
                    <input type="text" id="g2" placeholder="Photo URL 2" style="margin-bottom:5px;">
                    <input type="text" id="g3" placeholder="Photo URL 3" style="margin-bottom:5px;">
                    <input type="text" id="g4" placeholder="Photo URL 4">
                    <button class="royal-btn" style="width:100%; margin-top:10px;" onclick="saveGallery()">Update Gallery</button>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-map-marker-alt"></i> Contact & Google Map</h3>
                    <input type="text" id="schoolPhone" placeholder="Phone Number">
                    <textarea id="schoolAddr" placeholder="Full Address..."></textarea>
                    <input type="text" id="mapEmbed" placeholder="Google Map Iframe Link (src only)">
                    <button class="royal-btn" style="width:100%" onclick="saveContact()">Update Contact & Map</button>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-file-pdf"></i> Vacancies & Mandatory PDF</h3>
                    <textarea id="vacText" placeholder="Current job openings likhein..."></textarea>
                    <input type="text" id="disclosurePdf" placeholder="Public Disclosure PDF Link (URL)">
                    <p class="pdf-note">*PDF file ko Google Drive par upload karke 'Anyone with link' karke link yahan dalein.</p>
                    <button class="royal-btn" style="width:100%" onclick="saveCBSEData()">Update PDF & Vacancy</button>
                </div>

            </div>
        </div>
    </main>

    <script src="firebase-config.js"></script>
    <script src="menu.js"></script>

    <script>
        // --- 1. COMPRESSION LOGIC ---
        function compressAndPreview(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = 400 / img.width;
                    canvas.width = 400;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    preview.src = canvas.toDataURL('image/jpeg', 0.7);
                    preview.style.display = 'block';
                }
            }
            reader.readAsDataURL(file);
        }

        // --- 2. SAVE FUNCTIONS ---
        
        async function saveSimpleData(col, doc, id) {
            const val = document.getElementById(id).value;
            await firebase.firestore().collection(col).doc(doc).set({ text: val, lastUpdated: new Date() }, { merge: true });
            alert("Updated!");
        }

        async function saveComplexData(col, doc, msgId, urlId, prevId) {
            const msg = document.getElementById(msgId).value;
            const url = document.getElementById(urlId).value;
            const previewImg = document.getElementById(prevId).src;
            
            // Fix: URL priority handling
            let finalPhoto = (url && url.trim() !== "") ? url : (previewImg.startsWith('data:image') ? previewImg : "");

            await firebase.firestore().collection(col).doc(doc).set({
                text: msg,
                imageUrl: finalPhoto,
                lastUpdated: new Date()
            }, { merge: true });
            alert("Success!");
        }

        async function saveGallery() {
            const images = [
                document.getElementById('g1').value,
                document.getElementById('g2').value,
                document.getElementById('g3').value,
                document.getElementById('g4').value
            ];
            await firebase.firestore().collection('content').doc('gallery').set({ images: images });
            alert("Gallery Updated!");
        }

        async function saveContact() {
            const phone = document.getElementById('schoolPhone').value;
            const addr = document.getElementById('schoolAddr').value;
            const map = document.getElementById('mapEmbed').value;
            await firebase.firestore().collection('content').doc('contactInfo').set({
                phone: phone,
                address: addr,
                mapUrl: map
            }, { merge: true });
            alert("Contact Updated!");
        }

        async function saveCBSEData() {
            const vac = document.getElementById('vacText').value;
            const pdf = document.getElementById('disclosurePdf').value;
            await firebase.firestore().collection('content').doc('cbse').set({
                vacancy: vac,
                disclosureUrl: pdf
            }, { merge: true });
            alert("CBSE Data Updated!");
        }
    </script>
</body>
</html>
