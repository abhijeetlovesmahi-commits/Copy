<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial Registry | The Lalit Intl.</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body>

<input type="checkbox" id="menu-checkbox">
<label for="menu-checkbox" class="menu-toggle">
    <span></span><span></span><span></span>
</label>

<div class="sidebar" id="sidebar-nav">
    </div>

<div class="main-content">
    <div class="royal-card">
        <div id="brand-header-container"></div>

        <h2><i class="fas fa-users-viewfinder"></i> STUDENT REGISTRY</h2>

        <div class="form-section">
            <div class="input-grid">
                <div style="position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: 12px; top: 15px; color: var(--gold);"></i>
                    <input type="text" id="searchInput" placeholder="Search by Name or ID..." style="padding-left: 35px !important;">
                </div>
                <select id="classFilter" onchange="filterByClass()">
                    <option value="">All Classes</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                    <option value="1">Class 1</option>
                    <option value="2">Class 2</option>
                    <option value="3">Class 3</option>
                    <option value="4">Class 4</option>
                    <option value="5">Class 5</option>
                    <option value="6">Class 6</option>
                    <option value="7">Class 7</option>
                    <option value="8">Class 8</option>
                    <option value="9">Class 9</option>
                    <option value="10">Class 10</option>
                </select>
            </div>
        </div>

        <div id="recentList" class="profile-grid">
            <p style="text-align:center; grid-column:1/-1;">Loading Imperial Records...</p>
        </div>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 id="modalName" style="color: var(--royal-blue); border-bottom: 2px solid var(--gold);">STUDENT PROFILE</h2>
        <div class="modal-body">
            <img id="modalPhoto" src="" class="modal-photo">
            <div class="modal-details" id="modalDetails"></div>
        </div>
        <div class="action-bar">
            <button class="royal-btn" id="modalEditBtn" style="padding: 10px 20px;">EDIT</button>
            <button class="royal-btn" id="modalDeleteBtn" style="background: #c0392b; border-color: #c0392b; color: white; padding: 10px 20px;">DELETE</button>
        </div>
    </div>
</div>

<script>
let allStudents = [];

// 1. Fetch Data
async function loadRegistry() {
    try {
        db.collection('students').orderBy('timestamp', 'desc').onSnapshot(snap => {
            allStudents = [];
            snap.forEach(doc => allStudents.push(doc.data()));
            renderList(allStudents);
        });
    } catch (err) {
        document.getElementById('recentList').innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
    }
}

// 2. Render List (Protecting your original structure)
function renderList(dataArray) {
    const list = document.getElementById('recentList');
    list.innerHTML = "";
    if(dataArray.length === 0) {
        list.innerHTML = '<p style="text-align:center; grid-column:1/-1;">No records found in the registry.</p>';
        return;
    }
    dataArray.forEach(data => {
        const card = document.createElement('div');
        card.className = 'student-card'; // Style.css handles this
        card.onclick = () => showDetails(data);
        card.innerHTML = `
            <img src="${data.photo || 'https://via.placeholder.com/150'}" style="width:100px; height:120px; object-fit:cover; border:2px solid var(--gold); border-radius:5px;">
            <h4 style="margin:10px 0 5px; color:var(--royal-blue);">${data.name}</h4>
            <p style="font-size:0.8rem; margin:0;"><b>ID:</b> ${data.uniqueID}</p>
            <p style="font-size:0.8rem; margin:0;"><b>Class:</b> ${data.class}</p>
        `;
        list.appendChild(card);
    });
}

// 3. Search & Filter Functions
function searchStudents() {
    const val = document.getElementById('searchInput').value.toLowerCase();
    const classVal = document.getElementById('classFilter').value;
    
    const filtered = allStudents.filter(s => {
        const matchesName = s.name.toLowerCase().includes(val) || s.uniqueID.toString().includes(val);
        const matchesClass = classVal === "" || s.class === classVal;
        return matchesName && matchesClass;
    });
    renderList(filtered);
}

document.getElementById('searchInput').addEventListener('input', searchStudents);
function filterByClass() { searchStudents(); }

// 4. Detailed View (Modal)
function showDetails(data) {
    document.getElementById('modalName').innerText = data.name;
    document.getElementById('modalPhoto').src = data.photo || 'https://via.placeholder.com/150';
    
    document.getElementById('modalDetails').innerHTML = `
        <p><b>ID:</b> ${data.uniqueID}</p>
        <p><b>DOB:</b> ${data.dob}</p>
        <p><b>Class:</b> ${data.class} (${data.section})</p>
        <p><b>Father:</b> ${data.father}</p>
        <p><b>Contact:</b> ${data.contact}</p>
        <p><b>Aadhar:</b> ${data.aadhar}</p>
        <p style="grid-column: 1/-1;"><b>Current Address:</b> ${data.currentAddr}</p>
    `;
    
    // Linking Edit (Navigates to admission page with ID)
    document.getElementById('modalEditBtn').onclick = () => {
        window.location.href = `add-student.html?edit=${data.uniqueID}`;
    };
    
    document.getElementById('modalDeleteBtn').onclick = () => deleteRecord(data.uniqueID);
    document.getElementById('detailModal').style.display = 'block';
}

async function deleteRecord(id) {
    if(confirm("Are you sure you want to strike this record from the registry?")) {
        await db.collection('students').doc(id.toString()).delete();
        closeModal();
    }
}

function closeModal() { document.getElementById('detailModal').style.display = 'none'; }

// Load on start
loadRegistry();
</script>

<script src="brand.js"></script>
<script src="menu.js"></script>
</body>
</html>
