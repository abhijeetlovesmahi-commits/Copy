<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registry | TLIS Registry</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        :root { --royal-blue: #002366; --gold: #D4AF37; }
        body { background: #f4f7f6; font-family: 'Montserrat', sans-serif; }

        .search-box {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-bottom: 4px solid var(--gold);
            margin-bottom: 30px;
        }

        /* Student Cards Grid */
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .student-card {
            background: white; border-radius: 12px; padding: 15px;
            text-align: center; transition: 0.3s; cursor: pointer;
            border: 1px solid #eee; position: relative;
        }
        .student-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
            border-color: var(--gold);
        }

        .student-card img {
            width: 100px; height: 110px; object-fit: cover;
            border-radius: 8px; border: 2px solid var(--gold);
            margin-bottom: 10px;
        }

        .student-card h5 { 
            color: var(--royal-blue); font-size: 1rem; font-weight: bold; 
            margin-bottom: 5px; text-transform: uppercase;
        }

        .id-badge {
            background: var(--royal-blue); color: white;
            font-size: 0.7rem; padding: 3px 8px; border-radius: 50px;
        }

        .class-tag {
            display: block; font-size: 0.85rem; color: #666; margin-top: 5px;
        }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="main-content container py-4">
    <div class="royal-card">
        <div id="brand-header-container"></div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="brand-font" style="color: var(--royal-blue);">
                <i class="fas fa-users-viewfinder me-2 text-warning"></i> STUDENT REGISTRY
            </h2>
            <span id="totalCount" class="badge bg-dark px-3 py-2">Total Students: 0</span>
        </div>

        <div class="search-box">
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Search by Name or Unique ID...">
                    </div>
                </div>
                <div class="col-md-4">
                    <select id="classFilter" class="form-select" onchange="filterByClass()">
                        <option value="">All Classes</option>
                        <option value="Pre-Nursery">Pre-Nursery</option>
                        <option value="Nursery">Nursery</option>
                        <option value="LKG">LKG</option>
                        <option value="UKG">UKG</option>
                        <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">Class ${i}</option>`);</script>
                    </select>
                </div>
            </div>
        </div>

        <div id="recentList" class="profile-grid">
            <div class="text-center py-5" style="grid-column: 1/-1;">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2 text-muted">Consulting Imperial Records...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script src="firebase-config.js"></script>
<script src="brand.js"></script>
<script src="menu.js"></script>

<script>
let allStudents = [];

// 1. Security Check & Load
firebase.auth().onAuthStateChanged(async user => {
    if (!user) {
        window.location.href = "login.html";
    } else {
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists && (doc.data().role === 'admin' || doc.data().permissions?.registry)) {
            loadRegistry();
        } else {
            alert("Access Denied to Registry!");
            window.location.href = "index.html";
        }
    }
});

// 2. Fetch Data from Firestore
function loadRegistry() {
    db.collection('students').orderBy('timestamp', 'desc').onSnapshot(snap => {
        allStudents = [];
        snap.forEach(doc => {
            let data = doc.data();
            data.id = doc.id; // Original Firestore ID
            allStudents.push(data);
        });
        document.getElementById('totalCount').innerText = "Total Students: " + allStudents.length;
        renderList(allStudents);
    }, err => {
        console.error("Error:", err);
    });
}

// 3. UI Rendering
function renderList(dataArray) {
    const list = document.getElementById('recentList');
    list.innerHTML = "";
    
    if(dataArray.length === 0) {
        list.innerHTML = '<div class="text-center py-5 w-100" style="grid-column:1/-1;"><i class="fas fa-folder-open fa-3x text-muted mb-3"></i><p>No matching records found.</p></div>';
        return;
    }

    dataArray.forEach(student => {
        const card = document.createElement('div');
        card.className = 'student-card';
        // Profile link with Unique ID
        card.onclick = () => window.location.href = `profile.html?id=${student.uniqueID}`;
        
        card.innerHTML = `
            <span class="id-badge position-absolute top-0 end-0 m-2">#${student.uniqueID}</span>
            <img src="${student.photo || 'https://via.placeholder.com/150'}" alt="Profile">
            <h5>${student.name}</h5>
            <span class="class-tag"><b>Class:</b> ${student.class}</span>
            <div class="mt-2 small text-muted">
                <i class="fas fa-phone-alt me-1"></i> ${student.mobile || 'No Contact'}
            </div>
        `;
        list.appendChild(card);
    });
}

// 4. Filter Logic
function searchStudents() {
    const val = document.getElementById('searchInput').value.toLowerCase();
    const classVal = document.getElementById('classFilter').value;
    
    const filtered = allStudents.filter(s => {
        const matchesName = s.name.toLowerCase().includes(val) || s.uniqueID.toString().includes(val);
        const matchesClass = classVal === "" || s.class === classVal;
        return matchesName && matchesClass;
    });
    renderList(filtered);
}

document.getElementById('searchInput').addEventListener('input', searchStudents);
function filterByClass() { searchStudents(); }
</script>

</body>
</html>
