<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Manager | The Lalit International</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>

    <main class="main-content">
        <div class="royal-card">
            <header class="header">
                <h1 class="brand-font">Website Manager</h1>
                <p style="color:var(--gold)">Bina Storage Bucket wala Advanced System</p>
            </header>

            <div class="input-grid">
                <div class="form-section">
                    <h3>Director's Message</h3>
                    <textarea id="directorMsg" placeholder="Sandesh likhein..."></textarea>
                    <label>Photo Upload (Auto Compress):</label>
                    <input type="file" id="directorFile" accept="image/*" onchange="previewAndCompress(this, 'dirPreview')">
                    <p style="text-align:center; font-size:10px;">-- YA --</p>
                    <input type="text" id="directorUrl" placeholder="Direct HD Photo URL (Optional)">
                    <img id="dirPreview" style="width:100px; display:none; margin:10px auto; border:2px solid var(--gold); border-radius:5px;">
                    <button class="royal-btn" style="width:100%" onclick="saveToFirestore('messages', 'director', 'directorMsg', 'directorUrl', 'dirPreview')">Update Director</button>
                </div>

                <div class="form-section">
                    <h3>Principal's Message</h3>
                    <textarea id="principalMsg" placeholder="Sandesh likhein..."></textarea>
                    <label>Photo Upload (Auto Compress):</label>
                    <input type="file" id="principalFile" accept="image/*" onchange="previewAndCompress(this, 'priPreview')">
                    <p style="text-align:center; font-size:10px;">-- YA --</p>
                    <input type="text" id="principalUrl" placeholder="Direct HD Photo URL (Optional)">
                    <img id="priPreview" style="width:100px; display:none; margin:10px auto; border:2px solid var(--gold); border-radius:5px;">
                    <button class="royal-btn" style="width:100%" onclick="saveToFirestore('messages', 'principal', 'principalMsg', 'principalUrl', 'priPreview')">Update Principal</button>
                </div>
            </div>
        </div>
    </main>

    <script src="firebase-config.js"></script>
    <script src="menu.js"></script>

    <script>
        // --- 1. COMPRESSION LOGIC (Canvas ka use karke) ---
        function previewAndCompress(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Max width 400px rakhte hain taaki quality bhi rahe aur size bhi kam ho
                    const scale = 400 / img.width;
                    canvas.width = 400;
                    canvas.height = img.height * scale;

                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Photo ko Base64 format mein compress karke nikalna (Quality 0.7)
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    preview.src = compressedBase64;
                    preview.style.display = 'block';
                }
            }
            reader.readAsDataURL(file);
        }

        // --- 2. SAVE LOGIC ---
        async function saveToFirestore(col, doc, msgId, urlId, previewId) {
            const msg = document.getElementById(msgId).value;
            const url = document.getElementById(urlId).value;
            const previewImg = document.getElementById(previewId).src;
            const btn = event.target;

            btn.innerText = "Saving...";
            btn.disabled = true;

            // Priority: Pehle HD URL check hoga, agar nahi hai to Compressed Photo
            let finalPhoto = url ? url : (previewImg.startsWith('data:image') ? previewImg : "");

            try {
                await firebase.firestore().collection(col).doc(doc).set({
                    text: msg,
                    imageUrl: finalPhoto,
                    lastUpdated: new Date().getTime()
                }, { merge: true });
                alert("✅ Website Updated Successfully!");
            } catch (error) {
                console.error(error);
                alert("❌ Error: " + error.message);
            } finally {
                btn.innerText = "Update Now";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
