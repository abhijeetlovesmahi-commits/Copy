<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | The Lalit International</title>
    
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="brand.js"></script>
    <script src="menu.js"></script>

    <style>
        :root { --royal: #002366; --gold: #D4AF37; }
        body { background: #f4f7f6; opacity: 0; transition: opacity 0.5s; }
        
        .welcome-banner {
            background: linear-gradient(135deg, var(--royal) 0%, #001a4d 100%);
            color: white; padding: 40px; border-radius: 20px;
            border-bottom: 5px solid var(--gold); margin-bottom: 30px;
        }

        .stat-card {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border-left: 5px solid var(--royal); transition: 0.3s;
            height: 100%;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card i { font-size: 2rem; color: var(--gold); margin-bottom: 15px; }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--royal); }
        .stat-label { font-size: 0.8rem; text-transform: uppercase; color: #777; letter-spacing: 1px; }

        /* Hide specific sections by default */
        .role-section { display: none; }
    </style>
</head>
<body>

<div id="menu-container"></div>

<div class="container py-5">
    <div id="brand-header-container" class="mb-4 text-center"></div>

    <div class="welcome-banner">
        <h2 id="welcomeText">Loading...</h2>
        <p id="roleBadge" class="badge bg-warning text-dark">Verifying Role</p>
    </div>

    <div id="adminView" class="role-section row g-4">
        <div class="col-md-4">
            <div class="stat-card">
                <i class="fas fa-vault"></i>
                <div class="stat-label">Today's Collection</div>
                <div class="stat-val" id="todayCollection">₹0</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <i class="fas fa-user-check"></i>
                <div class="stat-label">New Admissions (Today)</div>
                <div class="stat-val" id="todayAdmissions">0</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <i class="fas fa-users"></i>
                <div class="stat-label">Total Active Students</div>
                <div class="stat-val" id="totalStudents">0</div>
            </div>
        </div>
    </div>

    <div id="teacherView" class="role-section row g-4">
        <div class="col-md-6">
            <div class="stat-card">
                <i class="fas fa-book-open"></i>
                <div class="stat-label">My Class Homework</div>
                <div class="stat-val text-success">Updated</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stat-card">
                <i class="fas fa-user-clock"></i>
                <div class="stat-label">Attendance Status</div>
                <div class="stat-val text-primary">Marked</div>
            </div>
        </div>
    </div>

    <div id="studentView" class="role-section row g-4">
        <div class="col-md-6">
            <div class="stat-card">
                <i class="fas fa-receipt"></i>
                <div class="stat-label">Pending Fees</div>
                <div class="stat-val text-danger" id="myDue">₹0</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stat-card">
                <i class="fas fa-pencil-alt"></i>
                <div class="stat-label">Today's Homework</div>
                <div class="stat-val" style="font-size: 1.2rem;">Check Assignment Section</div>
            </div>
        </div>
    </div>

</div>

<script>
async function loadDashboardData(user, role) {
    document.getElementById('welcomeText').innerText = "Namaste, " + user.email.split('@')[0].toUpperCase();
    document.getElementById('roleBadge').innerText = "Access Level: " + role.toUpperCase();

    // Role-Based Visibility Logic
    if(role === 'admin' || role === 'accountant') {
        document.getElementById('adminView').style.display = 'flex';
        fetchAdminStats();
    } else if (role === 'teacher') {
        document.getElementById('teacherView').style.display = 'flex';
    } else if (role === 'student') {
        document.getElementById('studentView').style.display = 'flex';
        fetchStudentStats(user.email);
    }
}

// Admin stats fetch karne ka logic
async function fetchAdminStats() {
    const today = new Date().toLocaleDateString('en-GB');
    
    // Total Students Count
    const stuSnap = await firebase.firestore().collection('students').get();
    document.getElementById('totalStudents').innerText = stuSnap.size;

    // Today's Collection (Transactions se)
    // Yeh tab kaam karega jab aap 'fee_transactions' mein date save kar rahe honge
    // Abhi ke liye Demo:
    document.getElementById('todayCollection').innerText = "₹45,200"; 
}

// Student stats fetch karne ka logic
async function fetchStudentStats(email) {
    const stuDoc = await firebase.firestore().collection('students').where('loginEmail', '==', email).get();
    if(!stuDoc.empty) {
        const s = stuDoc.docs[0].data();
        // Yahan due calculation ka logic aayega (jo humne defaulter list mein banaya tha)
        document.getElementById('myDue').innerText = "₹" + (s.pendingFee || 0);
    }
}

// Auth listener to trigger dashboard
firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
        let role = "student";
        const staffDoc = await firebase.firestore().collection('staff').where('loginEmail', '==', user.email).get();
        if(!staffDoc.empty) role = staffDoc.docs[0].data().role;
        
        loadDashboardData(user, role);
        document.body.style.opacity = "1";
    }
});
</script>

</body>
</html>
