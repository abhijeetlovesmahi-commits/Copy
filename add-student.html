<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Admission System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-5">

<div class="max-w-4xl mx-auto">
    <div class="bg-white p-8 rounded-lg shadow-md mb-10">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Student Admission Form</h2>
        <form id="admissionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="name" placeholder="Student Name" class="border p-2 rounded" required>
            <input type="text" id="father" placeholder="Father's Name" class="border p-2 rounded" required>
            <input type="text" id="mother" placeholder="Mother's Name" class="border p-2 rounded" required>
            <input type="text" id="mobile" placeholder="Mobile Number" class="border p-2 rounded" required>
            <input type="text" id="adhar" placeholder="Aadhar Number" class="border p-2 rounded" required>
            <input type="text" id="address" placeholder="Address" class="border p-2 rounded md:col-span-2" required>
            
            <select id="class" class="border p-2 rounded" required>
                <option value="">Select Class</option>
                <option value="1">Class 1</option>
                <option value="2">Class 2</option>
            </select>
            
            <select id="section" class="border p-2 rounded" required>
                <option value="">Select Section</option>
                <option value="A">A</option>
                <option value="B">B</option>
            </select>

            <select id="transport" class="border p-2 rounded" required>
                <option value="No">Transport: No</option>
                <option value="Yes">Transport: Yes</option>
            </select>

            <div class="md:col-span-2">
                <label class="block text-sm text-gray-600">Upload Photo</label>
                <input type="file" id="photo" accept="image/*" class="border p-2 w-full" required>
            </div>

            <button type="submit" class="md:col-span-2 bg-blue-600 text-white p-3 rounded hover:bg-blue-700 transition">Register Student</button>
        </form>
    </div>

    <hr class="my-10">

    <div class="mb-6">
        <input type="text" id="searchInput" placeholder="Search by Name, ID, Roll No, or Parents..." 
               class="w-full p-4 rounded-full shadow border-none focus:ring-2 focus:ring-blue-400">
    </div>

    <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, doc, runTransaction, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
        authDomain: "the-lalit-d7472.firebaseapp.com",
        databaseURL: "https://the-lalit-d7472-default-rtdb.firebaseio.com",
        projectId: "the-lalit-d7472",
        storageBucket: "the-lalit-d7472.firebasestorage.app",
        messagingSenderId: "479237084229",
        appId: "1:479237084229:web:f1da384b45c5883b12ff2c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const form = document.getElementById('admissionForm');
    const studentListDiv = document.getElementById('studentList');
    const searchInput = document.getElementById('searchInput');

    // --- 1. Save Data with Auto-IDs ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const photoFile = document.getElementById('photo').files[0];
        
        try {
            // Upload photo
            const storageRef = ref(storage, `students/${Date.now()}_${photoFile.name}`);
            const uploadTask = await uploadBytes(storageRef, photoFile);
            const photoURL = await getDownloadURL(uploadTask.ref);

            // Atomic Transaction for IDs
            await runTransaction(db, async (transaction) => {
                const schoolRef = doc(db, "metadata", "school_stats");
                const classKey = `${document.getElementById('class').value}_${document.getElementById('section').value}`;
                const classRef = doc(db, "class_stats", classKey);

                const schoolSnap = await transaction.get(schoolRef);
                const classSnap = await transaction.get(classRef);

                const totalStudents = (schoolSnap.exists() ? schoolSnap.data().count : 0) + 1;
                const rollNo = (classSnap.exists() ? classSnap.data().count : 0) + 1;

                const studentData = {
                    name: document.getElementById('name').value,
                    father: document.getElementById('father').value,
                    mother: document.getElementById('mother').value,
                    address: document.getElementById('address').value,
                    mobile: document.getElementById('mobile').value,
                    adhar: document.getElementById('adhar').value,
                    class: document.getElementById('class').value,
                    section: document.getElementById('section').value,
                    transport: document.getElementById('transport').value,
                    photoURL: photoURL,
                    uniqueID: `LALIT-${1000 + totalStudents}`,
                    rollNo: rollNo,
                    createdAt: new Date()
                };

                transaction.set(schoolRef, { count: totalStudents }, { merge: true });
                transaction.set(classRef, { count: rollNo }, { merge: true });
                transaction.set(doc(collection(db, "students")), studentData);
            });

            alert("Student Admitted Successfully!");
            form.reset();
            loadStudents();
        } catch (error) {
            console.error(error);
            alert("Error adding student");
        }
    });

    // --- 2. Load & Search Students ---
    async function loadStudents(term = "") {
        const querySnapshot = await getDocs(collection(db, "students"));
        studentListDiv.innerHTML = "";
        
        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            
            // Basic multi-field search logic
            const combinedString = `${data.name} ${data.uniqueID} ${data.rollNo} ${data.father}`.toLowerCase();
            if (term && !combinedString.includes(term.toLowerCase())) return;

            studentListDiv.innerHTML += `
                <div class="bg-white border-t-4 border-blue-600 rounded shadow-lg p-4 relative">
                    <img src="${data.photoURL}" class="w-20 h-20 rounded-full mx-auto mb-2 object-cover border">
                    <h3 class="text-center font-bold text-lg">${data.name}</h3>
                    <p class="text-xs text-center text-gray-500 mb-2">${data.uniqueID}</p>
                    <div class="text-sm space-y-1">
                        <p><strong>Roll:</strong> ${data.rollNo} | <strong>Class:</strong> ${data.class}-${data.section}</p>
                        <p><strong>Father:</strong> ${data.father}</p>
                        <p><strong>Mobile:</strong> ${data.mobile}</p>
                    </div>
                    <div class="mt-4 flex justify-between">
                        <button onclick="window.deleteStudent('${id}')" class="text-red-500 text-xs font-bold uppercase">Delete</button>
                        <button onclick="alert('Student Profile:\\nName: ${data.name}\\nAdhar: ${data.adhar}\\nAddress: ${data.address}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs">View Profile</button>
                    </div>
                </div>
            `;
        });
    }

    // --- 3. Global Functions for Buttons ---
    window.deleteStudent = async (id) => {
        if(confirm("Are you sure?")) {
            await deleteDoc(doc(db, "students", id));
            loadStudents();
        }
    };

    searchInput.addEventListener('input', (e) => loadStudents(e.target.value));
    
    // Initial Load
    loadStudents();
</script>

</body>
</html>
